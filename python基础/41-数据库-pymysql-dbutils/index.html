<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>41-数据库-pymysql-DBUtils  &middot; dahl&#39;s blog</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="" />

<meta name="keywords" content="">


<meta property="og:title" content="41-数据库-pymysql-DBUtils  &middot; dahl&#39;s blog ">
<meta property="og:site_name" content="dahl&#39;s blog"/>
<meta property="og:url" content="https://dachenzi.github.io/python%E5%9F%BA%E7%A1%80/41-%E6%95%B0%E6%8D%AE%E5%BA%93-pymysql-dbutils/" />
<meta property="og:locale" content="en-EN">


<meta property="og:type" content="article" />
<meta property="og:description" content=""/>
<meta property="og:article:published_time" content="0001-01-01T00:00:00Z" />
<meta property="og:article:modified_time" content="0001-01-01T00:00:00Z" />

  
    
  

  

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "41-数据库-pymysql-DBUtils",
    "author": {
      "@type": "Person",
      "name": "daxin.li"
    },
    "datePublished": "0001-01-01",
    "description": "",
    "wordCount":  811 
  }
</script>



<link rel="canonical" href="https://dachenzi.github.io/python%E5%9F%BA%E7%A1%80/41-%E6%95%B0%E6%8D%AE%E5%BA%93-pymysql-dbutils/" />

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://dachenzi.github.io/touch-icon-144-precomposed.png">
<link href="https://dachenzi.github.io/favicon.png" rel="icon">

<meta name="generator" content="Hugo 0.75.1" />

  <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link href='https://fonts.googleapis.com/css?family=Merriweather:300%7CRaleway%7COpen+Sans' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/highlight/default.css">

  
  
	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'Your Google Analytics tracking code', 'auto');
	  ga('send', 'pageview');

	</script>

</head>
<body>
  <main id="main-wrapper" class="container main_wrapper has-sidebar">
    <header id="main-header" class="container main_header">
  <div class="container brand">
  <div class="container title h1-like">
  <a class="baselink" href="https://dachenzi.github.io">
  foobar

</a>

</div>

  
<div class="container topline">
  
  few words about your site


</div>


</div>

  <nav class="container nav primary no-print">
  

<a class="homelink" href="https://dachenzi.github.io">home</a>


  
<a href="https://dachenzi.github.io/about">About</a>

<a href="https://dachenzi.github.io/post" title="Show list of posts">Posts</a>

<a href="https://dachenzi.github.io/tags" title="Show list of tags">Tags</a>


</nav>

<div class="container nav secondary no-print">
  
<a id="contact-link-email" class="contact_link" rel="me" aria-label="Email" href="mailto:dahlhin.li@gmail.com">
  <span class="fa fa-envelope-square"></span></a>



<a id="contact-link-github" class="contact_link" rel="me" aria-label="Github" href="https://github.com/enten/hugo-boilerplate">
  <span class="fa fa-github-square"></span></a>




 


















</div>


  

</header>


<article id="main-content" class="container main_content single">
  <header class="container hat">
  <h1>41-数据库-pymysql-DBUtils
</h1>

</header>

  <div class="container content">
  <p>{% raw %}</p>
<p><!-- raw HTML omitted --><strong>文章目录</strong><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<ul>
<li><a href="#1-python%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93">1 Python操作数据库</a></li>
<li><a href="#2-%E5%AE%89%E8%A3%85%E6%A8%A1%E5%9D%97">2 安装模块</a></li>
<li><a href="#3-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8">3 基本使用</a>
<ul>
<li><a href="#31-%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E8%BF%9E%E6%8E%A5">3.1 创建一个连接</a></li>
<li><a href="#32-%E8%BF%9E%E6%8E%A5%E6%95%B0%E6%8D%AE%E5%BA%93">3.2 连接数据库</a></li>
<li><a href="#33-%E6%B8%B8%E6%A0%87">3.3 游标</a>
<ul>
<li><a href="#331-%E5%88%A9%E7%94%A8%E6%B8%B8%E6%A0%87%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE%E5%BA%93">3.3.1 利用游标操作数据库</a></li>
<li><a href="#332-%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86">3.3.2 事务管理</a></li>
<li><a href="#333-%E6%89%A7%E8%A1%8Csql%E8%AF%AD%E5%8F%A5">3.3.3 执行SQL语句</a>
<ul>
<li><a href="#3331-%E6%89%B9%E9%87%8F%E6%89%A7%E8%A1%8C">3.3.3.1 批量执行</a></li>
<li><a href="#3332-sql%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB">3.3.3.2 SQL注入攻击</a></li>
<li><a href="#3333-%E5%8F%82%E6%95%B0%E5%8C%96%E6%9F%A5%E8%AF%A2">3.3.3.3 参数化查询</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#34-%E8%8E%B7%E5%8F%96%E6%9F%A5%E8%AF%A2%E7%BB%93%E6%9E%9C">3.4 获取查询结果</a>
<ul>
<li><a href="#341-%E5%B8%A6%E5%88%97%E6%98%8E%E7%9A%84%E6%9F%A5%E8%AF%A2">3.4.1 带列明的查询</a></li>
</ul>
</li>
<li><a href="#35-%E4%B8%8A%E4%B8%8B%E6%96%87%E6%94%AF%E6%8C%81">3.5 上下文支持</a></li>
</ul>
</li>
<li><a href="#4-dbutils%E8%BF%9E%E6%8E%A5%E6%B1%A0">4 DBUtils连接池</a></li>
</ul>
<!-- raw HTML omitted -->
<h1 id="1-python操作数据库">1 Python操作数据库</h1>
<p>        Python 提供了程序的DB-API，支持众多数据库的操作。由于目前使用最多的数据库为MySQL，所以我们这里以Python操作MySQL为例子，同时也因为有成熟的API,所以我们不必去关注使用什么数据，因为操作逻辑和方法是相同的。</p>
<h1 id="2-安装模块">2 安装模块</h1>
<p>        Python 程序想要操作数据库，首先需要安装 模块 来进行操作，Python 2 中流行的模块为 MySQLdb，而该模块在Python 3 中将被废弃，而使用PyMySQL，这里以PyMySQL模块为例。下面使用pip命令安装PyMSQL模块</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">pip3 install pymysql
</code></pre></div><p>如果没有pip3命令那么需要确认环境变量是否有添加，安装完毕后测试是否安装完毕。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">lidaxindeMacBook<span style="color:#f92672">-</span>Pro:<span style="color:#f92672">~</span> DahlHin<span style="color:#960050;background-color:#1e0010">$</span> python3
Python <span style="color:#ae81ff">3.6</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span> (v3<span style="color:#f92672">.</span><span style="color:#ae81ff">6.1</span>:<span style="color:#ae81ff">69</span>c0db5050, Mar <span style="color:#ae81ff">21</span> <span style="color:#ae81ff">2017</span>, <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">21</span>:<span style="color:#ae81ff">04</span>)
[GCC <span style="color:#ae81ff">4.2</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1</span> (Apple Inc<span style="color:#f92672">.</span> build <span style="color:#ae81ff">5666</span>) (dot <span style="color:#ae81ff">3</span>)] on darwin
Type <span style="color:#e6db74">&#34;help&#34;</span>, <span style="color:#e6db74">&#34;copyright&#34;</span>, <span style="color:#e6db74">&#34;credits&#34;</span> <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;license&#34;</span> <span style="color:#66d9ef">for</span> more information<span style="color:#f92672">.</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">import</span> pymysql
<span style="color:#f92672">&gt;&gt;&gt;</span>
<span style="color:#75715e"># 如果没有报错，则表示安装成功</span>
</code></pre></div><h1 id="3-基本使用">3 基本使用</h1>
<p>        首先我们需要手动安装一个MySQL数据库，这里不再赘述，参考博文：http://www.cnblogs.com/dachenzi/articles/7159510.html</p>
<p>连接数据库并执行sql语句的一般流程是：</p>
<ol>
<li>建立连接</li>
<li>获取游标(创建)</li>
<li>执行SQL语句</li>
<li>提交事务</li>
<li>释放资源</li>
</ol>
<p>对应到代码上的逻辑为：</p>
<ol>
<li>导入相应的Python模块</li>
<li>使用connect函数连接数据库，并返回一个Connection对象</li>
<li>通过Connection对象的cursor方法，返回一个Cursor对象</li>
<li>通过Cursor对象的execute方法执行SQL语句</li>
<li>如果执行的是查询语句，通过Cursor对象的fetchall语句获取返回结果</li>
<li>调用Cursor对象的close关闭Cursor</li>
<li>调用Connection对象的close方法关闭数据库连接</li>
</ol>
<h2 id="31-创建一个连接">3.1 创建一个连接</h2>
<p>使用<code>pymysql.connect</code>方法来连接数据库</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> pymysql
 
pymysql<span style="color:#f92672">.</span>connect(host<span style="color:#f92672">=</span>None, user<span style="color:#f92672">=</span>None, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&#34;</span>,
                 database<span style="color:#f92672">=</span>None, port<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, unix_socket<span style="color:#f92672">=</span>None,
                 charset<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span><span style="color:#f92672">......</span>)
</code></pre></div><p>主要的参数有:</p>
<ul>
<li>host：表示连接的数据库的地址</li>
<li>user：表示连接使用的用户</li>
<li>password：表示用户对应的密码</li>
<li>database：表示连接哪个库</li>
<li>port：表示数据库的端口</li>
<li>unix_socket：表示使用socket连接时，socket文件的路径</li>
<li>charset：表示连接使用的字符集　</li>
<li>read_default_file：读取mysql的配置文件中的配置进行连接</li>
</ul>
<h2 id="32-连接数据库">3.2 连接数据库</h2>
<p>        调用connect函数，将创建一个数据库连接并得到一个Connection对象，Connection对象定义了很多的方法和异常。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;10.0.0.13&#39;</span>
port <span style="color:#f92672">=</span> <span style="color:#ae81ff">3306</span>
user <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;dahl&#39;</span>
password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;123456&#39;</span>
database <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;test&#39;</span>

conn <span style="color:#f92672">=</span> pymysql<span style="color:#f92672">.</span>connect(host, user, password, database, port)
<span style="color:#66d9ef">print</span>(conn)  <span style="color:#75715e"># &lt;pymysql.connections.Connection object at 0x000001ABD3063550&gt;</span>
conn<span style="color:#f92672">.</span>ping()  <span style="color:#75715e"># 没有返回值，无法连接会提示异常</span>
</code></pre></div><p>这里conn就是一个Connection对象，它具有一下属性和方法：</p>
<ul>
<li><code>begin</code>：开始事务</li>
<li><code>commit</code>：提交事务</li>
<li><code>rollback</code>：回滚事务</li>
<li><code>cursor</code>：返回一个Cursor对象</li>
<li><code>autocommit</code>：设置事务是否自动提交</li>
<li><code>set_character_set</code>：设置字符集编码</li>
<li><code>get_server_info</code>：获取数据库版本信息</li>
<li><code>ping(reconnect=True)</code>: 测试数据库是否活着，reconnect表示断开与服务器连接后是否重连，连接关闭时抛出异常（一般用来测通断）</li>
</ul>
<p>        在实际的编程过程中，一般不会直接调用begin、commit和rollback函数，而是通过<code>上下文管理器实现事务的提交与回滚操作</code>。</p>
<h2 id="33-游标">3.3 游标</h2>
<p>        游标是系统为用户开设的一个数据缓存区，存放SQL语句执行的结果，用户可以用SQL语句逐一从游标中获取记录，并赋值给变量，交由Python进一步处理。<br>
        在数据库中，游标是一个十分重要的概念。游标提供了一种对从表中检索出的数据进行操作的灵活手段，就本质而言，游标实际上是一种能从包括多条数据记录的结果集中每次提取一条记录的机制。游标总是与一条SQL 选择语句相关联因为游标由结果集（可以是零条、一条或由相关的选择语句检索出的多条记录）和结果集中指向特定记录的游标位置组成。当决定对结果集进行处理时，必须声明一个指向该结果集的游标。<br>
        正如前面我们使用Python对文件进行处理，那么游标就像我们打开文件所得到的文件句柄一样，只要文件打开成功，该文件句柄就可代表该文件。对于游标而言，其道理是相同的。</p>
<h3 id="331-利用游标操作数据库">3.3.1 利用游标操作数据库</h3>
<p>在进行数据库的操作之前需要创建一个游标对象，来执行sql语句。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">cursor <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>cursor()
</code></pre></div><p>下面利用游标来执行sql语句：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> pymysql
 
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">connect_mysql</span>():
 
    db_config <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#39;host&#39;</span>:<span style="color:#e6db74">&#39;127.0.0.1&#39;</span>,
        <span style="color:#e6db74">&#39;port&#39;</span>:<span style="color:#ae81ff">3306</span>,
        <span style="color:#e6db74">&#39;user&#39;</span>:<span style="color:#e6db74">&#39;root&#39;</span>,
        <span style="color:#e6db74">&#39;password&#39;</span>:<span style="color:#e6db74">&#39;abc.123&#39;</span>,
        <span style="color:#e6db74">&#39;charset&#39;</span>:<span style="color:#e6db74">&#39;utf8&#39;</span>
    }
 
    <span style="color:#66d9ef">return</span>  pymysql<span style="color:#f92672">.</span>connect(<span style="color:#f92672">**</span>db_config)
 
<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    conn <span style="color:#f92672">=</span> connect_mysql()
    cursor <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>cursor()    <span style="color:#75715e"># 创建游标</span>
    sql <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#34; select user,host from mysql.user &#34;</span>  <span style="color:#75715e"># 要执行的sql语句</span>
    cursor<span style="color:#f92672">.</span>execute(sql)  <span style="color:#75715e"># 交给 游标执行</span>
    result <span style="color:#f92672">=</span> cursor<span style="color:#f92672">.</span>fetchall()  <span style="color:#75715e"># 获取游标执行结果</span>
    <span style="color:#66d9ef">print</span>(result)
</code></pre></div><h3 id="332-事务管理">3.3.2 事务管理</h3>
<p>Connection对象包含如下三个方法用于事务管理：</p>
<ul>
<li>begin：开始事务</li>
<li>commit：提交事务</li>
<li>rollback：回滚事务</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> pymysql

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">connect_mysql</span>():
    db_config <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#39;host&#39;</span>: <span style="color:#e6db74">&#39;10.0.0.13&#39;</span>,
        <span style="color:#e6db74">&#39;port&#39;</span>: <span style="color:#ae81ff">3306</span>,
        <span style="color:#e6db74">&#39;user&#39;</span>: <span style="color:#e6db74">&#39;dahl&#39;</span>,
        <span style="color:#e6db74">&#39;password&#39;</span>: <span style="color:#e6db74">&#39;123456&#39;</span>,
        <span style="color:#e6db74">&#39;charset&#39;</span>: <span style="color:#e6db74">&#39;utf8&#39;</span>
    }

    <span style="color:#66d9ef">return</span> pymysql<span style="color:#f92672">.</span>connect(<span style="color:#f92672">**</span>db_config)


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    conn <span style="color:#f92672">=</span> connect_mysql()
    cursor <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>cursor()  <span style="color:#75715e"># 创建游标</span>

    conn<span style="color:#f92672">.</span>begin()
    sql <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;insert into test.student (id,name,age) VALUES (5,&#39;dahl&#39;,23)&#34;</span>  <span style="color:#75715e"># 要执行的sql语句</span>
    res <span style="color:#f92672">=</span> cursor<span style="color:#f92672">.</span>execute(sql)  <span style="color:#75715e"># 交给 游标执行</span>
    <span style="color:#66d9ef">print</span>(res)
    conn<span style="color:#f92672">.</span>commit()
</code></pre></div><p>这样使用是极其不安全的，因为sql语句有可能执行失败，当失败时，我们应该进行回滚</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    conn <span style="color:#f92672">=</span> None 
    cursor <span style="color:#f92672">=</span> None
    <span style="color:#66d9ef">try</span>:
        conn <span style="color:#f92672">=</span> connect_mysql()
        cursor <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>cursor()  <span style="color:#75715e"># 创建游标</span>
        sql <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;insert into test.student (id,name,age) VALUES (6,&#39;dahl&#39;,23)&#34;</span>  <span style="color:#75715e"># 要执行的sql语句</span>
        cursor<span style="color:#f92672">.</span>execute(sql)  <span style="color:#75715e"># 交给 游标执行</span>
        conn<span style="color:#f92672">.</span>commit()    <span style="color:#75715e"># 提交事务</span>
    <span style="color:#66d9ef">except</span>:
        conn<span style="color:#f92672">.</span>rollback()   <span style="color:#75715e"># 当SQL语句执行失败时，回滚</span>
    <span style="color:#66d9ef">finally</span>:
        <span style="color:#66d9ef">if</span> cursor:   
            cursor<span style="color:#f92672">.</span>close()    <span style="color:#75715e"># 关闭游标</span>
        <span style="color:#66d9ef">if</span> conn:
            conn<span style="color:#f92672">.</span>close()   <span style="color:#75715e"># 关闭连接</span>
</code></pre></div><h3 id="333-执行sql语句">3.3.3 执行SQL语句</h3>
<p>用于执行SQL语句的两个方法为：</p>
<ul>
<li>cursor.execute(sql)：执行一条sql语句</li>
<li>executemany(sql,parser)：执行多条语句</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">sql <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;select * from test.student&#34;</span> 
res <span style="color:#f92672">=</span> cursor<span style="color:#f92672">.</span>execute(sql)  
</code></pre></div><h4 id="3331-批量执行">3.3.3.1 批量执行</h4>
<p>executemany用于批量执行sql语句，</p>
<ul>
<li>sql 为模板，c风格的占位符。</li>
<li>parser：为模板填充的数据（可迭代对象）</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">sql <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;insert into test.student (id,name,age) values (</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">,&#39;daxin&#39;,20)&#34;</span>
cursor<span style="color:#f92672">.</span>executemany(sql,(<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">9</span>,))
</code></pre></div><h4 id="3332-sql注入攻击">3.3.3.2 SQL注入攻击</h4>
<p>我们一般在程序中使用sql，可能会有如下代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">接受用户</span>id<span style="color:#960050;background-color:#1e0010">，然后拼接查询用户信息的</span>SQL语句<span style="color:#960050;background-color:#1e0010">，然后查询数据库。</span>
userid <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span> <span style="color:#f92672">#</span> <span style="color:#960050;background-color:#1e0010">来源于程序</span>
<span style="color:#66d9ef">sql</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;select * from user where user_id = {}&#39;</span>.format(userid)
</code></pre></div><p>userid是可变的，比如通过客户端发来的request请求，直接拼接到查询字符串中。如果客户端传递的userid是 &lsquo;5 or 1=&lsquo;呢</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">sql</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;select * from test.student where id = {}&#39;</span>.format(<span style="color:#e6db74">&#39;5 or 1=1&#39;</span>)
</code></pre></div><p>此时真正在数据库中查询的sql语句就变成了</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> test.student <span style="color:#66d9ef">where</span> id <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span> <span style="color:#66d9ef">or</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</code></pre></div><p>这条语句的where条件的函数含义是：<strong><code>当id等于5，或者1等于1时，列出所有匹配的字段，这样就轻松的查到了标准所有的数据！！！</code></strong></p>
<blockquote>
<p>永远不要相信客户端传来的数据是规范及安全的。</p>
</blockquote>
<h4 id="3333-参数化查询">3.3.3.3 参数化查询</h4>
<p>        cursor.execute(sql)方法还额外提供了一个args参数，用于进行参数化查询，它的类型可以为元组、列表、字典。如果查询字符串使用命名关键字(%(name)s)，那么就必须使用字典进行传参。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">sql</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;select * from test.student where id = %s&#39;</span>
<span style="color:#66d9ef">cursor</span>.<span style="color:#66d9ef">execute</span>(<span style="color:#66d9ef">sql</span>,args<span style="color:#f92672">=</span>(<span style="color:#ae81ff">2</span>,))

<span style="color:#66d9ef">sql</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;select * from test.student where id = %(id)s&#39;</span>
<span style="color:#66d9ef">cursor</span>.<span style="color:#66d9ef">execute</span>(<span style="color:#66d9ef">sql</span>,args<span style="color:#f92672">=</span><span style="color:#960050;background-color:#1e0010">{</span><span style="color:#e6db74">&#39;id&#39;</span>:<span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">}</span>)
</code></pre></div><p>        我们说使用参数化查询，效率会高一点，为什么呢？因为SQL语句缓存。数据库一般会对SQL语句编译和缓存，编译只对SQL语句部分，所以参数中就算有SQL指令也不会被执行。编译过程，需要此法分析、语法分析、生成AST、优化、生成执行计划等过程，比较耗费资源。服务端会先查找是否是同一条语句进行了缓存，如果缓存未失效，则不需要再次编译，从而降低了编译的成本，降低了内存消耗。</p>
<blockquote>
<p>可以认为SQL语句字符串就是一个key，如果使用拼接方案，每次发过去的SQL语句都不一样，都需要编译并缓存。大量查询的时候，首选使用参数化查询，以节省资源。</p>
</blockquote>
<h2 id="34-获取查询结果">3.4 获取查询结果</h2>
<p>Cursor类提供了三种查询结果集的方法：（返回值为元组，多个值为嵌套元组）</p>
<ul>
<li><code>fetchone()</code>：获取一条</li>
<li><code>fetchmany(size=None)</code>：获取多条，当size为None时，返回一个包含一个元素的嵌套元组</li>
<li><code>fetchall()</code>：获取所有</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">sql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;select * from test.student&#39;</span>
cursor<span style="color:#f92672">.</span>execute(sql)
<span style="color:#66d9ef">print</span>(cursor<span style="color:#f92672">.</span>fetchall())
<span style="color:#66d9ef">print</span>(cursor<span style="color:#f92672">.</span>fetchone())  <span style="color:#75715e"># None</span>
<span style="color:#66d9ef">print</span>(cursor<span style="color:#f92672">.</span>fetchmany(<span style="color:#ae81ff">2</span>))  <span style="color:#75715e"># None</span>
</code></pre></div><p>        fetch存在一个指针，fetchone一次，就读取结果集中的一个结果，如果fetchall，那么一次就会读取完所有的结果。可以通过调整这个指针来重复读取</p>
<ul>
<li>cursor.rownumber: 返回当前行号，可以修改，支持 负数</li>
<li>cursor.rowcount: 返回总行数</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">sql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;select * from test.student&#39;</span>
cursor<span style="color:#f92672">.</span>execute(sql)
<span style="color:#66d9ef">print</span>(cursor<span style="color:#f92672">.</span>fetchall())  <span style="color:#75715e"># ((2, &#39;dahl&#39;, 20), (3, &#39;dahl&#39;, 21), (4, &#39;daxin&#39;, 22), (5, &#39;dahl&#39;, 23), (6, &#39;dahl&#39;, 23), (7, &#39;daxin&#39;, 20), (8, &#39;daxin&#39;, 20), (9, &#39;daxin&#39;, 20))</span>
cursor<span style="color:#f92672">.</span>rownumber <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">print</span>(cursor<span style="color:#f92672">.</span>fetchone())  <span style="color:#75715e"># (2, &#39;dahl&#39;, 20)</span>
<span style="color:#66d9ef">print</span>(cursor<span style="color:#f92672">.</span>fetchmany()) <span style="color:#75715e"># ((3, &#39;dahl&#39;, 21),)</span>
</code></pre></div><blockquote>
<p>fetch操作的是结果集，结果集是保存在客户端的，也就是说fetch的时候，查询已经结束了。</p>
</blockquote>
<h3 id="341-带列明的查询">3.4.1 带列明的查询</h3>
<p>        结果中不包含字段名，除非我们记住字段的顺序，不然很麻烦，那么下面来解决这个问题。</p>
<p>观察cursor原码，我们发现，它接受一个参数cursor，有一个参数是：<code>DictCursor</code>，查看源码得知，它是Cursor的Mixin子类。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cursor</span>(self, cursor<span style="color:#f92672">=</span>None):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Create a new cursor to execute queries with.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    :param cursor: The type of cursor to create; one of :py:class:`Cursor`,
</span><span style="color:#e6db74">        :py:class:`SSCursor`, :py:class:`DictCursor`, or :py:class:`SSDictCursor`.
</span><span style="color:#e6db74">        None means use Cursor.
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    <span style="color:#66d9ef">if</span> cursor:
        <span style="color:#66d9ef">return</span> cursor(self)
    <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>cursorclass(self)
</code></pre></div><p>观察DictCursor的原码，得知结果集会返回一个字典，一个字段名:值的结果，所以，只需要传入cursor参数即可</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#f92672">from</span> pymysql <span style="color:#f92672">import</span> cursors  <span style="color:#75715e"># DictCursor存在与cursors模块中</span>
    <span style="color:#f92672">...</span> <span style="color:#f92672">...</span> 
    cursor <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>cursor(cursors<span style="color:#f92672">.</span>DictCursor) 
    sql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;select * from test.student&#39;</span>
    cursor<span style="color:#f92672">.</span>execute(sql)
    <span style="color:#66d9ef">print</span>(cursor<span style="color:#f92672">.</span>fetchone())  <span style="color:#75715e"># {&#39;id&#39;: 2, &#39;name&#39;: &#39;dahl&#39;, &#39;age&#39;: 20}</span>
</code></pre></div><h2 id="35-上下文支持">3.5 上下文支持</h2>
<p>Connection和Cursor类实现了__enter__和__exit__方法，所以它支持上下文管理。</p>
<ul>
<li>Connection：进入时返回一个cursor，退出时如果有异常，则回滚，否则提交</li>
<li>Cursor: 进入时返回cursor本身，退出时，关闭cursor连接</li>
</ul>
<p>所以利用上下文的特性，我们可以这样使用</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> pymysql

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">connect_mysql</span>():
    db_config <span style="color:#f92672">=</span> {
        <span style="color:#e6db74">&#39;host&#39;</span>: <span style="color:#e6db74">&#39;10.0.0.13&#39;</span>,
        <span style="color:#e6db74">&#39;port&#39;</span>: <span style="color:#ae81ff">3306</span>,
        <span style="color:#e6db74">&#39;user&#39;</span>: <span style="color:#e6db74">&#39;dahl&#39;</span>,
        <span style="color:#e6db74">&#39;password&#39;</span>: <span style="color:#e6db74">&#39;123456&#39;</span>,
        <span style="color:#e6db74">&#39;charset&#39;</span>: <span style="color:#e6db74">&#39;utf8&#39;</span>
    }

    <span style="color:#66d9ef">return</span> pymysql<span style="color:#f92672">.</span>connect(<span style="color:#f92672">**</span>db_config)

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
conn <span style="color:#f92672">=</span> connect_mysql()
<span style="color:#66d9ef">with</span> conn <span style="color:#66d9ef">as</span> cursor:
    sql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;select * from student&#39;</span>
    cursor<span style="color:#f92672">.</span>execute(sql)
    <span style="color:#66d9ef">print</span>(cursor<span style="color:#f92672">.</span>fetchmany(<span style="color:#ae81ff">2</span>))

<span style="color:#75715e"># conn的exit只是提交了，并没有关闭curosr</span>
cursor<span style="color:#f92672">.</span>close()
conn<span style="color:#f92672">.</span>close()
</code></pre></div><p>如果要自动关闭cursor,可以进行如下改写</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
conn <span style="color:#f92672">=</span> connect_mysql()
<span style="color:#66d9ef">with</span> conn <span style="color:#66d9ef">as</span> cursor:
    <span style="color:#66d9ef">with</span> cursor   <span style="color:#75715e"># curosr的exit会关闭cursor</span>
        sql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;select * from student&#39;</span>
        cursor<span style="color:#f92672">.</span>execute(sql)
        <span style="color:#66d9ef">print</span>(cursor<span style="color:#f92672">.</span>fetchmany(<span style="color:#ae81ff">2</span>))

conn<span style="color:#f92672">.</span>close()
</code></pre></div><blockquote>
<p>多个 cursor共享一个 conn</p>
</blockquote>
<h1 id="4-dbutils连接池">4 DBUtils连接池</h1>
<p>        在python编程中可以使用MySQLdb/pymysql等模块对数据库的连接及诸如查询/插入/更新等操作，但是每次连接mysql数据库请求时，都是独立的去请求访问，相当浪费资源，而且访问数量达到一定数量时，对mysql的性能会产生较大的影响。因此，实际使用中，通常会使用数据库的连接池技术，来访问数据库达到资源复用的目的。</p>
<p><img src="photo/dbutils.png" alt="db_utils"></p>
<p>连接池对性能的提升表现在：</p>
<ol>
<li>在程序创建连接的时候，可以从一个空闲的连接中获取，不需要重新初始化连接，提升获取连接的速度</li>
<li>关闭连接的时候，把连接放回连接池，而不是真正的关闭，所以可以减少频繁地打开和关闭连接</li>
</ol>
<p>        DBUtils是一套Python数据库连接池包，并允许对非线程安全的数据库接口进行线程安全包装。DBUtils来自Webware for Python。</p>
<p>DBUtils提供两种外部接口：</p>
<ul>
<li>PersistentDB:提供线程专用的数据库连接，并自动管理连接。（为每一个线程创建一个）</li>
<li><code>PooledDB</code>:提供线程间可共享的数据库连接，并自动管理连接。</li>
</ul>
<blockquote>
<p>为每个线程创建一个，资源消耗太大，所以我们常用的是PooledDB.</p>
</blockquote>
<p>PooledDB常用的参数为：</p>
<ul>
<li><code>creator</code>=pymysql: 使用链接数据库的模块</li>
<li><code>maxconnections</code>=6: 连接池允许的最大连接数，0和None表示不限制连接数</li>
<li><code>mincached</code>=2: 初始化时，链接池中至少创建的空闲的链接，0表示不创建,如果空闲连接数小于这个数，pool会创建一个新的连接</li>
<li><code>maxcached</code>=5: 链接池中最多闲置的链接，0和None不限制,如果空闲连接数大于这个数，pool会关闭空闲连接</li>
<li>maxshared=3: 链接池中最多共享的链接数量，0和None表示全部共享。PS: 无用，因为pymysql和MySQLdb等模块的 threadsafety都为1，所有值无论设置为多少，_maxcached永远为0，所以永远是所有链接都共享。</li>
<li><code>blocking</code>=True: 连接池中如果没有可用连接后，是否阻塞等待。True，等待；False，不等待然后报错</li>
<li>maxusage=None: 一个链接最多被重复使用的次数，None表示无限制</li>
<li>setsession=[]: 开始会话前执行的命令列表。如：[&ldquo;set datestyle to &hellip;&rdquo;, &ldquo;set time zone &hellip;&quot;]</li>
<li>ping=0: ping MySQL服务端，检查是否服务可用。
<ul>
<li><code>0</code> = None = never</li>
<li>1 = default = whenever it is requested</li>
<li>2 = when a cursor is created</li>
<li><code>4</code> = when a query is executed</li>
<li>7 = always</li>
</ul>
</li>
<li>host=&lsquo;127.0.0.1&rsquo;,</li>
<li>port=3306,</li>
<li>user=&lsquo;root&rsquo;,</li>
<li>password=&lsquo;123&rsquo;,</li>
<li>database=&lsquo;pooldb&rsquo;,</li>
<li>charset=&lsquo;utf8&rsquo;</li>
</ul>
<p>安装DBUtils</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">pip install DBUtils
</code></pre></div><p>示例代码：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> threading
<span style="color:#f92672">import</span> time
<span style="color:#f92672">from</span> DBUtils.PooledDB <span style="color:#f92672">import</span> PooledDB
<span style="color:#f92672">import</span> pymysql

POOL <span style="color:#f92672">=</span> PooledDB(
    creator<span style="color:#f92672">=</span>pymysql,
    maxconnections<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span>,
    mincached<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,
    maxcached<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>,
    <span style="color:#75715e"># maxshared=3,</span>
    blocking<span style="color:#f92672">=</span>True,
    maxusage<span style="color:#f92672">=</span>None,
    setsession<span style="color:#f92672">=</span>[],
    ping<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
    host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;10.0.0.13&#39;</span>,
    port<span style="color:#f92672">=</span><span style="color:#ae81ff">3306</span>,
    user<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;dahl&#39;</span>,
    password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;123456&#39;</span>,
    database<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;test&#39;</span>,
    charset<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;utf8&#39;</span>
)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">func</span>():
    conn <span style="color:#f92672">=</span> POOL<span style="color:#f92672">.</span>connection()
    cursor <span style="color:#f92672">=</span> conn<span style="color:#f92672">.</span>cursor(pymysql<span style="color:#f92672">.</span>cursors<span style="color:#f92672">.</span>DictCursor)
    time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">2</span>)
    cursor<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#39;select * from employees&#39;</span>)
    res <span style="color:#f92672">=</span> cursor<span style="color:#f92672">.</span>fetchall()
    conn<span style="color:#f92672">.</span>close()
    <span style="color:#66d9ef">print</span>(threading<span style="color:#f92672">.</span>get_ident(), res)


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>):
        threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>func)<span style="color:#f92672">.</span>start()
</code></pre></div><p>{% endraw %}</p>

</div>


  
</article>
      <footer id="main-footer" class="container main_footer">
  

  <div class="container nav foot no-print">
  
<a href="https://dachenzi.github.io/license">license</a>


  <a class="toplink" href="#">back to top</a>

</div>

  <div class="container credits">
  
<div class="container footline">
  
  code with <!-- raw HTML omitted --><!-- raw HTML omitted -->


</div>


  
<div class="container copyright">
  
  (c) 2015 Lee xin.


</div>


</div>

</footer>

    </main>
    
<script type="text/javascript">
  (function() {
    
    
    if (window.location.hostname == "localhost")
      return;
    var dsq = document.createElement('script'); dsq.async = true; dsq.type = 'text/javascript';
    dsq.src = '//your_disqus_shortname.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>



<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



    
  </body>
</html>

