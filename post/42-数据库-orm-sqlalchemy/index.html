<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>42-数据库-orm-SQLAlchemy - daxin.li&#39;s blog</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="daxin.li" />
  <meta name="description" content="title: 42-数据库-orm-SQLAlchemy data: 2020-09-21 17:03:56 tags: {% raw %} 文章目录 1 ORM 2 sqlalchemy 3 基本使用 3.1 创建连接 3.1.1 利用连接池执行sql 3.2 创建基类 3.3 创建实体类 3.3.1" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.75.1" />


<link rel="canonical" href="https://dachenzi.github.io/post/42-%E6%95%B0%E6%8D%AE%E5%BA%93-orm-sqlalchemy/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.b3a8813c06e6d785beba22bf8264e174fa2cb3a396b22f9ba24e2c00c18aaf7f.css" integrity="sha256-s6iBPAbm14W&#43;uiK/gmThdPoss6OWsi&#43;bok4sAMGKr38=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="42-数据库-orm-SQLAlchemy" />
<meta property="og:description" content="title: 42-数据库-orm-SQLAlchemy data: 2020-09-21 17:03:56 tags: {% raw %} 文章目录 1 ORM 2 sqlalchemy 3 基本使用 3.1 创建连接 3.1.1 利用连接池执行sql 3.2 创建基类 3.3 创建实体类 3.3.1" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dachenzi.github.io/post/42-%E6%95%B0%E6%8D%AE%E5%BA%93-orm-sqlalchemy/" />
<meta property="article:published_time" content="2016-08-22T19:11:40+00:00" />
<meta property="article:modified_time" content="2016-08-22T19:11:40+00:00" />
<meta itemprop="name" content="42-数据库-orm-SQLAlchemy">
<meta itemprop="description" content="title: 42-数据库-orm-SQLAlchemy data: 2020-09-21 17:03:56 tags: {% raw %} 文章目录 1 ORM 2 sqlalchemy 3 基本使用 3.1 创建连接 3.1.1 利用连接池执行sql 3.2 创建基类 3.3 创建实体类 3.3.1">
<meta itemprop="datePublished" content="2016-08-22T19:11:40+00:00" />
<meta itemprop="dateModified" content="2016-08-22T19:11:40+00:00" />
<meta itemprop="wordCount" content="10309">



<meta itemprop="keywords" content="Python基础," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="42-数据库-orm-SQLAlchemy"/>
<meta name="twitter:description" content="title: 42-数据库-orm-SQLAlchemy data: 2020-09-21 17:03:56 tags: {% raw %} 文章目录 1 ORM 2 sqlalchemy 3 基本使用 3.1 创建连接 3.1.1 利用连接池执行sql 3.2 创建基类 3.3 创建实体类 3.3.1"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">daxin.li's blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/post/">文章</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/categories/">类别</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://gohugo.io" rel="noopener" target="_blank">
              关于
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      daxin.li's blog
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/post/">文章</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/categories/">类别</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://gohugo.io" rel="noopener" target="_blank">
              关于
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">42-数据库-orm-SQLAlchemy</h1>
      
      <div class="post-meta">
        <time datetime="2016-08-22" class="post-time">
          2016-08-22
        </time>
        <div class="post-category">
            <a href="https://dachenzi.github.io/categories/python%E5%9F%BA%E7%A1%80/"> Python基础 </a>
            
          </div>
        <span class="more-meta"> 约 10309 字 </span>
          <span class="more-meta"> 预计阅读 21 分钟 </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#tags">title: 42-数据库-orm-SQLAlchemy
data: 2020-09-21 17:03:56
tags:</a></li>
  </ul>

  <ul>
    <li><a href="#31-创建连接">3.1 创建连接</a>
      <ul>
        <li><a href="#311-利用连接池执行sql">3.1.1 利用连接池执行sql</a></li>
        <li><a href="#312-利用session来执行sql">3.1.2 利用session来执行sql</a></li>
      </ul>
    </li>
    <li><a href="#32-创建基类">3.2 创建基类</a></li>
    <li><a href="#33-创建实体类">3.3 创建实体类</a>
      <ul>
        <li><a href="#331-常用字段">3.3.1 常用字段</a></li>
      </ul>
    </li>
    <li><a href="#34-实例化">3.4 实例化</a></li>
    <li><a href="#35-创建表">3.5 创建表</a></li>
    <li><a href="#36-创建会话session">3.6 创建会话Session</a></li>
    <li><a href="#37-数据操作">3.7 数据操作</a>
      <ul>
        <li><a href="#371-增加数据">3.7.1 增加数据</a></li>
        <li><a href="#372-简单查询">3.7.2 简单查询</a></li>
        <li><a href="#373-修改数据">3.7.3 修改数据</a></li>
        <li><a href="#374-删除数据不建议">3.7.4 删除数据(不建议)</a></li>
        <li><a href="#375-状态">3.7.5 状态</a></li>
        <li><a href="#376-枚举字段">3.7.6 枚举字段</a></li>
        <li><a href="#377-复杂查询">3.7.7 复杂查询</a></li>
      </ul>
    </li>
  </ul>

  <ul>
    <li><a href="#41-创建关系表">4.1 创建关系表</a></li>
    <li><a href="#42-添加数据">4.2 添加数据</a></li>
    <li><a href="#43-relationship">4.3 relationship</a></li>
    <li><a href="#44-通过relationship添加数据">4.4 通过relationship添加数据</a></li>
  </ul>

  <ul>
    <li><a href="#51-创建多对多关系">5.1 创建多对多关系</a></li>
    <li><a href="#52-通过relationship操作数据">5.2 通过relationship操作数据</a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <hr>
<h2 id="tags">title: 42-数据库-orm-SQLAlchemy
data: 2020-09-21 17:03:56
tags:</h2>
<p>{% raw %}</p>
<p><font size=5 face='微软雅黑'><strong>文章目录</strong></font></p>
<!-- TOC -->
<ul>
<li><a href="#1-orm">1 ORM</a></li>
<li><a href="#2-sqlalchemy">2 sqlalchemy</a></li>
<li><a href="#3-%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8">3 基本使用</a>
<ul>
<li><a href="#31-%E5%88%9B%E5%BB%BA%E8%BF%9E%E6%8E%A5">3.1 创建连接</a>
<ul>
<li><a href="#311-%E5%88%A9%E7%94%A8%E8%BF%9E%E6%8E%A5%E6%B1%A0%E6%89%A7%E8%A1%8Csql">3.1.1 利用连接池执行sql</a></li>
</ul>
</li>
<li><a href="#32-%E5%88%9B%E5%BB%BA%E5%9F%BA%E7%B1%BB">3.2 创建基类</a></li>
<li><a href="#33-%E5%88%9B%E5%BB%BA%E5%AE%9E%E4%BD%93%E7%B1%BB">3.3 创建实体类</a>
<ul>
<li><a href="#331-%E5%B8%B8%E7%94%A8%E5%AD%97%E6%AE%B5">3.3.1 常用字段</a></li>
</ul>
</li>
<li><a href="#34-%E5%AE%9E%E4%BE%8B%E5%8C%96">3.4 实例化</a></li>
<li><a href="#35-%E5%88%9B%E5%BB%BA%E8%A1%A8">3.5 创建表</a></li>
<li><a href="#36-%E5%88%9B%E5%BB%BA%E4%BC%9A%E8%AF%9Dsession">3.6 创建会话Session</a></li>
<li><a href="#37-%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C">3.7 数据操作</a>
<ul>
<li><a href="#371-%E5%A2%9E%E5%8A%A0%E6%95%B0%E6%8D%AE">3.7.1 增加数据</a></li>
<li><a href="#372-%E7%AE%80%E5%8D%95%E6%9F%A5%E8%AF%A2">3.7.2 简单查询</a></li>
<li><a href="#373-%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE">3.7.3 修改数据</a></li>
<li><a href="#374-%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE%E4%B8%8D%E5%BB%BA%E8%AE%AE">3.7.4 删除数据(不建议)</a></li>
<li><a href="#375-%E7%8A%B6%E6%80%81">3.7.5 状态</a></li>
<li><a href="#376-%E6%9E%9A%E4%B8%BE%E5%AD%97%E6%AE%B5">3.7.6 枚举字段</a></li>
<li><a href="#377-%E5%A4%8D%E6%9D%82%E6%9F%A5%E8%AF%A2">3.7.7 复杂查询</a>
<ul>
<li><a href="#3771-where%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2">3.7.7.1 where条件查询</a></li>
<li><a href="#3772-%E6%8E%92%E5%BA%8F">3.7.7.2 排序</a></li>
<li><a href="#3773-%E5%88%86%E9%A1%B5%E5%81%8F%E7%A7%BB%E9%87%8F">3.7.7.3 分页(偏移量)</a></li>
<li><a href="#3774-%E6%B6%88%E8%B4%B9%E6%96%B9%E6%B3%95">3.7.7.4 消费方法</a></li>
<li><a href="#3775-%E5%88%86%E7%BB%84%E5%8F%8A%E8%81%9A%E5%90%88%E6%96%B9%E6%B3%95">3.7.7.5 分组及聚合方法</a></li>
<li><a href="#3776-%E5%85%B3%E8%81%94%E6%9F%A5%E8%AF%A2">3.7.7.6 关联查询</a>
<ul>
<li><a href="#%E9%9A%90%E5%BC%8F%E8%BF%9E%E6%8E%A5">隐式连接</a></li>
<li><a href="#join%E8%BF%9E%E6%8E%A5">join连接</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#4-%E4%B8%80%E5%AF%B9%E5%A4%9A%E5%85%B3%E7%B3%BB">4 一对多关系</a>
<ul>
<li><a href="#41-%E5%88%9B%E5%BB%BA%E5%85%B3%E7%B3%BB%E8%A1%A8">4.1 创建关系表</a></li>
<li><a href="#42-%E6%B7%BB%E5%8A%A0%E6%95%B0%E6%8D%AE">4.2 添加数据</a></li>
<li><a href="#43-relationship">4.3 relationship</a></li>
<li><a href="#44-%E9%80%9A%E8%BF%87relationship%E6%B7%BB%E5%8A%A0%E6%95%B0%E6%8D%AE">4.4 通过relationship添加数据</a></li>
</ul>
</li>
<li><a href="#5-%E5%A4%9A%E5%AF%B9%E5%A4%9A%E5%85%B3%E7%B3%BB">5 多对多关系</a>
<ul>
<li><a href="#51-%E5%88%9B%E5%BB%BA%E5%A4%9A%E5%AF%B9%E5%A4%9A%E5%85%B3%E7%B3%BB">5.1 创建多对多关系</a></li>
<li><a href="#52-%E9%80%9A%E8%BF%87relationship%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE">5.2 通过relationship操作数据</a></li>
</ul>
</li>
<li><a href="#6-%E5%88%AB%E5%90%8D">6 别名</a></li>
</ul>
<!-- /TOC -->
<h1 id="1-orm">1 ORM</h1>
<p>Object-Relational Mapping，把关系数据库的表结构映射到对象上。使用面向对象的方式来操作数据库。</p>
<p><img src="photo/orm.png" alt="orm"></p>
<p>下面是一个关系模型与Python对象之间的映射关系：</p>
<ul>
<li>table   &ndash;&gt;  class    : 表映射为类</li>
<li>row     &ndash;&gt;  object   : 行映射为实例</li>
<li>column  &ndash;&gt;  property : 字段映射为属性</li>
</ul>
<h1 id="2-sqlalchemy">2 sqlalchemy</h1>
<p>SQLAlchemy是一个ORM框架。内部是使用了<code>连接池</code>来管理数据库连接。其本身只是做了关系映射，不能连接数据库，也不能执行sql语句，它在底层需要使用pymysql等模块来连接并执行sql语句，要使用sqlalchemy，那么需要先进行安装：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">pip3</span> <span class="n">install</span> <span class="n">sqlalchemy</span>
</code></pre></td></tr></table>
</div>
</div><p>查看版本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="k">print</span><span class="p">(</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
<span class="mf">1.3</span><span class="o">.</span><span class="mi">1</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="3-基本使用">3 基本使用</h1>
<p>先来总结一下使用sqlalchemy框架操作数据库的一般流程：</p>
<ol>
<li><code>创建引擎</code>(不同类型数据库使用不同的连接方式)</li>
<li><code>创建基类</code>(类对象要继承，因为基类会利用元编程为我们的子类绑定关于表的其他属性信息)</li>
<li><code>创建实体类</code>(用来对应数据库中的表)</li>
<li><code>编写实体类属性</code>(用来对应表中的字段/属性)</li>
<li><code>创建表</code>(如果表不存在,则需要执行语句在数据库中创建出对应的表)</li>
<li><code>实例化</code>(具体的一条record记录)</li>
<li><code>创建会话session</code>(用于执行sql语句的连接)</li>
<li><code>使用会话执行SQL语句</code></li>
<li><code>关闭会话</code></li>
</ol>
<h2 id="31-创建连接">3.1 创建连接</h2>
<p>sqlalchemy 使用引擎管理数据库连接(DATABASE URLS)，连接的一般格式为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">dialect</span><span class="o">+</span><span class="n">driver</span><span class="p">:</span><span class="o">//</span><span class="n">username</span><span class="p">:</span><span class="n">password</span><span class="nd">@host</span><span class="p">:</span><span class="n">port</span><span class="o">/</span><span class="n">database</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>dialect</code>：表示什么数据库(比如,mysql,sqlite,oracle等)</li>
<li><code>driver</code>：用于连接数据库的模块(比如pymysql,mysqldb等)</li>
<li><code>username</code>：连接数据库的用户名</li>
<li><code>password</code>：连接数据库的密码</li>
<li><code>host</code>: 数据库的主机地址</li>
<li><code>port</code>: 数据库的端口</li>
<li><code>database</code>: 要连接的数据库名称</li>
</ul>
<p>pymysql模块是较长用于连接mysql的模块，使用pymysql的连接的语句为：</p>
<ul>
<li><code>mysql+pymysql://dahl:123456@10.0.0.13:3306/test</code></li>
</ul>
<p>创建引擎用于进行数据库的连接：<code>create_engine(urls)</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">sqlalchemy</span>

<span class="n">db_url</span> <span class="o">=</span> <span class="s1">&#39;mysql+pymysql://dahl:123456@10.0.0.13:3306/test&#39;</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="n">db_url</span><span class="p">,</span><span class="n">echo</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>echo：引擎是否打印执行的sql语句，等于True时，表示打印，便于调试</li>
<li>max_overflow=5: 超过连接池大小外最多创建的连接</li>
<li>pool_size=1: 连接池大小</li>
<li>pool_timeout=30: 池中没有线程最多等待的时间(否则会报错)</li>
<li>pool_recycle=-1: 多久之后对线程池中的线程进行一次连接的回收(重置)</li>
</ul>
<blockquote>
<p><code>特别注意</code>：创建引擎并不会马上连接数据库，直到让数据库执行任务是才连接。</p>
</blockquote>
<h3 id="311-利用连接池执行sql">3.1.1 利用连接池执行sql</h3>
<p>sqlalchemy内部是原生支持连接池的，我们可以仅仅利用它的连接池功能。通过engie的<code>raw_connection</code>方法就可以获取到一个连接，然后就可以执行sql语句了(基本上就是Pymysql+DBUtils的实现)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="kn">import</span> <span class="nn">pymysql</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span>
    <span class="s1">&#39;mysql+pymysql://dahl:123456@10.0.0.13:3306/test&#39;</span><span class="p">,</span>
    <span class="n">max_overflow</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">pool_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">pool_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">pool_recycle</span><span class="o">=-</span><span class="mi">1</span>
<span class="p">)</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">raw_connection</span><span class="p">()</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">pymysql</span><span class="o">.</span><span class="n">cursors</span><span class="o">.</span><span class="n">DictCursor</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select * from employees;&#39;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="312-利用session来执行sql">3.1.2 利用session来执行sql</h3>
<p>上面是通过链接池来执行sql的，其实也可以通过session来执行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span>
    <span class="s1">&#39;mysql+pymysql://dahl:123456@10.0.0.13:3306/test&#39;</span><span class="p">,</span>
    <span class="n">max_overflow</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">pool_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">pool_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">pool_recycle</span><span class="o">=-</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">DBsession</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">DBsession</span><span class="p">()</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;select * from employees;&#39;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="32-创建基类">3.2 创建基类</h2>
<p>        使用: <code>sqlalchemy.ext.declarative.declarative_base</code> 来构造声明性类定义的基类。因为sqlalchemy内部大量使用了元编程，为实例化的子类注入映射所需的属性，所以我们定义的映射要继承自它（必须继承）</p>
<blockquote>
<p>一般只需要一个这样的基类</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">Base</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">declarative</span><span class="o">.</span><span class="n">declarative_base</span><span class="p">()</span>
<span class="c1"># 或者</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext</span> <span class="kn">import</span> <span class="n">declarative</span>
<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative</span><span class="o">.</span><span class="n">declarative_base</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="33-创建实体类">3.3 创建实体类</h2>
<p>现数据库存在如下表</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">student</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">id</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="n">AUTO_INCREMENT</span><span class="p">,</span>
  <span class="o">`</span><span class="n">name</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">age</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">DEFAULT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">id</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="n">AUTO_INCREMENT</span><span class="o">=</span><span class="mi">10</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8mb4</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>创建对应的实体类:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext</span> <span class="kn">import</span> <span class="n">declarative</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Integer</span>

<span class="n">db_url</span> <span class="o">=</span> <span class="s1">&#39;mysql+pymysql://dahl:123456@10.0.0.13:3306/test&#39;</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="n">db_url</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative</span><span class="o">.</span><span class="n">declarative_base</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Student</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;student&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;Null&#39;</span><span class="p">)</span>
    <span class="n">age</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;Null&#39;</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>

<span class="c1"># Table(&#39;student&#39;, MetaData(bind=None),   这里没有绑定engine，所以是None</span>
<span class="c1"># Column(&#39;id&#39;, Integer(), table=&lt;student&gt;, primary_key=True, nullable=False), </span>
<span class="c1"># Column(&#39;name&#39;, String(), table=&lt;student&gt;, default=ColumnDefault(&#39;Null&#39;)), </span>
<span class="c1"># Column(&#39;age&#39;, Integer(), table=&lt;student&gt;, default=ColumnDefault(&#39;Null&#39;)), schema=None),</span>
<span class="c1"># Column(&#39;data&#39;,DateTime,default=datetime.datetime.now)  # 这里不能加括号</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>__tablename__: 表明，如果表已存在，则必须指定正确的表名</li>
<li>Column: 用于构建一个列对象，它的参数一般都和数据库中的列属性是对应的，主要有：
<ul>
<li>name: 数据库中表示的此列的名称</li>
<li><code>type</code>：字段类型(比如String、Integer，这里是sqlalchemy包装的类型，对应的是数据库的varchar、int等)，来自TypeEngine的子类</li>
<li><code>autoincrement</code>：是否自增</li>
<li>default：默认值，可以是值，可调用对象或者类，当写入数据该字段没有指定时，调用。当是可调用对象的时候，建议不要加括号</li>
<li>doc：字段说明信息</li>
<li>key: 一个可选的字符串标识符，用于标识表上的此Column对象。</li>
<li>index: 是否启用索引</li>
<li><code>nullable</code>: 是否可以为空</li>
<li>onupdate: 如果在更新语句的SET子句中不存在此列，则将在更新时调用该值</li>
<li><code>primary_key</code>: 主键</li>
<li>server_default:它的值是 FetchedValue实例、字符串、Unicode 或者 text()实例，用作DDL语句中该列的default值</li>
</ul>
</li>
</ul>
<p>注意：Column和String、Integer等都来自于sqlalchemy下的方法，要么直接导入，要么就使用sqlalchemy.String来引用。</p>
<h3 id="331-常用字段">3.3.1 常用字段</h3>
<table>
<thead>
<tr>
<th>类型名</th>
<th>python中类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Integer</td>
<td>int</td>
<td>普通整数，一般是32位</td>
</tr>
<tr>
<td>SmallInteger</td>
<td>int</td>
<td>取值范围小的整数，一般是16位</td>
</tr>
<tr>
<td>BigInteger</td>
<td>int或long</td>
<td>不限制精度的整数</td>
</tr>
<tr>
<td>Float</td>
<td>float</td>
<td>浮点数</td>
</tr>
<tr>
<td>Numeric</td>
<td>decimal.Decimal</td>
<td>普通整数，一般是32位</td>
</tr>
<tr>
<td>String</td>
<td>str</td>
<td>变长字符串</td>
</tr>
<tr>
<td>Text</td>
<td>str</td>
<td>变长字符串，对较长或不限长度的字符串做了优化</td>
</tr>
<tr>
<td>Unicode</td>
<td>unicode</td>
<td>变长Unicode字符串</td>
</tr>
<tr>
<td>UnicodeText</td>
<td>unicode</td>
<td>变长Unicode字符串，对较长或不限长度的字符串做了优化</td>
</tr>
<tr>
<td>Boolean</td>
<td>bool</td>
<td>布尔值</td>
</tr>
<tr>
<td>Date</td>
<td>datetime.date</td>
<td>时间</td>
</tr>
<tr>
<td>Time</td>
<td>datetime.datetime</td>
<td>日期和时间</td>
</tr>
<tr>
<td>LargeBinary</td>
<td>str</td>
<td>二进制文件</td>
</tr>
</tbody>
</table>
<h2 id="34-实例化">3.4 实例化</h2>
<p>通过我们构建的类，来实例化的对象，在将来就是数据库中的一条条记录。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">student</span> <span class="o">=</span> <span class="n">Student</span><span class="p">()</span>
<span class="n">student</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;daxin&#39;</span>
<span class="n">student</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">student</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">20</span>
<span class="k">print</span><span class="p">(</span><span class="n">student</span><span class="p">)</span>   <span class="c1"># &lt;1 daxin 20&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="35-创建表">3.5 创建表</h2>
<p>        我们自己写的类都是继承自Base，每继承一次Base类，在Base类的metadata属性中就会记录当前子类，metadata提供了方法用于删除/创建表。如果数据库中已经存在对应的表，那么将不会继续创建</p>
<ul>
<li>drop_all(bind=None, tables=None, checkfirst=True):删除metadata中记录的所有表</li>
<li>create_all(bind=None, tables=None, checkfirst=True):创建metadata中记录的所有表</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">Base</span> <span class="o">=</span> <span class="n">declarative</span><span class="o">.</span><span class="n">declarative_base</span><span class="p">()</span>  
<span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>  <span class="c1"># 需要通过引擎去执行</span>

<span class="c1"># 下面是engine的echo为true时的输出信息</span>
<span class="c1"># 2019-03-16 16:53:45,922 INFO sqlalchemy.engine.base.Engine </span>
<span class="c1"># CREATE TABLE hello (</span>
<span class="c1"># 	id INTEGER NOT NULL AUTO_INCREMENT, </span>
<span class="c1"># 	name VARCHAR(24), </span>
<span class="c1"># 	age INTEGER, </span>
<span class="c1"># 	PRIMARY KEY (id)</span>
<span class="c1"># )</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1"># 2019-03-16 16:53:45,922 INFO sqlalchemy.engine.base.Engine {}</span>
<span class="c1"># 2019-03-16 16:53:45,926 INFO sqlalchemy.engine.base.Engine COMMIT</span>
<span class="c1"># 2019-03-16 16:53:45,927 INFO sqlalchemy.engine.base.Engine </span>
<span class="c1"># CREATE TABLE world (</span>
<span class="c1"># 	id INTEGER NOT NULL AUTO_INCREMENT, </span>
<span class="c1"># 	name VARCHAR(24), </span>
<span class="c1"># 	age INTEGER, </span>
<span class="c1"># 	PRIMARY KEY (id)</span>
<span class="c1"># )</span>
<span class="c1"># </span>
<span class="c1"># </span>
<span class="c1"># 2019-03-16 16:53:45,927 INFO sqlalchemy.engine.base.Engine {}</span>
<span class="c1"># 2019-03-16 16:53:45,928 INFO sqlalchemy.engine.base.Engine COMMIT</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>生产环境很少这样创建表，都是系统上线的时候由脚本生成。</li>
<li>生产环境很少删除表，宁可废除都不能删除。</li>
</ul>
<p>注意：sqlalchemy 只能创建和删除表，不能修改表结构。只能手动的在数据库中修改然后在代码中添加即可。</p>
<h2 id="36-创建会话session">3.6 创建会话Session</h2>
<p>        在一个会话中操作数据库，绘画建立在连接上，连接被引擎管理，当第一次使用数据库时，从引擎维护的连接池中取出一个连接使用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span> 
<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>  <span class="c1"># 实例化一个session对象</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>session对象线程不安全。所以不同线程应该使用不同的session对象</li>
<li>Session类和engine有一个就行了。</li>
</ul>
<p><code>scoped_session</code>是sqlalchemy提供的线程安全的session，利用的是ThreadLocal实现的。</p>
<h2 id="37-数据操作">3.7 数据操作</h2>
<h3 id="371-增加数据">3.7.1 增加数据</h3>
<table>
<thead>
<tr>
<th>方法</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>add()</td>
<td>增加一个对象</td>
</tr>
<tr>
<td>add_all()</td>
<td>增加多个对象，类型为可迭代</td>
</tr>
</tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext</span> <span class="kn">import</span> <span class="n">declarative</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Integer</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>

<span class="n">db_url</span> <span class="o">=</span> <span class="s1">&#39;mysql+pymysql://dahl:123456@10.0.0.13:3306/test&#39;</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="n">db_url</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative</span><span class="o">.</span><span class="n">declarative_base</span><span class="p">()</span>
<span class="n">DBSession</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">DBSession</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Student</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;student&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">24</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;Null&#39;</span><span class="p">)</span>
    <span class="n">age</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;Null&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;{} {} {}&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age</span>
        <span class="p">)</span>

<span class="n">daxin</span> <span class="o">=</span> <span class="n">Student</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;daxin&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">daxin</span><span class="p">)</span>
<span class="n">dachenzi</span> <span class="o">=</span> <span class="n">Student</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;dachenzi&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span>
<span class="n">xiaobai</span> <span class="o">=</span> <span class="n">Student</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;xiaobai&#39;</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">((</span><span class="n">dachenzi</span><span class="p">,</span><span class="n">xiaobai</span><span class="p">))</span>   <span class="c1"># 新增三条数据</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>需要注意的是下面的情况：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">daxin</span> <span class="o">=</span> <span class="n">Student</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;daxin&#39;</span><span class="p">)</span>
<span class="n">daxin</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">daxin</span><span class="p">)</span>  <span class="c1"># 1</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>   
<span class="n">daxin</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">20</span>  
<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">daxin</span><span class="p">)</span>  <span class="c1"># 2</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="n">daxin</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">([</span><span class="n">daxin</span><span class="p">,</span> <span class="n">daxin</span><span class="p">,</span> <span class="n">daxin</span><span class="p">,</span> <span class="n">daxin</span><span class="p">])</span> <span class="c1"># 3</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  
<span class="c1"># &lt;30 daxin 10&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>结果生成个1条数据，&lt;30 daxin 10&gt;，为什么呢？由于id属于自增列，我们在执行#1时，id是没有固定下来的。</p>
<ol>
<li>执行后，commit，则daxin的id就固定下来了。</li>
<li>执行时，由于id没变，所以并不会新增数据，而是使用update语句更新了age字段</li>
<li>执行时，由于都是daxin的，id，name，age都没有改变，所以只会执行1条语句</li>
</ol>
<blockquote>
<p>当engine的echo等于true时，看到具体的sql语句，一切就很明白了。</p>
</blockquote>
<h3 id="372-简单查询">3.7.2 简单查询</h3>
<p>使用session的query方法进行简单查询,格式为：</p>
<ul>
<li><code>session.query(student)</code>: 等同于select * from student;</li>
<li><code>session.query(student).get(2)</code>: 等同于select * from student where id = 2,这里的get方法只能主键查询</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>        <span class="c1"># SELECT student.id AS student_id, student.name AS student_name, student.age AS student_age FROM student</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">std_list</span><span class="p">))</span>  <span class="c1"># &lt;class &#39;sqlalchemy.orm.query.Query&#39;&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>这里直接打印并不会结果，因为它太懒了，你不迭代它，它就不会真的去数据库查询。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span>
<span class="k">for</span> <span class="n">std</span> <span class="ow">in</span> <span class="n">std_list</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>

<span class="c1"># 通过get来过滤主键，是可以直接执行返回结果的。</span>
<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="373-修改数据">3.7.3 修改数据</h3>
<p>修改的数据的流程分为两步：</p>
<ol>
<li>查找匹配的数据</li>
<li>修改后，提交</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">std</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>  <span class="c1"># &lt;30 daxin 200&gt;</span>
<span class="n">std</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>  <span class="c1"># &lt;30 daxin 1000&gt;</span>

<span class="c1"># 或者</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;daxin&#39;</span><span class="p">})</span>
<span class="n">std</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>大部分ORM是都是这样，必须先查才能改。</p>
</blockquote>
<p>在原有数据的基础上批量修改，比如在所有名称后面添加特定的后缀</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Users</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Users</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">Users</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">Users</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&#34;099&#34;</span><span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>  <span class="c1"># 必须为synchronize_session=False</span>
<span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Users</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Users</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&#34;age&#34;</span><span class="p">:</span> <span class="n">Users</span><span class="o">.</span><span class="n">age</span> <span class="o">+</span> <span class="mi">1</span><span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="s2">&#34;evaluate&#34;</span><span class="p">)</span>  <span class="c1"># 必须synchronize_session=&#34;evaluate&#34;，表示要进行计算</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="374-删除数据不建议">3.7.4 删除数据(不建议)</h3>
<p>使用session.delete来删除数据</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">std</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>   <span class="c1"># 提交删除操作</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>  <span class="c1"># None</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="375-状态">3.7.5 状态</h3>
<p>当我们创建一条数据，或是从数据库中获取一条数据时，数据本身是存在一个状态属性的，用来标识当前数据是否持久化，或者其他状态，在sqlalchemy中，<code>inspect(obj)</code>可以用来窥探数据(obj)的状态</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">daxin</span> <span class="o">=</span> <span class="n">Student</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;daxin&#39;</span><span class="p">)</span>
<span class="n">daxin</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">daxin</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>  <span class="c1"># &lt;sqlalchemy.orm.state.InstanceState object at 0x00000186EEC38EB8&gt;</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>  <span class="c1"># &lt;sqlalchemy.orm.state.InstanceState object at 0x00000186EFDCDA20&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>我们看到，inspect返回的是一个InstanceState对象。这个对象有以下几个属性：</p>
<ul>
<li>session_id：获取数据时的session ID，如果是自建数据未持久化ID为None</li>
<li>_attached: 是否是附加的(数据已经加载(已add)，就差提交的数据库了)</li>
<li>transient：是否是临时数据(临时创建，还没有提交(还没有add))</li>
<li>pending: 是否是待定的数据</li>
<li>persistent: 是否是持久的</li>
<li>deleted: 是否已删除</li>
<li>detached：是否被分离</li>
<li>key：key是多少</li>
</ul>
<blockquote>
<p>InstanceState对象，可以通过sqlalchemy.orm.state导入</p>
</blockquote>
<p>具体的状态信息与含义如下：</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>transient</code></td>
<td>实体类尚未加入到session中，同时并没有保存到数据库中</td>
</tr>
<tr>
<td><code>pending</code></td>
<td>transient的实体被加入到session中，状态切换到pending，但它还没有被flsh到数据库中</td>
</tr>
<tr>
<td><code>persistent</code></td>
<td>session中的实体对象对应着数据库中的真实记录。pending状态在提交成功后可以变成persistent状态，或者查询成功返回的实体也是persistent状态</td>
</tr>
<tr>
<td><code>deleted</code></td>
<td>实体被删除且已经flush但未commit完成。事物提交成功了，实体变成detached，事物失败返回persistent状态</td>
</tr>
<tr>
<td><code>detached</code></td>
<td>删除成功的实体进入这个状态</td>
</tr>
</tbody>
</table>
<p>所以数据的状态变化如下：</p>
<ol>
<li>新建一个实体，状态是transient临时的</li>
<li>add()以后，状态变为pending</li>
<li>commit()以后，状态变为persistent</li>
<li>查询成功返回的实体状态也是persistent状态</li>
<li>delete()并flush()以后，状态变为deleted</li>
<li>commit()以后，变为detached，提交失败，回退到persistent状态</li>
</ol>
<blockquote>
<p>flush()方法，主动把改变应用到数据库中去</p>
</blockquote>
<p>        删除、修改操作，需要对应一个真实存在的数据，也就是说数据的状态是persistent才行。当使用add语句新增信息时，如果这个对象已经添加过数据库了，那么它的状态会变为persistent，如果对persistent的数据进行修改继续提交的话，那么使用的将会是update语句而非insert。这也是前面为啥多次对一个数据进行add，提交了多次只会插入1次的原因。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext</span> <span class="kn">import</span> <span class="n">declarative</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Integer</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>

<span class="n">db_url</span> <span class="o">=</span> <span class="s1">&#39;mysql+pymysql://dahl:123456@10.0.0.13:3306/test&#39;</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="n">db_url</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative</span><span class="o">.</span><span class="n">declarative_base</span><span class="p">()</span>
<span class="n">DBSession</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">DBSession</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Student</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;student&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">24</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;Null&#39;</span><span class="p">)</span>
    <span class="n">age</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;Null&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;{} {} {}&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age</span>
        <span class="p">)</span>

<span class="k">def</span> <span class="nf">getstate</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">InstanceState</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&#34;&#34;&#34;
</span><span class="s2">    session_id={} transient={} _attached={} pending={} persistent={} deleted={} detached={}
</span><span class="s2">    &#34;&#34;&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">session_id</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">transient</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">_attached</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">pending</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">persistent</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">deleted</span><span class="p">,</span>
               <span class="n">state</span><span class="o">.</span><span class="n">detached</span><span class="p">))</span>

<span class="n">daxin</span> <span class="o">=</span> <span class="n">Student</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;daxin&#39;</span><span class="p">)</span>
<span class="n">daxin</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">daxin</span><span class="p">)</span>
<span class="n">getstate</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>  <span class="c1"># session_id=None transient=True _attached=False pending=False persistent=False deleted=False detached=False</span>

<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">daxin</span><span class="p">)</span>
<span class="n">getstate</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>  <span class="c1"># session_id=1 transient=False _attached=True pending=True persistent=False deleted=False detached=False</span>

<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="n">getstate</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>  <span class="c1"># session_id=1 transient=False _attached=True pending=False persistent=True deleted=False detached=False</span>

<span class="n">std</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>
<span class="n">getstate</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>  <span class="c1"># session_id=1 transient=False _attached=True pending=False persistent=True deleted=False detached=False</span>

<span class="n">std</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">31</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">inspect</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>
<span class="n">getstate</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>  <span class="c1"># session_id=1 transient=False _attached=True pending=False persistent=True deleted=False detached=False</span>

<span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<span class="n">getstate</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>  <span class="c1"># session_id=1 transient=False _attached=True pending=False persistent=False deleted=True detached=False</span>

<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="n">getstate</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>  <span class="c1"># session_id=None transient=False _attached=False pending=False persistent=False deleted=False detached=True</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="376-枚举字段">3.7.6 枚举字段</h3>
<p>        在数据库的字段类型中，比如性别字段，我们可能会限制数据来源为M(male),F(Female),这个时候字段类型可以是枚举的，但是在sqlalchemy中，原生的字段类型没有枚举类型，那么就需要借助enum类了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext</span> <span class="kn">import</span> <span class="n">declarative</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Integer</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="kn">import</span> <span class="nn">enum</span>

<span class="n">db_url</span> <span class="o">=</span> <span class="s1">&#39;mysql+pymysql://dahl:123456@10.0.0.13:3306/test&#39;</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="n">db_url</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative</span><span class="o">.</span><span class="n">declarative_base</span><span class="p">()</span>
<span class="n">DBSession</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">DBSession</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">GenderEnum</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">M</span> <span class="o">=</span> <span class="s1">&#39;M&#39;</span>
    <span class="n">F</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span>

<span class="k">class</span> <span class="nc">Student</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;student&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">24</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;Null&#39;</span><span class="p">)</span>
    <span class="n">age</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;Null&#39;</span><span class="p">)</span>
    <span class="n">gender</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">GenderEnum</span><span class="p">),</span><span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;{} {} {}&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age</span>
        <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>用起来很麻烦，所以建议性别使用1或者0来存储，显示的时候做对于转换即可</p>
<h3 id="377-复杂查询">3.7.7 复杂查询</h3>
<h4 id="3771-where条件查询">3.7.7.1 where条件查询</h4>
<p>使用filter方法进行条件过滤查询：</p>
<ul>
<li><code>session.query(student).filter(student.id &gt; 10)</code>：相当于select * from student where student.id &gt; 10</li>
</ul>
<blockquote>
<p>同时还存在一个filter_by，它的不同之处在于括号中的不是表达式，而是参数。比如：filter(user.id == 10) -&gt; filter_by(user.id = 10)</p>
</blockquote>
<p>where条件中的关系：</p>
<ul>
<li><code>AND</code>(与) 对应 <code>and_</code></li>
<li><code>OR</code>(或) 对应 <code>or_</code></li>
<li><code>not</code>(非) 对应 <code>not_</code></li>
<li><code>in</code> 对应字段的 <code>in_</code></li>
<li><code>not in</code> 对应字段的 <code>notin_</code></li>
<li><code>like</code> 对应 字段的like方法</li>
<li><code>not like</code> 对应 字段的notlike方法</li>
</ul>
<p>想要使用与或非，需要先行导入</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext</span> <span class="kn">import</span> <span class="n">declarative</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Integer</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">and_</span><span class="p">,</span> <span class="n">or_</span><span class="p">,</span> <span class="n">not_</span>

<span class="n">db_url</span> <span class="o">=</span> <span class="s1">&#39;mysql+pymysql://dahl:123456@10.0.0.13:3306/test&#39;</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="n">db_url</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative</span><span class="o">.</span><span class="n">declarative_base</span><span class="p">()</span>
<span class="n">DBSession</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">DBSession</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Student</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;student&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">24</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;Null&#39;</span><span class="p">)</span>
    <span class="n">age</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;Null&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;{} {} {}&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">age</span>
        <span class="p">)</span>

<span class="k">def</span> <span class="nf">getresulte</span><span class="p">(</span><span class="n">stds</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">std</span> <span class="ow">in</span> <span class="n">stds</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>条件判断之<code>AND</code>(&amp;,and_)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># and</span>
<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">and_</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">,</span> <span class="n">Student</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">27</span><span class="p">))</span>
<span class="n">getresulte</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>

<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">27</span><span class="p">)</span>   <span class="c1"># filter返回的还是一个结果集，所以还可以继续使用filter进行过滤</span>
<span class="n">getresulte</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>

<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">,</span> <span class="n">Student</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># 多个条件一起写，也是and的关系</span>
<span class="n">getresulte</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>

<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">Student</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;daxin&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;</span> <span class="mi">28</span><span class="p">))</span>
<span class="n">getresulte</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>条件判断之<code>OR</code>(or_，|)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># or</span>
<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">or_</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">27</span><span class="p">,</span> <span class="n">Student</span><span class="o">.</span><span class="n">age</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">))</span>
<span class="n">getresulte</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>

<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">Student</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;</span> <span class="mi">27</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">age</span> <span class="o">&lt;</span> <span class="mi">50</span> <span class="p">))</span>
<span class="n">getresulte</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>条件判断之<code>NOT</code>(not_,~)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># not</span>
<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">not_</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">32</span><span class="p">))</span>
<span class="n">getresulte</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>

<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">32</span><span class="p">))</span>
<span class="n">getresulte</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p><code>like</code>和<code>in</code>及<code>not in</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># like</span>
<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;da%&#39;</span><span class="p">))</span>
<span class="n">getresulte</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>

<span class="c1"># not like</span>
<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">notlike</span><span class="p">(</span><span class="s1">&#39;da%&#39;</span><span class="p">))</span>
<span class="n">getresulte</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>

<span class="c1"># in</span>
<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">50</span><span class="p">]))</span>
<span class="n">getresulte</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>

<span class="c1"># not in</span>
<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">notin_</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">50</span><span class="p">]))</span>
<span class="n">getresulte</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>补充：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">r6</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Users</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&#34;id&lt;:value and name=:name&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">224</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fred&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Users</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  <span class="c1"># 传参的方式查询</span>
<span class="n">r7</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Users</span><span class="p">)</span><span class="o">.</span><span class="n">from_statement</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&#34;SELECT * FROM users where name=:name&#34;</span><span class="p">))</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ed&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  <span class="c1"># 用的不多</span>
</code></pre></td></tr></table>
</div>
</div><p><a href="http://www.cnblogs.com/wupeiqi/articles/8259356.html">更多</a></p>
<h4 id="3772-排序">3.7.7.2 排序</h4>
<ul>
<li>order_by：排序</li>
<li>asc: 升序（默认）</li>
<li>desc: 降序</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># 升序</span>
<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;da%&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">age</span><span class="p">)</span>
<span class="n">getresulte</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>

<span class="c1"># 降序</span>
<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;da%&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
<span class="n">getresulte</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="3773-分页偏移量">3.7.7.3 分页(偏移量)</h4>
<ul>
<li>limit: 显示结果的条目数</li>
<li>offset：偏移量</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># limit</span>
<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;da%&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">age</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">getresulte</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>
<span class="c1"># select * from Student where name like &#39;da%&#39; order_by age desc limit 3 offset 2</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="3774-消费方法">3.7.7.4 消费方法</h4>
<ul>
<li>count(): 获取总条数（仅仅针对结果集，不能all以后再count）</li>
<li>all(): 取所有行（默认）（列表）</li>
<li>first()：取首行</li>
<li>one()：有且只有一行，多行则抛出异常</li>
<li>delete()：对查询出来的数据直接进行删除</li>
<li>scalar(): 第一条记录的第一个元素</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># count</span>
<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">std_list</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>

<span class="c1"># first</span>
<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>first本质上就是limit。</p>
</blockquote>
<h4 id="3775-分组及聚合方法">3.7.7.5 分组及聚合方法</h4>
<p>sqlalchemy同样提供了聚合方法，使用sqlalchemy.func来调用</p>
<ul>
<li>group_by:分组显示</li>
</ul>
<p>func提供的方法有</p>
<ul>
<li>max:求最大值</li>
<li>min:求最小值</li>
<li>avg:求平均值</li>
<li>count:聚合（一般和分组连用）</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># max</span>
<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">age</span><span class="p">))</span>  <span class="c1"># select name,max(age) from Student;</span>
<span class="n">getresulte</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>

<span class="c1"># count</span>
<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Student</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>  <span class="c1"># SELECT name, count(id)  FROM student GROUP BY name </span>
<span class="n">getresulte</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="3776-关联查询">3.7.7.6 关联查询</h4>
<p>sqlalchemy提供ForeignKey用来进行外键关联，它的格式为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="err">表名</span><span class="o">.</span><span class="err">字段名</span><span class="p">,</span><span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;更新规则&#39;</span><span class="p">)</span>

<span class="c1"># 如果填写映射后的class，那么可以直接写：类.字段</span>
<span class="c1"># 如果填写数据库中的表，那么需要使用引号：&#39;数据库表名.字段名&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>更新规则和删除规则，可选项如下：</p>
<ul>
<li><code>CASCADE</code>:级联删除，删除被关联数据时，从表关联的数据全部删除。</li>
<li><code>SET NULL</code>:从父表删除或更新行，会设置子表中的外键列为NULL，但必须保证子表没有指定 NOT NULL，也就是说子表的字段可以为NULL才行。</li>
<li><code>RESTRICT</code>:如果从父表删除主键，如果子表引用了，则拒绝对父表的删除或更新操作。(保护数据)</li>
<li><code>NO ACTION</code>:表中SQL的关键字，在MySQL中与RESTRICT相同。拒绝对父表的删除或更新操作。</li>
</ul>
<p>现有如下关系表</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">departments</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">dept_no</span><span class="o">`</span> <span class="nb">char</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">dept_name</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">dept_no</span><span class="o">`</span><span class="p">),</span>
  <span class="k">UNIQUE</span> <span class="k">KEY</span> <span class="o">`</span><span class="n">dept_name</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">dept_name</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">employees</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">emp_no</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">birth_date</span><span class="o">`</span> <span class="nb">date</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">first_name</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">last_name</span><span class="o">`</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">gender</span><span class="o">`</span> <span class="n">enum</span><span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">,</span><span class="s1">&#39;F&#39;</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">hire_date</span><span class="o">`</span> <span class="nb">date</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">emp_no</span><span class="o">`</span><span class="p">)</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="o">`</span><span class="n">dept_emp</span><span class="o">`</span> <span class="p">(</span>
  <span class="o">`</span><span class="n">emp_no</span><span class="o">`</span> <span class="nb">int</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">dept_no</span><span class="o">`</span> <span class="nb">char</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">from_date</span><span class="o">`</span> <span class="nb">date</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">`</span><span class="n">to_date</span><span class="o">`</span> <span class="nb">date</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">emp_no</span><span class="o">`</span><span class="p">,</span><span class="o">`</span><span class="n">dept_no</span><span class="o">`</span><span class="p">),</span>
  <span class="k">KEY</span> <span class="o">`</span><span class="n">dept_no</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">dept_no</span><span class="o">`</span><span class="p">),</span>
  <span class="k">CONSTRAINT</span> <span class="o">`</span><span class="n">dept_emp_ibfk_1</span><span class="o">`</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">emp_no</span><span class="o">`</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="o">`</span><span class="n">employees</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">emp_no</span><span class="o">`</span><span class="p">)</span> <span class="k">ON</span> <span class="k">DELETE</span> <span class="k">CASCADE</span><span class="p">,</span>
  <span class="k">CONSTRAINT</span> <span class="o">`</span><span class="n">dept_emp_ibfk_2</span><span class="o">`</span> <span class="k">FOREIGN</span> <span class="k">KEY</span> <span class="p">(</span><span class="o">`</span><span class="n">dept_no</span><span class="o">`</span><span class="p">)</span> <span class="k">REFERENCES</span> <span class="o">`</span><span class="n">departments</span><span class="o">`</span> <span class="p">(</span><span class="o">`</span><span class="n">dept_no</span><span class="o">`</span><span class="p">)</span> <span class="k">ON</span> <span class="k">DELETE</span> <span class="k">CASCADE</span>
<span class="p">)</span> <span class="n">ENGINE</span><span class="o">=</span><span class="n">InnoDB</span> <span class="k">DEFAULT</span> <span class="n">CHARSET</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>创建对应的映射实体类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext</span> <span class="kn">import</span> <span class="n">declarative</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">Date</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="kn">import</span> <span class="nn">enum</span>

<span class="n">db_url</span> <span class="o">=</span> <span class="s1">&#39;mysql+pymysql://dahl:123456@10.0.0.13:3306/test&#39;</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="n">db_url</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative</span><span class="o">.</span><span class="n">declarative_base</span><span class="p">()</span>
<span class="n">DBSession</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">DBSession</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Departments</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;departments&#39;</span>
    <span class="n">dept_no</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">dept_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">40</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;{} {} {}&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dept_no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dept_name</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">GenderEnum</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">M</span> <span class="o">=</span> <span class="s1">&#39;M&#39;</span>
    <span class="n">F</span> <span class="o">=</span> <span class="s1">&#39;F&#39;</span>

<span class="k">class</span> <span class="nc">Employees</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;employees&#39;</span>
    <span class="n">emp_no</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">birth_date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Date</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">gender</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">GenderEnum</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">hire_date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Date</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;{} {} {} {} {} {}&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emp_no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">birth_date</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gender</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hire_date</span>
        <span class="p">)</span>

<span class="k">class</span> <span class="nc">Dept_emp</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;dept_emp&#39;</span>
    <span class="n">emp_no</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Employees</span><span class="o">.</span><span class="n">emp_no</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">dept_no</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Departments</span><span class="o">.</span><span class="n">dept_no</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">from_date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Date</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">to_date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Date</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;{} emp_no={} dept_no={}&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emp_no</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dept_no</span>
        <span class="p">)</span>

<span class="k">def</span> <span class="nf">getres</span><span class="p">(</span><span class="n">emps</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">emp</span> <span class="ow">in</span> <span class="n">emps</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">emp</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>查询10010员工所在的部门编号及员工信息</p>
<h5 id="隐式连接">隐式连接</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">emps</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Employees</span><span class="p">,</span> <span class="n">Dept_emp</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">and_</span><span class="p">(</span><span class="n">Employees</span><span class="o">.</span><span class="n">emp_no</span> <span class="o">==</span> <span class="n">Dept_emp</span><span class="o">.</span><span class="n">emp_no</span><span class="p">,</span> <span class="n">Employees</span><span class="o">.</span><span class="n">emp_no</span> <span class="o">==</span> <span class="s1">&#39;10010&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="n">getres</span><span class="p">(</span><span class="n">emps</span><span class="p">)</span>

<span class="n">emps</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Employees</span><span class="p">,</span> <span class="n">Dept_emp</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Employees</span><span class="o">.</span><span class="n">emp_no</span> <span class="o">==</span> <span class="n">Dept_emp</span><span class="o">.</span><span class="n">emp_no</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Employees</span><span class="o">.</span><span class="n">emp_no</span> <span class="o">==</span> <span class="s1">&#39;10010&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="n">getres</span><span class="p">(</span><span class="n">emps</span><span class="p">)</span>


<span class="c1"># 相当于:select * from employees,dept_emp where employees.emp_no = dept_emp.emp_no and employees.emp_no = &#39;10010&#39;;</span>
</code></pre></td></tr></table>
</div>
</div><h5 id="join连接">join连接</h5>
<p>使用join()关键字来进行连表查询，其isouter参数用于指定join的类型，默认情况下使用的是inner join,当isouter=True时，就表示是left join(right join没有实现，需要自己交换前面表的顺序)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># join连接</span>
<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Employees</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Dept_emp</span><span class="p">,</span><span class="n">Employees</span><span class="o">.</span><span class="n">emp_no</span> <span class="o">==</span> <span class="n">Dept_emp</span><span class="o">.</span><span class="n">emp_no</span><span class="p">,</span><span class="n">isouter</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Employees</span><span class="o">.</span><span class="n">emp_no</span> <span class="o">==</span> <span class="s1">&#39;10010&#39;</span><span class="p">)</span>
<span class="n">getres</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>

<span class="n">std_list</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Employees</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Dept_emp</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">((</span><span class="n">Employees</span><span class="o">.</span><span class="n">emp_no</span> <span class="o">==</span> <span class="n">Dept_emp</span><span class="o">.</span><span class="n">emp_no</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Employees</span><span class="o">.</span><span class="n">emp_no</span> <span class="o">==</span> <span class="s1">&#39;10010&#39;</span><span class="p">))</span>
<span class="n">getres</span><span class="p">(</span><span class="n">std_list</span><span class="p">)</span>

<span class="c1"># 如果query中，仅列出一个表明，相当于</span>
<span class="c1"># select employees.* from employees inner join dept_emp on employees.emp_no = dept_emp.emp_no where employees.emp_no = &#39;10010&#39;;</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="4-一对多关系">4 一对多关系</h1>
<p>一对多是一种表与表的关系，在orm中创建和使用方式有一写特点，这里单独描述</p>
<h2 id="41-创建关系表">4.1 创建关系表</h2>
<p>通过ForeignKey来创建一对多关系，需要注意的是它内部需要填写对应的真实的表名和字段（非映射的类对象）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">Deptment</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;deptment&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">dep_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;user&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">dept_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;deptment.id&#39;</span><span class="p">))</span>

<span class="c1"># CREATE TABLE `user` (</span>
<span class="c1">#   `id` int(11) NOT NULL AUTO_INCREMENT,</span>
<span class="c1">#   `name` varchar(32) NOT NULL,</span>
<span class="c1">#   `dept_id` int(11) DEFAULT NULL,</span>
<span class="c1">#   PRIMARY KEY (`id`),</span>
<span class="c1">#   KEY `dept_id` (`dept_id`),</span>
<span class="c1">#   CONSTRAINT `user_ibfk_1` FOREIGN KEY (`dept_id`) REFERENCES `deptment` (`id`)</span>
<span class="c1"># ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span>

<span class="c1"># CREATE TABLE `deptment` (</span>
<span class="c1">#   `id` int(11) NOT NULL AUTO_INCREMENT,</span>
<span class="c1">#   `dep_name` varchar(32) NOT NULL,</span>
<span class="c1">#   PRIMARY KEY (`id`)</span>
<span class="c1"># ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="42-添加数据">4.2 添加数据</h2>
<p>添加部门数据时，只能使用id来插入，当插入的dept_id在deptment表中不存在时，会直接爆出异常</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># 批量添加部门数据</span>
<span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">([</span>
    <span class="n">Deptment</span><span class="p">(</span><span class="n">dep_name</span><span class="o">=</span><span class="s1">&#39;运维部&#39;</span><span class="p">),</span>
    <span class="n">Deptment</span><span class="p">(</span><span class="n">dep_name</span><span class="o">=</span><span class="s1">&#39;开发部&#39;</span><span class="p">),</span>
    <span class="n">Deptment</span><span class="p">(</span><span class="n">dep_name</span><span class="o">=</span><span class="s1">&#39;产品部&#39;</span><span class="p">),</span>
    <span class="n">Deptment</span><span class="p">(</span><span class="n">dep_name</span><span class="o">=</span><span class="s1">&#39;测试部&#39;</span><span class="p">)]</span>
<span class="p">)</span>

<span class="c1"># 添加用户数据</span>
<span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">([</span>
    <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;daxin&#39;</span><span class="p">,</span> <span class="n">dept_id</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;dachenzi&#39;</span><span class="p">,</span> <span class="n">dept_id</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;dahl&#39;</span><span class="p">,</span> <span class="n">dept_id</span><span class="o">=</span><span class="mi">3</span><span class="p">)]</span>
<span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="43-relationship">4.3 relationship</h2>
<p>        在表中使用relationship来创建一个关联的对象，便于查询（和django的一对多隐含的对象相同，但在sqlalchemy中必须通过relationship才可以生成），并不会生成新的字段，仅仅是产生一个关联关系。</p>
<blockquote>
<p>注意relationship对象不能作为条件直接进行表查询：session.query(User.name,User.deptment.dept_name) 这样是不行的。</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">relationship</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="n">backref</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>obj:表示要关联的ORM对象</li>
<li>backref：表示在对方插入一个关键字，用于反向关联relationship所在的表对象的本身。</li>
</ul>
<p>下面是一个例子：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">Deptment</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;deptment&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">dep_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;user&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">dept_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;deptment.id&#39;</span><span class="p">))</span>
 
    <span class="n">deptment</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Deptment</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">)</span>   <span class="c1"># 创建relationship关系</span>

<span class="c1"># 正向查（通过User查deptment）</span>
<span class="n">std</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">std</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">std</span><span class="o">.</span><span class="n">deptment</span><span class="o">.</span><span class="n">dep_name</span><span class="p">)</span>  <span class="c1"># 直接通过deptment对象，读取Deptment表中对于的信息</span>

<span class="c1"># 反向查（通过depement查User）</span>
<span class="n">dep</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Deptment</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Deptment</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">dep</span><span class="o">.</span><span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>   <span class="c1"># 反向查，通过user获取到的数据是一个列表</span>
</code></pre></td></tr></table>
</div>
</div><p>relationship，就是通过在一个映射类中增加一个属性，该属性用于表示连接关系，可以在结果中，访问该属性来访问关联的表信息</p>
<h2 id="44-通过relationship添加数据">4.4 通过relationship添加数据</h2>
<p>存在relationship的映射关系时，我们添加数据时，就可以通过relationship使用对象来添加关联数据了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">dep</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Deptment</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Deptment</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">([</span>
    <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="n">deptment</span><span class="o">=</span><span class="n">dep</span><span class="p">),</span>
    <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="n">deptment</span><span class="o">=</span><span class="n">dep</span><span class="p">)]</span>
<span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>直接创建新的部门对象也是可以的</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;dahlhin&#39;</span><span class="p">,</span><span class="n">deptment</span><span class="o">=</span><span class="n">Deptment</span><span class="p">(</span><span class="n">dep_name</span><span class="o">=</span><span class="s1">&#39;管理员&#39;</span><span class="p">))</span>
<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="5-多对多关系">5 多对多关系</h1>
<p>和django不同sqlalchemy的第三张表需要手动创建。</p>
<h2 id="51-创建多对多关系">5.1 创建多对多关系</h2>
<p>模拟主机与业务线的归属问题。</p>
<ul>
<li>主机可以属于多个业务线</li>
<li>一个业务线可以包含多个主机</li>
</ul>
<p>这是一个典型的多对多关系，需要额外一张关系表来记录。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">Service2host</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;service_to_host&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">s_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;service.id&#39;</span><span class="p">))</span>
    <span class="n">h_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;host.id&#39;</span><span class="p">))</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="c1"># 联合唯一索引</span>
        <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;s_id&#39;</span><span class="p">,</span> <span class="s1">&#39;h_id&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;serivce_to_host&#39;</span><span class="p">),</span>
    <span class="p">)</span>  <span class="c1"># 业务id和主机id不能重复，这里创建唯一索引来约束</span>


<span class="k">class</span> <span class="nc">Service</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;service&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">ser_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Host</span><span class="p">(</span><span class="n">base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;host&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">hostname</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">datetime</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1"># CREATE TABLE `host` (</span>
<span class="c1">#   `id` int(11) NOT NULL AUTO_INCREMENT,</span>
<span class="c1">#   `hostname` varchar(16) NOT NULL,</span>
<span class="c1">#   `datetime` date NOT NULL,</span>
<span class="c1">#   PRIMARY KEY (`id`),</span>
<span class="c1">#   UNIQUE KEY `id` (`id`)</span>
<span class="c1"># ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span>


<span class="c1"># CREATE TABLE `service` (</span>
<span class="c1">#   `id` int(11) NOT NULL AUTO_INCREMENT,</span>
<span class="c1">#   `ser_name` varchar(16) NOT NULL,</span>
<span class="c1">#   PRIMARY KEY (`id`),</span>
<span class="c1">#   UNIQUE KEY `id` (`id`)</span>
<span class="c1"># ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span>


<span class="c1"># CREATE TABLE `service_to_host` (</span>
<span class="c1">#   `id` int(11) NOT NULL AUTO_INCREMENT,</span>
<span class="c1">#   `s_id` int(11) DEFAULT NULL,</span>
<span class="c1">#   `h_id` int(11) DEFAULT NULL,</span>
<span class="c1">#   PRIMARY KEY (`id`),</span>
<span class="c1">#   UNIQUE KEY `id` (`id`),</span>
<span class="c1">#   UNIQUE KEY `serivce_to_host` (`s_id`,`h_id`),</span>
<span class="c1">#   KEY `h_id` (`h_id`),</span>
<span class="c1">#   CONSTRAINT `service_to_host_ibfk_1` FOREIGN KEY (`s_id`) REFERENCES `service` (`id`),</span>
<span class="c1">#   CONSTRAINT `service_to_host_ibfk_2` FOREIGN KEY (`h_id`) REFERENCES `host` (`id`)</span>
<span class="c1"># ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="52-通过relationship操作数据">5.2 通过relationship操作数据</h2>
<p>如果没有relationship关联对象，那么我们将需要分别操作三张表，使用relationship将会大大简化这个过程，那么在Service中创建关系:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">hosts</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="s1">&#39;service_to_host&#39;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s1">&#39;services&#39;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>创建后：</p>
<ul>
<li>在Service中存在一个hosts属性，对应host表</li>
<li>在Host中被动注入一个services属性，对应service表</li>
<li>secondary=&lsquo;service_to_host&rsquo; 表示通过第三张表来关联关系</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># 添加一个业务，并创建几台主机</span>
<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
    <span class="n">Service</span><span class="p">(</span><span class="n">ser_name</span><span class="o">=</span><span class="s1">&#39;运营&#39;</span><span class="p">,</span> <span class="n">hosts</span><span class="o">=</span><span class="p">[</span>
        <span class="n">Host</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="s1">&#39;openstack&#39;</span><span class="p">),</span>
        <span class="n">Host</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="s1">&#39;nginx&#39;</span><span class="p">)</span>
    <span class="p">])</span>
<span class="p">)</span>

<span class="c1"># 添加一个主机，并关联几个业务线</span>
<span class="n">service</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Service</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">or_</span><span class="p">(</span><span class="n">Service</span><span class="o">.</span><span class="n">ser_name</span> <span class="o">==</span> <span class="s1">&#39;运营&#39;</span><span class="p">,</span> <span class="n">Service</span><span class="o">.</span><span class="n">ser_name</span> <span class="o">==</span> <span class="s1">&#39;运维&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
    <span class="n">Host</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="s1">&#39;Tomcat&#39;</span><span class="p">,</span> <span class="n">services</span><span class="o">=</span><span class="n">service</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># 查询一个业务线下都有哪些主机</span>
<span class="n">service</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Service</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Service</span><span class="o">.</span><span class="n">ser_name</span> <span class="o">==</span> <span class="s1">&#39;运营&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="k">for</span> <span class="n">host</span> <span class="ow">in</span> <span class="n">service</span><span class="o">.</span><span class="n">hosts</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">host</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">host</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span>

<span class="c1"># 查询一台主机都归属哪些业务线</span>
<span class="n">host</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Host</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Host</span><span class="o">.</span><span class="n">hostname</span> <span class="o">==</span> <span class="s1">&#39;openstack&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="k">for</span> <span class="n">servcie</span> <span class="ow">in</span> <span class="n">host</span><span class="o">.</span><span class="n">services</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">service</span><span class="o">.</span><span class="n">ser_name</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="6-scoped_session推荐">6 scoped_session(推荐)</h1>
<p>当我们启动多线程来执行数据库操作时，每个线程都会用到session来执行sql语句，一般情况下，我们会在线程内不创建新的session来执行sql语句,下面是一个利用session完成原生sql的执行。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span>
    <span class="s1">&#39;mysql+pymysql://dahl:123456@10.0.0.10:3306/test&#39;</span><span class="p">,</span>
    <span class="n">max_overflow</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">pool_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">pool_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">pool_recycle</span><span class="o">=-</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">DBsession</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">DBsession</span><span class="p">()</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;show tables&#39;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>这里会产生一个问题，每个线程启动时都会创建一个session，用完又会关闭，这样太麻烦了，这里可以使用scoped_session对象来完成，它类似与threading.Local的实现方式。作用是，当线程调用scoped_session对象的功能时，比如各种sql查询，在其内部会为每个线程创建一个新的session对象，让它来使用。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># 1 引入scoped_session</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">scoped_session</span>

<span class="c1"># 2 全局创建session对象</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">scoped_session</span><span class="p">(</span><span class="n">DBsession</span><span class="p">)</span>

<span class="c1"># 3 多进程内直接使用</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">():</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;show tables&#39;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">session</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>   <span class="c1"># 使用完毕需要remove</span>
</code></pre></td></tr></table>
</div>
</div><p>不需要关闭，直接使用scoped_session对象的remove方法即可。</p>
<p>实现过程：</p>
<ol>
<li>scoped_session是一个类</li>
<li>它内部并没有实现所有的Session类的方法</li>
<li>它只是在内部，把传入的session对象的属性，进行反射获取，并绑定在自己身上。</li>
<li>self.registry() 就是为每个线程创建的Session对象，其内部使用的就是threading.local实现的。</li>
</ol>
<p>源码如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># scoping</span>
<span class="k">def</span> <span class="nf">instrument</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">do</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">(),</span> <span class="n">name</span><span class="p">)(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">do</span>

<span class="k">for</span> <span class="n">meth</span> <span class="ow">in</span> <span class="n">Session</span><span class="o">.</span><span class="n">public_methods</span><span class="p">:</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">scoped_session</span><span class="p">,</span> <span class="n">meth</span><span class="p">,</span> <span class="n">instrument</span><span class="p">(</span><span class="n">meth</span><span class="p">))</span>

<span class="c1"># registry是ThreadLocalRegistry对象</span>
<span class="bp">self</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">ThreadLocalRegistry</span><span class="p">(</span><span class="n">session_factory</span><span class="p">)</span>


<span class="c1"># ThreadLocalRegistry对象内部通过threading.local实现的</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">createfunc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">createfunc</span> <span class="o">=</span> <span class="n">createfunc</span>  <span class="c1"># Session对象</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>

    
    <span class="c1"># registry()其实调用的就是__call__方法</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">value</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">createfunc</span><span class="p">()</span>   <span class="c1"># 第一次执行，就会实例化一个Session对象</span>
            <span class="k">return</span> <span class="n">val</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="7-别名">7 别名</h1>
<p>当使用join语句连表查询时，难免会碰到两个表重名的字段，这里就可以使用<code>label</code>来对字段进行别名显示。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">stds</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">),</span> <span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">Deptment</span><span class="o">.</span><span class="n">dep_name</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Deptment</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="k">for</span> <span class="n">std</span> <span class="ow">in</span> <span class="n">stds</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">std</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">std</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">std</span><span class="o">.</span><span class="n">dep_name</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">daxin.li</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2016-08-22
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content">原创文章，如需转载请注明文章作者和出处。谢谢！</span>
  </p>
</div>


    
    
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/static/wechat-qr-code.png">
        <span>微信打赏</span>
      </label>
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/static/alipay-qr-code.png">
        <span>支付宝打赏</span>
      </label>
  </div>
</div>

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://dachenzi.github.io/tags/python%E5%9F%BA%E7%A1%80/">Python基础</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/2-flask-%E8%93%9D%E5%9B%BE-%E9%97%AA%E7%8E%B0-%E4%B8%AD%E9%97%B4%E4%BB%B6-session/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">2-flask-蓝图-闪现-中间件-session</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/23-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E5%9F%BA%E7%A1%80-%E5%B0%81%E8%A3%85-%E5%B1%9E%E6%80%A7-%E6%96%B9%E6%B3%95-%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6/">
            <span class="next-text nav-default">23-面向对象基础-封装-属性-方法-访问控制</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  
  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "dachenzi/dachenzi.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:dahlhin.li@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/dachenzi" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://weibo.com/2401416804/profile?rightmod=1&amp;wvr=6&amp;mod=personinfo" rel="me noopener" class="iconfont"
      title="weibo"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M385.714286 733.714286q12-19.428571 6.285714-39.428571t-25.714286-28.571429q-19.428571-8-41.714286-0.571429t-34.285714 26.285714q-12.571429 19.428571-7.428571 39.142857t24.571429 28.857143 42.571429 1.428571 35.714286-27.142857zm53.714286-69.142857q4.571429-7.428571 2-15.142857t-10-10.571429q-8-2.857143-16.285714 2.857143t-12.285714 10.571429q-9.714286 17.714286 7.428571 25.714286 8 2.857143 16.571429 2.857143t12.571429-10.571429zm99.428571 61.142857q-25.714286 58.285714-90.285714 85.714286t-128 6.857143q-61.142857-19.428571-84.285714-72.285714t3.714286-107.142857q26.857143-53.142857 86.571429-79.428571t120.285714-10.857143q63.428571 16.571429 90.571429 68.285714t1.428571 108.857143zm178.285714-91.428571q-5.142857-54.857143-50.857143-97.142857t-119.142857-62.285714-156.857143-12q-127.428571 13.142857-211.142857 80.857143t-75.714286 151.142857q5.142857 54.857143 50.857143 97.142857t119.142857 62.285714 156.857143 12q127.428571-13.142857 211.142857-80.857143t75.714286-151.142857zm176 2.285714q0 38.857143-21.142857 79.714286t-62.285714 78.285714-96.285714 67.142857-129.142857 47.428571-154.571429 17.714286-157.142857-19.142857-137.428571-53.142857-98-86.285714-37.142857-114q0-65.714286 39.714286-140t112.857143-147.428571q96.571429-96.571429 195.142857-134.857143t140.857143 4q37.142857 36.571429 11.428571 119.428571-2.285714 8-0.571429 11.428571t5.714286 4 8.285714 2.857143 7.714286-2l3.428571-1.142857q79.428571-33.714286 140.571429-33.714286t87.428571 34.857143q25.714286 36 0 101.714286-1.142857 7.428571-2.571429 11.428571t2.571429 7.142857 6.857143 4.285714 9.714286 3.428571q32.571429 10.285714 58.857143 26.857143t45.714286 46.571429 19.428571 66.571429zm-42.285714-356.571429q24 26.857143 31.142857 62t-3.714286 67.142857q-4.571429 13.142857-16.857143 19.428571t-25.428571 2.285714q-13.142857-4.571429-19.428571-16.857143t-2.285714-25.428571q11.428571-36-13.714286-63.428571t-61.142857-20q-13.714286 2.857143-25.714286-4.571429t-14.285714-21.142857q-2.857143-13.714286 4.571429-25.428571t21.142857-14.571429q34.285714-7.428571 68 3.142857t57.714286 37.428571zm103.428571-93.142857q49.714286 54.857143 64.285714 127.142857t-7.714286 138q-5.142857 15.428571-19.428571 22.857143t-29.714286 2.285714-22.857143-19.428571-2.857143-29.714286q16-46.857143 5.714286-98.285714t-45.714286-90.285714q-35.428571-39.428571-84.571429-54.571429t-98.857143-4.857143q-16 3.428571-29.714286-5.428571t-17.142857-24.857143 5.428571-29.428571 24.857143-16.857143q70.285714-14.857143 139.428571 6.571429t118.857143 76.857143z"></path>
</svg>

    </a>
  
    <a href="https://www.zhihu.com/people/da-chen-zi-67" rel="me noopener" class="iconfont"
      title="zhihu"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M351.791182 562.469462l192.945407 0c0-45.367257-21.3871-71.939449-21.3871-71.939449L355.897709 490.530013c3.977591-82.182744 7.541767-187.659007 8.816806-226.835262l159.282726 0c0 0-0.86367-67.402109-18.578124-67.402109s-279.979646 0-279.979646 0 16.850783-88.141456 39.318494-127.053698c0 0-83.60514-4.510734-112.121614 106.962104S81.344656 355.077018 76.80834 367.390461c-4.536316 12.313443 24.62791 5.832845 36.941354 0 12.313443-5.832845 68.050885-25.924439 84.252893-103.69571l86.570681 0c1.165546 49.28652 4.596691 200.335724 3.515057 226.835262L109.86113 490.530013c-25.275663 18.147312-33.701566 71.939449-33.701566 71.939449L279.868105 562.469462c-8.497535 56.255235-23.417339 128.763642-44.275389 167.210279-33.05279 60.921511-50.55235 116.65793-169.802314 212.576513 0 0-19.442818 14.257725 40.829917 9.073656 60.273758-5.185093 117.305683-20.739347 156.840094-99.807147 20.553105-41.107233 41.805128-93.250824 58.386782-146.138358l-0.055259 0.185218 167.855986 193.263655c0 0 22.035876-51.847855 5.832845-108.880803L371.045711 650.610918l-42.1244 31.157627-0.045025 0.151449c11.69946-41.020252 20.11206-81.5749 22.726607-116.858498C351.665315 564.212152 351.72876 563.345412 351.791182 562.469462z"></path>
  <path d="M584.918753 182.033893l0 668.840094 70.318532 0 28.807093 80.512708 121.875768-80.512708 153.600307 0L959.520453 182.033893 584.918753 182.033893zM887.150192 778.934538l-79.837326 0-99.578949 65.782216-23.537066-65.782216-24.855084 0L659.341766 256.673847l227.807403 0L887.149169 778.934538z"></path>
</svg>

    </a>


<a href="https://dachenzi.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2016 -
    2020
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        daxin.li
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>



  <script type="text/javascript">
    window.MathJax = {
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script>









  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
