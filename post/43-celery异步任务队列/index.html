<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>43-celery异步任务队列 - daxin.li&#39;s blog</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="daxin.li" />
  <meta name="description" content="1 Celery概述 关于celery的定义，首先来看官方网站： Celery(芹菜) 是一个简单、灵活且可靠的，处理大量消息的分布式系统，并且提供" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.75.1" />


<link rel="canonical" href="https://dachenzi.github.io/post/43-celery%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.b3a8813c06e6d785beba22bf8264e174fa2cb3a396b22f9ba24e2c00c18aaf7f.css" integrity="sha256-s6iBPAbm14W&#43;uiK/gmThdPoss6OWsi&#43;bok4sAMGKr38=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="43-celery异步任务队列" />
<meta property="og:description" content="1 Celery概述 关于celery的定义，首先来看官方网站： Celery(芹菜) 是一个简单、灵活且可靠的，处理大量消息的分布式系统，并且提供" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dachenzi.github.io/post/43-celery%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97/" />
<meta property="article:published_time" content="2017-11-19T01:46:49+00:00" />
<meta property="article:modified_time" content="2017-11-19T01:46:49+00:00" />
<meta itemprop="name" content="43-celery异步任务队列">
<meta itemprop="description" content="1 Celery概述 关于celery的定义，首先来看官方网站： Celery(芹菜) 是一个简单、灵活且可靠的，处理大量消息的分布式系统，并且提供">
<meta itemprop="datePublished" content="2017-11-19T01:46:49+00:00" />
<meta itemprop="dateModified" content="2017-11-19T01:46:49+00:00" />
<meta itemprop="wordCount" content="5582">



<meta itemprop="keywords" content="Python基础," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="43-celery异步任务队列"/>
<meta name="twitter:description" content="1 Celery概述 关于celery的定义，首先来看官方网站： Celery(芹菜) 是一个简单、灵活且可靠的，处理大量消息的分布式系统，并且提供"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">daxin.li's blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/post/">文章</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/categories/">类别</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://gohugo.io" rel="noopener" target="_blank">
              关于
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      daxin.li's blog
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/post/">文章</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/categories/">类别</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://gohugo.io" rel="noopener" target="_blank">
              关于
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">43-celery异步任务队列</h1>
      
      <div class="post-meta">
        <time datetime="2017-11-19" class="post-time">
          2017-11-19
        </time>
        <div class="post-category">
            <a href="https://dachenzi.github.io/categories/python%E5%9F%BA%E7%A1%80/"> Python基础 </a>
            
          </div>
        <span class="more-meta"> 约 5582 字 </span>
          <span class="more-meta"> 预计阅读 12 分钟 </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#31-利用pip3命令安装celery模块">3.1 利用pip3命令安装celery模块</a></li>
    <li><a href="#32-创建一个celery-application">3.2 创建一个celery application</a>
      <ul>
        <li><a href="#321-通过实例定制化celery">3.2.1 通过实例定制化celery</a></li>
        <li><a href="#322-通过配置信息定制化celery">3.2.2 通过配置信息定制化celery</a></li>
      </ul>
    </li>
    <li><a href="#33-运行一个worker">3.3 运行一个worker</a></li>
    <li><a href="#34-发布调用任务">3.4 发布(调用)任务</a></li>
    <li><a href="#35-观察执行结果">3.5 观察执行结果</a></li>
    <li><a href="#36-asyncresult-实例常用方法">3.6 AsyncResult 实例常用方法</a></li>
    <li><a href="#37-定时执行一次">3.7 定时执行一次</a></li>
  </ul>

  <ul>
    <li><a href="#41-运行">4.1 运行</a></li>
    <li><a href="#42-后台启动多进程celery-work">4.2 后台启动多进程celery work</a></li>
    <li><a href="#43-常用其他命令">4.3 常用其他命令</a></li>
  </ul>

  <ul>
    <li><a href="#61-编写celerypy配置文件">6.1 编写celery.py配置文件</a></li>
    <li><a href="#62-编写__init__py文件">6.2 编写__init__.py文件</a></li>
    <li><a href="#63-编写taskspy文件发送邮件">6.3 编写tasks.py文件(发送邮件)</a></li>
    <li><a href="#64-编写views视图函数">6.4 编写views视图函数</a></li>
    <li><a href="#65-启动worker">6.5 启动worker</a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h1 id="1-celery概述">1 Celery概述</h1>
<p>关于celery的定义，首先来看官方网站：
<strong>Celery(芹菜) 是一个简单、灵活且可靠的，处理大量消息的分布式系统，并且提供维护这样一个系统的必需工具。</strong></p>
<p>        简单来看，是一个基于python开发的分布式异步消息任务队列，持使用任务队列的方式在分布的机器、进程、线程上执行任务调度。通过它可以轻松的实现任务的异步处理， 如果你的业务场景中需要用到异步任务，就可以考虑使用celery， 举几个实例场景中可用的例子:</p>
<ol>
<li>你想对100台机器执行一条批量命令，可能会花很长时间 ，但你不想让你的程序等着结果返回，而是给你返回 一个任务ID,你过一段时间只需要拿着这个任务id就可以拿到任务执行结果，在任务执行ing进行时，你可以继续做其它的事情。 　　</li>
<li>你想做一个定时任务，比如每天检测一下你们所有客户的资料，如果发现今天 是客户的生日，就给他发个短信祝福 。　　</li>
</ol>
<p>Celery 在执行任务时需要通过一个中间人(消息中间件)来接收和发送任务消息，以及存储任务结果，完整的中间人列表请查阅官方网站</p>
<p>PS：任务队列是一种在线程或机器间分发任务的机制。
PS：消息队列的输入是工作的一个单元，称为任务，独立的工作（Worker）进程持续监视队列中是否有需要处理的新任务。</p>
<h1 id="2-celery简介">2 Celery简介</h1>
<p>        Celery 系统可包含多个职程和中间人，以此获得高可用性和横向扩展能力，其基本架构由三部分组成，<code>消息中间件</code>（message broker），<code>任务执行单元</code>（worker）和<code>任务执行结果存储</code>（task result store）组成。</p>
<ul>
<li><code>消息中间件</code>，Celery本身不提供消息服务，但是可以方便的和第三方提供的消息中间件集成，一般使用rabbitMQ or Redis，当然其他的还有MySQL以及Mongodb。</li>
<li><code>任务执行单元</code>，Worker是Celery提供的任务执行的单元，worker并发的运行在分布式的系统节点中。</li>
<li><code>任务结果存储</code>，Task result store用来存储Worker执行的任务的结果，Celery支持以不同方式存储任务的结果，包括Redis，MongoDB，Django ORM，AMQP等。</li>
</ul>
<p>Celery的主要特点：</p>
<ol>
<li>简单：一单熟悉了celery的工作流程后，配置和使用还是比较简单的</li>
<li>高可用：当任务执行失败或执行过程中发生连接中断，celery 会自动尝试重新执行任务</li>
<li>快速：一个单进程的celery每分钟可处理上百万个任务</li>
<li>灵活： 几乎celery的各个组件都可以被扩展及自定制</li>
</ol>
<p><img src="photo/celery.png" alt="celery"></p>
<p>根据前面的介绍，我们可以得出如下流程图：</p>
<ol>
<li>用户应用程序将任务(已经在celery app中注册的)放入Broker中。</li>
<li>多个worker通过Broker获取任务并执行。</li>
<li>worker执行完成后，会把任务的结果、状态等信息返回到Broker中存储，供用户程序读取。</li>
</ol>
<p>PS：Celery 用消息通信，通常使用中间人（Broker）在客户端和职程(worker)间斡旋。这个过程从客户端向队列添加消息开始，之后中间人把消息派送给职程(worker)。</p>
<h1 id="3-celery模块的基本使用">3 Celery模块的基本使用</h1>
<p>要使用Celery需要先安装celery模块，下面的例子使用Python3进行举例,使用redis作为消息中间人的角色。</p>
<h2 id="31-利用pip3命令安装celery模块">3.1 利用pip3命令安装celery模块</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">pip3</span> <span class="n">install</span> <span class="n">celery</span>

<span class="c1"># 测试是否成功安装</span>
<span class="p">[</span><span class="n">root</span><span class="nd">@namenode</span> <span class="o">~</span><span class="p">]</span><span class="c1"># python3</span>
<span class="n">Python</span> <span class="mf">3.6</span><span class="o">.</span><span class="mi">4</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Dec</span> <span class="mi">21</span> <span class="mi">2017</span><span class="p">,</span> <span class="mi">17</span><span class="p">:</span><span class="mi">26</span><span class="p">:</span><span class="mi">43</span><span class="p">)</span>
<span class="p">[</span><span class="n">GCC</span> <span class="mf">4.4</span><span class="o">.</span><span class="mi">7</span> <span class="mi">20120313</span> <span class="p">(</span><span class="n">Red</span> <span class="n">Hat</span> <span class="mf">4.4</span><span class="o">.</span><span class="mi">7</span><span class="o">-</span><span class="mi">16</span><span class="p">)]</span> <span class="n">on</span> <span class="n">linux</span>
<span class="n">Type</span> <span class="s2">&#34;help&#34;</span><span class="p">,</span> <span class="s2">&#34;copyright&#34;</span><span class="p">,</span> <span class="s2">&#34;credits&#34;</span> <span class="ow">or</span> <span class="s2">&#34;license&#34;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">celery</span>      <span class="c1"># 没有报错表示模块安装正常</span>
<span class="o">&gt;&gt;&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>PS：如果你是编译安装的Python3，执行以上步骤后不一定代表正确安装，还需要在命令行下执行celery命令，如果报错请参考这篇文章：<a href="http://www.cnblogs.com/dachenzi/p/8082129.html">Python3安装Celery模块后执行Celery命令报错</a></p>
<h2 id="32-创建一个celery-application">3.2 创建一个celery application</h2>
<p>用来定义任务列表，这里任务文件的名称叫做task.py(注意后面会用到文件名)。</p>
<h3 id="321-通过实例定制化celery">3.2.1 通过实例定制化celery</h3>
<p>在实例化celery应用时，对celery进行配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>
 
<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;task&#39;</span><span class="p">,</span>　　<span class="c1"># 是当前模块的名称，这个参数是必须的，这样的话名称可以自动生成</span>
    <span class="n">broker</span><span class="o">=</span><span class="s2">&#34;redis://10.0.0.3:6379/0&#34;</span><span class="p">,</span>     <span class="c1"># 中间人的地址</span>
    <span class="n">backend</span><span class="o">=</span><span class="s2">&#34;redis://10.0.0.3:6379/1&#34;</span>　　　<span class="c1"># 结果数据存放地址</span>
<span class="p">)</span>
 
<span class="nd">@app.task</span>　　　　　<span class="c1"># 使用celery标识一个任务，多个任务都需要使用该装饰器　</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>　　　　
    <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="322-通过配置信息定制化celery">3.2.2 通过配置信息定制化celery</h3>
<p>实例化celery应用后，通过conf对celery进行定制化配置（可以将配置项写在配置文件中，一般使用这种方式）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;mycelery&#39;</span><span class="p">)</span>

<span class="c1"># 全局配置(启用UTC时间，并配置时区)</span>
<span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">enable_utc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">timezone</span><span class="o">=</span><span class="s1">&#39;Asia/ShangHai&#39;</span><span class="p">)</span>
<span class="c1"># 派发任务要使用的队列(broker)</span>
<span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">broker_url</span> <span class="o">=</span> <span class="s1">&#39;redis://:daxin@10.0.0.10:6379/0&#39;</span>
<span class="c1"># 避免重复执行(执行超过visibility_timeout指定的时间，会重新派发任务，一般的解决办法是把这个时间调长</span>
<span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">broker_transport_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;visibility_timeout&#39;</span><span class="p">:</span> <span class="mi">3600</span><span class="o">*</span><span class="mi">12</span><span class="p">}</span>
<span class="c1"># 任务执行结果存储</span>
<span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">result_backend</span> <span class="o">=</span> <span class="s1">&#39;redis://:daxin@10.0.0.10:6379/1&#39;</span>
</code></pre></td></tr></table>
</div>
</div><p>其他中间人的配置</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># rabbitmq</span>
<span class="n">broker</span> <span class="o">=</span> <span class="s1">&#39;amqp://user:password@ip:5672//&#39;</span>

<span class="c1"># redis</span>
<span class="n">broker</span> <span class="o">=</span> <span class="s1">&#39;redis://:passwordf@ip:6379/db&#39;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="33-运行一个worker">3.3 运行一个worker</h2>
<p>当然这里可以执行多个worker，在命令行下执行(在test.py文件所在目录下执行)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">celery -A task worker --loglevel<span class="o">=</span>debug
celery -A task worker -l debug  <span class="c1"># 使用-l设置输出日志级别也可以</span>
</code></pre></td></tr></table>
</div>
</div><p>参数含义：</p>
<ul>
<li>-A参数表示的是Celery APP的名称，task就是APP的名称(<code>应用文件名</code>)</li>
<li>worker表示是一个执行任务角色</li>
<li>loglevel=info记录日志类型默认是info。</li>
</ul>
<h2 id="34-发布调用任务">3.4 发布(调用)任务</h2>
<p>这里在task.py所在的目录调用Python解释器执行，这样可以方便的引入这个app。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">task</span> <span class="kn">import</span> <span class="n">add</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">add</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>使用 <code>delay()</code> 方法来调用任务，这是 <code>apply_async()</code> 方法的快捷方式，该方法允许你更好地控制任务执行(异步执行)。</li>
<li>这个任务已经由之前启动的职程(worker)执行，可以查看职程的控制台输出来验证。</li>
</ul>
<p>PS：调用任务会返回一个 <code>AsyncResult</code> 实例，可用于检查任务的状态，等待任务完成或获取返回值（如果任务失败，则为异常和回溯）。 但这个功能默认是不开启的，需要设置一个 Celery 的结果后端(配置了backend才会生效)。</p>
<h2 id="35-观察执行结果">3.5 观察执行结果</h2>
<p>下面是worker在终端输出的日志</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">22</span> <span class="mi">15</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">36</span><span class="p">,</span><span class="mi">819</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">Received</span> <span class="n">task</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">add</span><span class="p">[</span><span class="n">b881bbea</span><span class="o">-</span><span class="n">e729</span><span class="o">-</span><span class="mf">444e-9</span><span class="n">efd</span><span class="o">-</span><span class="mi">434</span><span class="n">fa6e43f57</span><span class="p">]</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">22</span> <span class="mi">15</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">46</span><span class="p">,</span><span class="mi">828</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="n">Task</span> <span class="n">task</span><span class="o">.</span><span class="n">add</span><span class="p">[</span><span class="n">b881bbea</span><span class="o">-</span><span class="n">e729</span><span class="o">-</span><span class="mf">444e-9</span><span class="n">efd</span><span class="o">-</span><span class="mi">434</span><span class="n">fa6e43f57</span><span class="p">]</span> <span class="n">succeeded</span> <span class="ow">in</span> <span class="mf">10.008738335978705</span><span class="n">s</span><span class="p">:</span> <span class="mi">3</span>
</code></pre></td></tr></table>
</div>
</div><p>        从上面日志可以看到，当worker从中间人那获取任务后，会生成一个task ID，这里我们和之前发送任务返回的AsyncResult对比我们发现，每个task都有一个唯一的ID，第二行说明了这个任务执行succeed,执行结果为3。</p>
<p>PS：通过检查redis的数据也可以查看结果信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">root</span><span class="nd">@namenode</span> <span class="n">python</span><span class="p">]</span><span class="c1"># redis-cli</span>
<span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6379</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">keys</span> <span class="o">*</span>
<span class="mi">1</span><span class="p">)</span> <span class="s2">&#34;celery-task-meta-31f2f75d-20d9-4bb6-8b04-079ef65afbab&#34;</span>
<span class="mi">2</span><span class="p">)</span> <span class="s2">&#34;celery-task-meta-334f0e9b-87f6-461a-a068-571bd3773691&#34;</span>
<span class="mi">3</span><span class="p">)</span> <span class="s2">&#34;celery-task-meta-57bb002b-017d-43bc-a88a-6d470a9dfe95&#34;</span>
<span class="mi">4</span><span class="p">)</span> <span class="s2">&#34;celery-task-meta-05161a38-3fd9-4be1-bae9-dc674d30296c&#34;</span>
<span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6379</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span> <span class="n">get</span> <span class="n">celery</span><span class="o">-</span><span class="n">task</span><span class="o">-</span><span class="n">meta</span><span class="o">-</span><span class="n">cddbc105</span><span class="o">-</span><span class="n">ce52</span><span class="o">-</span><span class="mi">4</span><span class="n">d30</span><span class="o">-</span><span class="n">bab0</span><span class="o">-</span><span class="mi">2114749</span><span class="n">dcf99</span>
<span class="s2">&#34;{</span><span class="se">\&#34;</span><span class="s2">status</span><span class="se">\&#34;</span><span class="s2">: </span><span class="se">\&#34;</span><span class="s2">SUCCESS</span><span class="se">\&#34;</span><span class="s2">, </span><span class="se">\&#34;</span><span class="s2">result</span><span class="se">\&#34;</span><span class="s2">: 4, </span><span class="se">\&#34;</span><span class="s2">traceback</span><span class="se">\&#34;</span><span class="s2">: null, </span><span class="se">\&#34;</span><span class="s2">children</span><span class="se">\&#34;</span><span class="s2">: [], </span><span class="se">\&#34;</span><span class="s2">task_id</span><span class="se">\&#34;</span><span class="s2">: </span><span class="se">\&#34;</span><span class="s2">cddbc105-ce52-4d30-bab0-2114749dcf99</span><span class="se">\&#34;</span><span class="s2">}&#34;</span>
<span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">6379</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>可以看到有很多celery任务执行的结果</li>
<li>使用get就可以查看存储的信息(类型为string)</li>
</ul>
<h2 id="36-asyncresult-实例常用方法">3.6 AsyncResult 实例常用方法</h2>
<p>通过获取异步执行对象的返回值来获取AsyncResult实例对象</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>forget()</td>
<td>清除执行结果</td>
</tr>
<tr>
<td>revoke(terminate=True)</td>
<td>取消任务，terminate默认为False，正在执行的无法中断，为True时，正在执行的也会被中断</td>
</tr>
<tr>
<td>get(timeout=None,<br>propagate=False)</td>
<td>阻塞等待获取结果(可以重复拿)<br>1.timeout为超时时间,如果在指定时间内没有返回会报异常，否则永远等待<br>2.propagate为True时，可以美化输出信息<br>3.倘若任务抛出了一个异常， get() 会重新抛出异常。<br>4.如果celery没有配置backend，那么执行get方法将会异</td>
</tr>
<tr>
<td>ready()</td>
<td>结果为 True/False 表示 完成/未完成</td>
</tr>
<tr>
<td>successful()</td>
<td>执行成功时返回True</td>
</tr>
<tr>
<td>failed()</td>
<td>执行失败时返回True</td>
</tr>
<tr>
<td>result</td>
<td>获取结果</td>
</tr>
<tr>
<td>state</td>
<td>任务当前的状态<br>1.SUCCESS:运行成功<br>2.PENDING:等待被执行<br>3.STARTED:已经开始执行<br>4.RETRY:正在重试<br>5.FAILURE:执行失败</td>
</tr>
<tr>
<td>task_id</td>
<td>任务的id</td>
</tr>
<tr>
<td>traceback</td>
<td>获取原始的回溯信息</td>
</tr>
</tbody>
</table>
<p>导入AsyncResult对象，来查看结果的方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">celery.result</span> <span class="kn">import</span> <span class="n">AsyncResult</span>
<span class="kn">from</span> <span class="nn">task</span> <span class="kn">import</span> <span class="n">app</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">AsyncResult</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;d01289e4-9034-4a46-8c63-7bca45946efa&#39;</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">task_id</span><span class="p">)</span>  <span class="c1"># d01289e4-9034-4a46-8c63-7bca45946efa</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">successful</span><span class="p">())</span>  <span class="c1"># True</span>
</code></pre></td></tr></table>
</div>
</div><p>注意：AsyncResult对象，需要一个id，和它对应的app，才可以解析到结果。</p>
<h2 id="37-定时执行一次">3.7 定时执行一次</h2>
<p>        celery内置定时任务和crontab的效果一样，现在我的需求是在某一时刻来执行(比如at命令)，那么可以使用apply_async的eta参数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">task</span> <span class="kn">import</span> <span class="n">func</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="n">ctime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">ctime</span><span class="p">)</span>
<span class="n">utc_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">ctime</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="n">utc_time</span><span class="p">)</span>

<span class="n">addten</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">utc_time</span> <span class="o">+=</span> <span class="n">addten</span>

<span class="c1"># utc_time = datetime.datetime(year=2019, month=4, day=11, hour=9, minute=41)  # 直接构建，也需要是utc时间</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">eta</span><span class="o">=</span><span class="n">utc_time</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="4-多目录结构">4 多目录结构</h1>
<p>上面只是基础的用法，在生产中我们往往不这样使用，一般的目录结构如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="err">├──</span> <span class="n">celery_task</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="n">account</span><span class="o">.</span><span class="n">py</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="n">celery</span><span class="o">.</span><span class="n">py</span>  <span class="c1"># 配置文件</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="n">tasks</span><span class="o">.</span><span class="n">py</span>
<span class="err">└──</span> <span class="n">givetask</span><span class="o">.</span><span class="n">py</span>  <span class="c1"># 分发任务</span>
</code></pre></td></tr></table>
</div>
</div><p>说明：</p>
<ul>
<li>一般会在项目目录下直接创建一个以celery开头的文件夹用于存放celery的配置文件和任务</li>
<li>必须存在一个celery.py文件，连接等相关的配置需要在这里创建</li>
<li>task函数所在的文件名称可以自定义,只需要在celery.py中，列出即可</li>
</ul>
<p>下面是一个典型的celery.py的内容</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># 必须是celery名字，celery连接相关的配置(配置文件)</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="n">cel</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;cel&#39;</span><span class="p">,</span>
             <span class="n">broker</span><span class="o">=</span><span class="s1">&#39;redis://10.0.0.10:6379&#39;</span><span class="p">,</span>
             <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;redis://10.0.0.10:6379&#39;</span><span class="p">,</span>
             <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;celery_task.tasks&#39;</span><span class="p">,</span> <span class="s1">&#39;celery_task.account&#39;</span><span class="p">])</span>

<span class="c1"># 时区</span>
<span class="n">cel</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">timezone</span> <span class="o">=</span> <span class="s1">&#39;Asia/Shanghai&#39;</span>

<span class="c1"># 使用使用UTC</span>
<span class="n">cel</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">enable_utc</span> <span class="o">=</span> <span class="bp">False</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>include列表中，包含所有task的文件名称即可，注意要从celery_task目录开始写起。</li>
<li>调用时，可以在celery_task目录同级目录，来导入task函数，来传递任务。</li>
</ul>
<h2 id="41-运行">4.1 运行</h2>
<p>需要注意的是必须在celery_task目录同级目录下，执行命令运行worker服务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">celery</span> <span class="o">-</span><span class="n">A</span> <span class="n">celery_task</span> <span class="n">worker</span> <span class="o">-</span><span class="n">l</span> <span class="n">info</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="42-后台启动多进程celery-work">4.2 后台启动多进程celery work</h2>
<p>前面的启动方法一次只能启动一个，会在前台显示并打印日志，终端退出，那么celery进程也会退出，当然我们可以使用&amp;来进行后台启动，日志可以使用-q来禁止输出，但是这毕竟不是最佳方法，官方提供了多进程后台的启动方式利用 celery  multi 启动</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># 后台启动 celery worker进程</span>
 
<span class="n">celery</span> <span class="n">multi</span> <span class="n">start</span> <span class="n">work_1</span> <span class="o">-</span><span class="n">A</span> <span class="n">appcelery</span> 
 
<span class="c1"># work_1 为woker的名称，可以用来进行对该进程进行管理</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="43-常用其他命令">4.3 常用其他命令</h2>
<p>多进程相关</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># 停止worker进程,有的时候这样无法停止进程，就需要加上-A 项目名，才可以删掉</span>
<span class="n">celery</span> <span class="n">multi</span> <span class="n">stop</span> <span class="n">WOERNAME</span>      

<span class="c1"># 重启worker进程</span>
<span class="n">celery</span> <span class="n">multi</span> <span class="n">restart</span> <span class="n">WORKNAME</span>       

<span class="c1"># 查看该项目运行的进程数</span>
<span class="n">celery</span> <span class="n">status</span> <span class="o">-</span><span class="n">A</span> <span class="n">celery_task</span>      
</code></pre></td></tr></table>
</div>
</div><h1 id="5-celery的定时任务">5 Celery的定时任务</h1>
<p>        celery支持定时任务，设定好任务的执行时间，celery就会定时自动帮你执行， 这个定时任务模块叫celery beat，类似于Linux中的crontab。主要有两种类型：每隔多久执行一次或者定期执行。</p>
<p>        由于是定期执行，所以celery的定时任务主要有两类进程，即完成任务的worker进程和分发任务的beat进程。</p>
<p>下面是一个定时任务程序</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">from</span> <span class="nn">celery.schedules</span> <span class="kn">import</span> <span class="n">crontab</span>
 
<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;celeryperiodoc&#39;</span><span class="p">,</span>
    <span class="n">broker</span><span class="o">=</span><span class="s2">&#34;redis://10.0.0.10:6379/0&#34;</span><span class="p">,</span>
    <span class="n">backend</span><span class="o">=</span><span class="s2">&#34;redis://10.0.0.10:6379/1&#34;</span>
<span class="p">)</span>
 
<span class="nd">@app.on_after_configure.connect</span>        <span class="c1"># 定时任务必须要用的装饰器</span>
<span class="k">def</span> <span class="nf">setup_periodic_tasks</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>      <span class="c1"># sender是必须传递的参数，类似于django的requests一样</span>
    <span class="c1"># Calls test(&#39;hello&#39;) every 10 seconds.</span>
    <span class="n">sender</span><span class="o">.</span><span class="n">add_periodic_task</span><span class="p">(</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">test</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;add every 10&#39;</span><span class="p">)</span>    <span class="c1"># 添加一个定时任务，10.0表示每隔10秒，test.s表示给test函数传递的参数，name表示任务名称</span>
 
    <span class="c1"># Calls test(&#39;world&#39;) every 30 seconds</span>
    <span class="n">sender</span><span class="o">.</span><span class="n">add_periodic_task</span><span class="p">(</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">test</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">),</span> <span class="n">expires</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
 
    <span class="c1"># Executes every Thureday at 19:52 p.m.</span>
    <span class="n">sender</span><span class="o">.</span><span class="n">add_periodic_task</span><span class="p">(</span>          
        <span class="n">crontab</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">52</span><span class="p">,</span><span class="n">day_of_week</span><span class="o">=</span><span class="s1">&#39;thu&#39;</span><span class="p">),</span>      <span class="c1"># 利用crontab设定定时执行</span>
        <span class="n">test</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="s1">&#39;Happy Mondays!&#39;</span><span class="p">),</span>
    <span class="p">)</span>
 
<span class="nd">@app.task</span>
<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>启动一个beat进程：celery -A celeryFIleName beat</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"> <span class="p">[</span><span class="n">root</span><span class="nd">@namenode</span> <span class="n">celerymodule</span><span class="p">]</span><span class="c1"># celery -A celeryperiodoc beat</span>
<span class="n">celery</span> <span class="n">beat</span> <span class="n">v4</span><span class="o">.</span><span class="mf">1.0</span> <span class="p">(</span><span class="n">latentcall</span><span class="p">)</span> <span class="ow">is</span> <span class="n">starting</span><span class="o">.</span>
<span class="n">__</span>    <span class="o">-</span>    <span class="o">...</span> <span class="n">__</span>   <span class="o">-</span>        <span class="n">_</span>
<span class="n">LocalTime</span> <span class="o">-&gt;</span> <span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span> <span class="mi">20</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">54</span>
<span class="n">Configuration</span> <span class="o">-&gt;</span>
    <span class="o">.</span> <span class="n">broker</span> <span class="o">-&gt;</span> <span class="n">redis</span><span class="p">:</span><span class="o">//</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">0.10</span><span class="p">:</span><span class="mi">6379</span><span class="o">/</span><span class="mi">0</span>
    <span class="o">.</span> <span class="n">loader</span> <span class="o">-&gt;</span> <span class="n">celery</span><span class="o">.</span><span class="n">loaders</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">AppLoader</span>
    <span class="o">.</span> <span class="n">scheduler</span> <span class="o">-&gt;</span> <span class="n">celery</span><span class="o">.</span><span class="n">beat</span><span class="o">.</span><span class="n">PersistentScheduler</span>
    <span class="o">.</span> <span class="n">db</span> <span class="o">-&gt;</span> <span class="n">celerybeat</span><span class="o">-</span><span class="n">schedule</span>
    <span class="o">.</span> <span class="n">logfile</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">stderr</span><span class="p">]</span><span class="err">@</span><span class="o">%</span><span class="n">WARNING</span>
    <span class="o">.</span> <span class="n">maxinterval</span> <span class="o">-&gt;</span> <span class="mf">5.00</span> <span class="n">minutes</span> <span class="p">(</span><span class="mi">300</span><span class="n">s</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>启动一个worker进程： celery -A celeryFIleName worker</p>
<p>日志结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span> <span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">14</span><span class="p">,</span><span class="mi">267</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">Received</span> <span class="n">task</span><span class="p">:</span> <span class="n">celeryperiodoc</span><span class="o">.</span><span class="n">test</span><span class="p">[</span><span class="mi">641</span><span class="n">d0e17</span><span class="o">-</span><span class="n">ff26</span><span class="o">-</span><span class="mi">4791</span><span class="o">-</span><span class="n">acca</span><span class="o">-</span><span class="mi">8</span><span class="n">c0cce8d6709</span><span class="p">]</span> 
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span> <span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">14</span><span class="p">,</span><span class="mi">269</span><span class="p">:</span> <span class="n">WARNING</span><span class="o">/</span><span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="n">hello</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span> <span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">14</span><span class="p">,</span><span class="mi">276</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="n">Task</span> <span class="n">celeryperiodoc</span><span class="o">.</span><span class="n">test</span><span class="p">[</span><span class="mi">641</span><span class="n">d0e17</span><span class="o">-</span><span class="n">ff26</span><span class="o">-</span><span class="mi">4791</span><span class="o">-</span><span class="n">acca</span><span class="o">-</span><span class="mi">8</span><span class="n">c0cce8d6709</span><span class="p">]</span> <span class="n">succeeded</span> <span class="ow">in</span> <span class="mf">0.007056772010400891</span><span class="n">s</span><span class="p">:</span> <span class="bp">None</span>
 
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span> <span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">24</span><span class="p">,</span><span class="mi">269</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">Received</span> <span class="n">task</span><span class="p">:</span> <span class="n">celeryperiodoc</span><span class="o">.</span><span class="n">test</span><span class="p">[</span><span class="mi">25</span><span class="n">b3ea6a</span><span class="o">-</span><span class="mo">0405</span><span class="o">-</span><span class="mi">4431</span><span class="o">-</span><span class="n">a1e1</span><span class="o">-</span><span class="mi">840</span><span class="n">f5dbdc57e</span><span class="p">]</span>   <span class="n">expires</span><span class="p">:[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span> <span class="mi">12</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mf">34.266983</span><span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span><span class="p">]</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span> <span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">24</span><span class="p">,</span><span class="mi">270</span><span class="p">:</span> <span class="n">WARNING</span><span class="o">/</span><span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="n">world</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span> <span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">24</span><span class="p">,</span><span class="mi">271</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="n">Task</span> <span class="n">celeryperiodoc</span><span class="o">.</span><span class="n">test</span><span class="p">[</span><span class="mi">25</span><span class="n">b3ea6a</span><span class="o">-</span><span class="mo">0405</span><span class="o">-</span><span class="mi">4431</span><span class="o">-</span><span class="n">a1e1</span><span class="o">-</span><span class="mi">840</span><span class="n">f5dbdc57e</span><span class="p">]</span> <span class="n">succeeded</span> <span class="ow">in</span> <span class="mf">0.0009060979355126619</span><span class="n">s</span><span class="p">:</span> <span class="bp">None</span>
 
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span> <span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">24</span><span class="p">,</span><span class="mi">271</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">Received</span> <span class="n">task</span><span class="p">:</span> <span class="n">celeryperiodoc</span><span class="o">.</span><span class="n">test</span><span class="p">[</span><span class="n">b5dce374</span><span class="o">-</span><span class="mi">4596</span><span class="o">-</span><span class="mi">4282</span><span class="o">-</span><span class="mi">987</span><span class="n">a</span><span class="o">-</span><span class="mf">494e2</span><span class="n">ede365c</span><span class="p">]</span> 
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span> <span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">24</span><span class="p">,</span><span class="mi">273</span><span class="p">:</span> <span class="n">WARNING</span><span class="o">/</span><span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="n">hello</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span> <span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">24</span><span class="p">,</span><span class="mi">273</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="n">Task</span> <span class="n">celeryperiodoc</span><span class="o">.</span><span class="n">test</span><span class="p">[</span><span class="n">b5dce374</span><span class="o">-</span><span class="mi">4596</span><span class="o">-</span><span class="mi">4282</span><span class="o">-</span><span class="mi">987</span><span class="n">a</span><span class="o">-</span><span class="mf">494e2</span><span class="n">ede365c</span><span class="p">]</span> <span class="n">succeeded</span> <span class="ow">in</span> <span class="mf">0.0006978920428082347</span><span class="n">s</span><span class="p">:</span> <span class="bp">None</span>
 
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span> <span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">34</span><span class="p">,</span><span class="mi">270</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">Received</span> <span class="n">task</span><span class="p">:</span> <span class="n">celeryperiodoc</span><span class="o">.</span><span class="n">test</span><span class="p">[</span><span class="mi">1</span><span class="n">a67a24a</span><span class="o">-</span><span class="mo">034</span><span class="mi">8</span><span class="o">-</span><span class="mi">416</span><span class="n">d</span><span class="o">-</span><span class="n">a4c0</span><span class="o">-</span><span class="n">fc033108cda1</span><span class="p">]</span> 
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span> <span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">34</span><span class="p">,</span><span class="mi">271</span><span class="p">:</span> <span class="n">WARNING</span><span class="o">/</span><span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="n">hello</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span> <span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">34</span><span class="p">,</span><span class="mi">272</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="n">Task</span> <span class="n">celeryperiodoc</span><span class="o">.</span><span class="n">test</span><span class="p">[</span><span class="mi">1</span><span class="n">a67a24a</span><span class="o">-</span><span class="mo">034</span><span class="mi">8</span><span class="o">-</span><span class="mi">416</span><span class="n">d</span><span class="o">-</span><span class="n">a4c0</span><span class="o">-</span><span class="n">fc033108cda1</span><span class="p">]</span> <span class="n">succeeded</span> <span class="ow">in</span> <span class="mf">0.0008945289300754666</span><span class="n">s</span><span class="p">:</span> <span class="bp">None</span>
 
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span> <span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">44</span><span class="p">,</span><span class="mi">272</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">MainProcess</span><span class="p">]</span> <span class="n">Received</span> <span class="n">task</span><span class="p">:</span> <span class="n">celeryperiodoc</span><span class="o">.</span><span class="n">test</span><span class="p">[</span><span class="n">e6853e92</span><span class="o">-</span><span class="mi">9</span><span class="n">c42</span><span class="o">-</span><span class="mi">4</span><span class="n">c49</span><span class="o">-</span><span class="mi">8148</span><span class="o">-</span><span class="mi">5</span><span class="n">d575268f3a7</span><span class="p">]</span> 
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span> <span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">44</span><span class="p">,</span><span class="mi">273</span><span class="p">:</span> <span class="n">WARNING</span><span class="o">/</span><span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="n">hello</span>
<span class="p">[</span><span class="mi">2017</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">26</span> <span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">:</span><span class="mi">44</span><span class="p">,</span><span class="mi">274</span><span class="p">:</span> <span class="n">INFO</span><span class="o">/</span><span class="n">ForkPoolWorker</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="n">Task</span> <span class="n">celeryperiodoc</span><span class="o">.</span><span class="n">test</span><span class="p">[</span><span class="n">e6853e92</span><span class="o">-</span><span class="mi">9</span><span class="n">c42</span><span class="o">-</span><span class="mi">4</span><span class="n">c49</span><span class="o">-</span><span class="mi">8148</span><span class="o">-</span><span class="mi">5</span><span class="n">d575268f3a7</span><span class="p">]</span> <span class="n">succeeded</span> <span class="ow">in</span> <span class="mf">0.0009920489974319935</span><span class="n">s</span><span class="p">:</span> <span class="bp">None</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>观察hello的输出间隔，发现是每隔10秒输出一次</li>
<li>观察world的输出间隔，可以看出是每隔30秒输出一次</li>
</ul>
<p>其他:执行完毕后会在当前目录下产生一个二进制文件celerybeat-schedule,该文件用于存放上次执行结果：</p>
<ul>
<li>如果存在celerybeat-schedule文件，那么读取后根据上一次执行的时间，继续执行。</li>
<li>如果不存在celerybeat-schedule文件，那么会立即执行一次。</li>
<li>如果存在celerybeat-schedule文件，读取后，发现间隔时间已过，那么会立即执行。</li>
</ul>
<h1 id="6-在django中集成celery">6 在django中集成celery</h1>
<p>最常用的场景，应该就是用户注册时的发送邮件了，下面以完成邮件发送为目的来，编写celery任务</p>
<h2 id="61-编写celerypy配置文件">6.1 编写celery.py配置文件</h2>
<p>在项目的目录下(与settings.py文件同级)，创建celery文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>

<span class="c1"># set the default Django settings module for the &#39;celery&#39; program.</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;DJANGO_SETTINGS_MODULE&#39;</span><span class="p">,</span> <span class="s1">&#39;stu_crm.settings&#39;</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s1">&#39;stu_crm&#39;</span><span class="p">)</span>

<span class="c1"># Using a string here means the worker doesn&#39;t have to serialize</span>
<span class="c1"># the configuration object to child processes.</span>
<span class="c1"># - namespace=&#39;CELERY&#39; means all celery-related configuration keys</span>
<span class="c1">#   should have a `CELERY_` prefix.</span>
<span class="n">app</span><span class="o">.</span><span class="n">config_from_object</span><span class="p">(</span><span class="s1">&#39;django.conf:settings&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;CELERY&#39;</span><span class="p">)</span>

<span class="c1"># Load task modules from all registered Django app configs.</span>
<span class="n">app</span><span class="o">.</span><span class="n">autodiscover_tasks</span><span class="p">()</span>

<span class="c1"># ------------------------------------</span>
<span class="c1">## 后面的是celery的配置信息，可以放在setting.py中，通过配置来调用</span>
<span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">utc_time</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">timezone</span><span class="o">=</span><span class="s1">&#39;Asia/Shanghai&#39;</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">broker_url</span> <span class="o">=</span> <span class="s1">&#39;redis://:daxin@10.0.0.10:6379/0&#39;</span>
<span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">result_backend</span> <span class="o">=</span> <span class="s1">&#39;redis://:daxin@10.0.0.10:6379/1&#39;</span>
<span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">broker_transport_option</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;visibility_timeout&#39;</span><span class="p">:</span> <span class="mi">3600</span> <span class="o">*</span> <span class="mi">12</span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="62-编写__init__py文件">6.2 编写__init__.py文件</h2>
<p>需要修改项目的__init__.py文件，添加如下内容</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="c1"># This will make sure the app is always imported when</span>
<span class="c1"># Django starts so that shared_task will use this app.</span>
<span class="kn">from</span> <span class="nn">.celery</span> <span class="kn">import</span> <span class="n">app</span> <span class="k">as</span> <span class="n">celery_app</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;celery_app&#39;</span><span class="p">,)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="63-编写taskspy文件发送邮件">6.3 编写tasks.py文件(发送邮件)</h2>
<p>在各个项目内，创建tasks.py文件，针对不同的项目编写不同的task任务</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># 需要引入</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="c1"># 通过app.task来标识celery任务函数，也可以使用from celery import shared_task，shared_task来装饰</span>
<span class="kn">from</span> <span class="nn">stu_crm.celery</span> <span class="kn">import</span> <span class="n">app</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.core.mail</span> <span class="kn">import</span> <span class="n">send_mail</span>

<span class="c1"># @shared_task(name=&#39;send&#39;)</span>
<span class="nd">@app.task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;send&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sendmail</span><span class="p">():</span>
    <span class="n">send_mail</span><span class="p">(</span>
        <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;Test测试邮件&#39;</span><span class="p">,</span>
        <span class="n">message</span><span class="o">=</span><span class="s1">&#39;这是一封测试邮件&#39;</span><span class="p">,</span>
        <span class="n">from_email</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">EMAIL_HOST_USER</span><span class="p">,</span>
        <span class="n">recipient_list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;287990400@qq.com&#39;</span><span class="p">],</span>
        <span class="n">fail_silently</span><span class="o">=</span><span class="bp">False</span>
    <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>这里利用了django的提供的邮件发送功能，所以需要添加如下关于邮箱的配置，在settings.py中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">EMAIL_HOST_USER</span> <span class="o">=</span> <span class="s1">&#39;beyondlee2011@126.com&#39;</span>
<span class="n">EMAIL_PORT</span> <span class="o">=</span> <span class="mi">465</span>
<span class="n">EMAIL_HOST_PASSWORD</span> <span class="o">=</span> <span class="s1">&#39;xxxxxxxxxxx&#39;</span>
<span class="n">EMAIL_HOST</span> <span class="o">=</span> <span class="s1">&#39;smtp.126.com&#39;</span>
<span class="n">EMAIL_USE_SSL</span> <span class="o">=</span> <span class="bp">True</span>   <span class="c1"># 是否使用SSL</span>
<span class="n">EMAIL_USE_TLS</span> <span class="o">=</span> <span class="bp">False</span>
</code></pre></td></tr></table>
</div>
</div><p>当然也可以使用yagmail来发送邮件：<a href="http://www.cnblogs.com/dachenzi/p/8655022.html">yagmail发送邮件</a></p>
<h2 id="64-编写views视图函数">6.4 编写views视图函数</h2>
<p>通过视图函数来模拟调用过程。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">.tasks</span> <span class="kn">import</span> <span class="n">sendmail</span>

<span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sendmail</span><span class="o">.</span><span class="n">delay</span><span class="p">()</span>
        <span class="c1"># add.delay(10, 20)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="65-启动worker">6.5 启动worker</h2>
<p>发布任务的流程已经创建完毕，接下来，就需要启动worker来监控broker获取任务并执行了。
在manage.py同级目录下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">celery</span> <span class="o">-</span><span class="n">A</span> <span class="n">crm</span> <span class="n">worker</span> <span class="o">-</span><span class="n">l</span> <span class="n">info</span>
</code></pre></td></tr></table>
</div>
</div><p>这样就完成了启动。接下来只需要访问定义好的url，那么就可以发布任务了。</p>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">daxin.li</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2017-11-19
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content">原创文章，如需转载请注明文章作者和出处。谢谢！</span>
  </p>
</div>


    
    
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/static/wechat-qr-code.png">
        <span>微信打赏</span>
      </label>
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/static/alipay-qr-code.png">
        <span>支付宝打赏</span>
      </label>
  </div>
</div>

    <footer class="post-footer">
      <div class="post-tags">
          <a href="https://dachenzi.github.io/tags/python%E5%9F%BA%E7%A1%80/">Python基础</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/6-form-modelform%E5%AF%B9%E8%B1%A1/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">6-Form-ModelForm对象</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/29-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86-%E6%A8%A1%E5%9D%97%E5%8C%96/">
            <span class="next-text nav-default">29-异常处理-模块化</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  
  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "dachenzi/dachenzi.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:dahlhin.li@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/dachenzi" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://weibo.com/2401416804/profile?rightmod=1&amp;wvr=6&amp;mod=personinfo" rel="me noopener" class="iconfont"
      title="weibo"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M385.714286 733.714286q12-19.428571 6.285714-39.428571t-25.714286-28.571429q-19.428571-8-41.714286-0.571429t-34.285714 26.285714q-12.571429 19.428571-7.428571 39.142857t24.571429 28.857143 42.571429 1.428571 35.714286-27.142857zm53.714286-69.142857q4.571429-7.428571 2-15.142857t-10-10.571429q-8-2.857143-16.285714 2.857143t-12.285714 10.571429q-9.714286 17.714286 7.428571 25.714286 8 2.857143 16.571429 2.857143t12.571429-10.571429zm99.428571 61.142857q-25.714286 58.285714-90.285714 85.714286t-128 6.857143q-61.142857-19.428571-84.285714-72.285714t3.714286-107.142857q26.857143-53.142857 86.571429-79.428571t120.285714-10.857143q63.428571 16.571429 90.571429 68.285714t1.428571 108.857143zm178.285714-91.428571q-5.142857-54.857143-50.857143-97.142857t-119.142857-62.285714-156.857143-12q-127.428571 13.142857-211.142857 80.857143t-75.714286 151.142857q5.142857 54.857143 50.857143 97.142857t119.142857 62.285714 156.857143 12q127.428571-13.142857 211.142857-80.857143t75.714286-151.142857zm176 2.285714q0 38.857143-21.142857 79.714286t-62.285714 78.285714-96.285714 67.142857-129.142857 47.428571-154.571429 17.714286-157.142857-19.142857-137.428571-53.142857-98-86.285714-37.142857-114q0-65.714286 39.714286-140t112.857143-147.428571q96.571429-96.571429 195.142857-134.857143t140.857143 4q37.142857 36.571429 11.428571 119.428571-2.285714 8-0.571429 11.428571t5.714286 4 8.285714 2.857143 7.714286-2l3.428571-1.142857q79.428571-33.714286 140.571429-33.714286t87.428571 34.857143q25.714286 36 0 101.714286-1.142857 7.428571-2.571429 11.428571t2.571429 7.142857 6.857143 4.285714 9.714286 3.428571q32.571429 10.285714 58.857143 26.857143t45.714286 46.571429 19.428571 66.571429zm-42.285714-356.571429q24 26.857143 31.142857 62t-3.714286 67.142857q-4.571429 13.142857-16.857143 19.428571t-25.428571 2.285714q-13.142857-4.571429-19.428571-16.857143t-2.285714-25.428571q11.428571-36-13.714286-63.428571t-61.142857-20q-13.714286 2.857143-25.714286-4.571429t-14.285714-21.142857q-2.857143-13.714286 4.571429-25.428571t21.142857-14.571429q34.285714-7.428571 68 3.142857t57.714286 37.428571zm103.428571-93.142857q49.714286 54.857143 64.285714 127.142857t-7.714286 138q-5.142857 15.428571-19.428571 22.857143t-29.714286 2.285714-22.857143-19.428571-2.857143-29.714286q16-46.857143 5.714286-98.285714t-45.714286-90.285714q-35.428571-39.428571-84.571429-54.571429t-98.857143-4.857143q-16 3.428571-29.714286-5.428571t-17.142857-24.857143 5.428571-29.428571 24.857143-16.857143q70.285714-14.857143 139.428571 6.571429t118.857143 76.857143z"></path>
</svg>

    </a>
  
    <a href="https://www.zhihu.com/people/da-chen-zi-67" rel="me noopener" class="iconfont"
      title="zhihu"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M351.791182 562.469462l192.945407 0c0-45.367257-21.3871-71.939449-21.3871-71.939449L355.897709 490.530013c3.977591-82.182744 7.541767-187.659007 8.816806-226.835262l159.282726 0c0 0-0.86367-67.402109-18.578124-67.402109s-279.979646 0-279.979646 0 16.850783-88.141456 39.318494-127.053698c0 0-83.60514-4.510734-112.121614 106.962104S81.344656 355.077018 76.80834 367.390461c-4.536316 12.313443 24.62791 5.832845 36.941354 0 12.313443-5.832845 68.050885-25.924439 84.252893-103.69571l86.570681 0c1.165546 49.28652 4.596691 200.335724 3.515057 226.835262L109.86113 490.530013c-25.275663 18.147312-33.701566 71.939449-33.701566 71.939449L279.868105 562.469462c-8.497535 56.255235-23.417339 128.763642-44.275389 167.210279-33.05279 60.921511-50.55235 116.65793-169.802314 212.576513 0 0-19.442818 14.257725 40.829917 9.073656 60.273758-5.185093 117.305683-20.739347 156.840094-99.807147 20.553105-41.107233 41.805128-93.250824 58.386782-146.138358l-0.055259 0.185218 167.855986 193.263655c0 0 22.035876-51.847855 5.832845-108.880803L371.045711 650.610918l-42.1244 31.157627-0.045025 0.151449c11.69946-41.020252 20.11206-81.5749 22.726607-116.858498C351.665315 564.212152 351.72876 563.345412 351.791182 562.469462z"></path>
  <path d="M584.918753 182.033893l0 668.840094 70.318532 0 28.807093 80.512708 121.875768-80.512708 153.600307 0L959.520453 182.033893 584.918753 182.033893zM887.150192 778.934538l-79.837326 0-99.578949 65.782216-23.537066-65.782216-24.855084 0L659.341766 256.673847l227.807403 0L887.149169 778.934538z"></path>
</svg>

    </a>


<a href="https://dachenzi.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2016 -
    2020
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        daxin.li
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>



  <script type="text/javascript">
    window.MathJax = {
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script>









  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
