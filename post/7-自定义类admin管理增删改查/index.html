<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>7-自定义类admin管理增删改查 - daxin.li&#39;s blog</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="daxin.li" />
  <meta name="description" content="文章目录 1 django admin分析 2 django admin源码分析 2.1 注册部分 2.2 路由分发部分 2.3 流程总结 2.4 定制admin 3 django admin的接口 4 自定义ayra进行C" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.75.1" />


<link rel="canonical" href="https://dachenzi.github.io/post/7-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BBadmin%E7%AE%A1%E7%90%86%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.b3a8813c06e6d785beba22bf8264e174fa2cb3a396b22f9ba24e2c00c18aaf7f.css" integrity="sha256-s6iBPAbm14W&#43;uiK/gmThdPoss6OWsi&#43;bok4sAMGKr38=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="7-自定义类admin管理增删改查" />
<meta property="og:description" content="文章目录 1 django admin分析 2 django admin源码分析 2.1 注册部分 2.2 路由分发部分 2.3 流程总结 2.4 定制admin 3 django admin的接口 4 自定义ayra进行C" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dachenzi.github.io/post/7-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BBadmin%E7%AE%A1%E7%90%86%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5/" />

<meta itemprop="name" content="7-自定义类admin管理增删改查">
<meta itemprop="description" content="文章目录 1 django admin分析 2 django admin源码分析 2.1 注册部分 2.2 路由分发部分 2.3 流程总结 2.4 定制admin 3 django admin的接口 4 自定义ayra进行C">

<meta itemprop="wordCount" content="9776">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="7-自定义类admin管理增删改查"/>
<meta name="twitter:description" content="文章目录 1 django admin分析 2 django admin源码分析 2.1 注册部分 2.2 路由分发部分 2.3 流程总结 2.4 定制admin 3 django admin的接口 4 自定义ayra进行C"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">daxin.li's blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/post/">文章</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/categories/">类别</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="https://gohugo.io" rel="noopener" target="_blank">
              关于
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      daxin.li's blog
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/post/">文章</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://dachenzi.github.io/categories/">类别</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="https://gohugo.io" rel="noopener" target="_blank">
              关于
              
              <i class="iconfont">
                <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M623.36 272.96 473.216 423.04C467.2 429.056 467.072 438.656 472.896 444.416c0 0-6.72-6.656 1.6 1.6C496.064 467.648 528.64 500.224 528.64 500.224 534.464 506.048 544 505.856 550.016 499.904l150.08-150.144 67.328 66.432c9.024 8.96 27.456 4.544 30.4-8.96 19.968-92.608 46.656-227.52 46.656-227.52 6.848-34.496-16.192-56.704-49.92-49.92 0 0-134.656 26.816-227.328 46.784C560.32 178.048 556.352 182.272 554.752 187.136c-3.2 6.208-3.008 14.208 3.776 20.992L623.36 272.96z"></path>
  <path d="M841.152 457.152c-30.528 0-54.784 24.512-54.784 54.656l0 274.752L237.696 786.56 237.696 237.696l206.016 0c6.656 0 10.752 0 13.248 0C487.68 237.696 512 213.184 512 182.848 512 152.32 487.36 128 456.96 128L183.04 128C153.216 128 128 152.576 128 182.848c0 3.136 0.256 6.272 0.768 9.28C128.256 195.136 128 198.272 128 201.408l0 639.488c0 0.064 0 0.192 0 0.256 0 0.128 0 0.192 0 0.32 0 30.528 24.512 54.784 54.784 54.784l646.976 0c6.592 0 9.728 0 11.712 0 28.736 0 52.928-22.976 54.464-51.968C896 843.264 896 842.304 896 841.344l0-20.352L896 561.408 896 512.128C896 481.792 871.424 457.152 841.152 457.152z"></path>
</svg>

              </i>
            </a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">7-自定义类admin管理增删改查</h1>
      
      <div class="post-meta">
        <time datetime="0001-01-01" class="post-time">
          0001-01-01
        </time>
        
        <span class="more-meta"> 9776 words </span>
          <span class="more-meta"> 20 min read </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Table of Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#21-注册部分">2.1 注册部分</a></li>
    <li><a href="#22-路由分发部分">2.2 路由分发部分</a></li>
    <li><a href="#23-流程总结">2.3 流程总结</a></li>
    <li><a href="#24-定制admin">2.4 定制admin</a></li>
  </ul>

  <ul>
    <li><a href="#41-准备工作">4.1 准备工作</a>
      <ul>
        <li><a href="#411-文件加载顺序">4.1.1 文件加载顺序</a></li>
        <li><a href="#412-让我们的程序被优先加载">4.1.2 让我们的程序被优先加载</a></li>
        <li><a href="#413-编写调用文件">4.1.3 编写调用文件</a></li>
        <li><a href="#414-更换装载应用的方式">4.1.4 更换装载应用的方式</a></li>
        <li><a href="#415-include本质">4.1.5 include本质</a></li>
      </ul>
    </li>
    <li><a href="#42-为每个model对象生成对应的url">4.2 为每个model对象生成对应的url</a>
      <ul>
        <li><a href="#421-注册model类">4.2.1 注册model类</a></li>
        <li><a href="#422-servicearya基本实现">4.2.2 service/arya基本实现</a></li>
        <li><a href="#423-添加urls及views函数">4.2.3 添加urls及views函数</a></li>
      </ul>
    </li>
    <li><a href="#43-定制显示字段">4.3 定制显示字段</a></li>
    <li><a href="#44-删除编辑按钮">4.4 删除编辑按钮</a>
      <ul>
        <li><a href="#441-反向生成url">4.4.1 反向生成url</a></li>
        <li><a href="#442-抽离公共方法">4.4.2 抽离公共方法</a></li>
        <li><a href="#443-权限接口">4.4.3 权限接口</a></li>
      </ul>
    </li>
    <li><a href="#45-抽离页面显示配置">4.5 抽离页面显示配置</a></li>
    <li><a href="#46-添加页面实现">4.6 添加页面实现</a>
      <ul>
        <li><a href="#461-添加按钮">4.6.1 添加按钮</a></li>
        <li><a href="#462-添加页面">4.6.2 添加页面</a></li>
      </ul>
    </li>
    <li><a href="#47-编辑删除页面实现">4.7 编辑/删除页面实现</a></li>
    <li><a href="#48-模糊搜素">4.8 模糊搜素</a></li>
    <li><a href="#49-定制action下拉功能框">4.9 定制action下拉功能框</a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <p><font size=5 face='微软雅黑'><strong>文章目录</strong></font></p>
<!-- TOC -->
<ul>
<li><a href="#1-django-admin%E5%88%86%E6%9E%90">1 django admin分析</a></li>
<li><a href="#2-django-admin%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">2 django admin源码分析</a>
<ul>
<li><a href="#21-%E6%B3%A8%E5%86%8C%E9%83%A8%E5%88%86">2.1 注册部分</a></li>
<li><a href="#22-%E8%B7%AF%E7%94%B1%E5%88%86%E5%8F%91%E9%83%A8%E5%88%86">2.2 路由分发部分</a></li>
<li><a href="#23-%E6%B5%81%E7%A8%8B%E6%80%BB%E7%BB%93">2.3 流程总结</a></li>
<li><a href="#24-%E5%AE%9A%E5%88%B6admin">2.4 定制admin</a></li>
</ul>
</li>
<li><a href="#3-django-admin%E7%9A%84%E6%8E%A5%E5%8F%A3">3 django admin的接口</a></li>
<li><a href="#4-%E8%87%AA%E5%AE%9A%E4%B9%89ayra%E8%BF%9B%E8%A1%8Ccrud">4 自定义ayra进行CRUD</a>
<ul>
<li><a href="#41-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">4.1 准备工作</a>
<ul>
<li><a href="#411-%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E9%A1%BA%E5%BA%8F">4.1.1 文件加载顺序</a></li>
<li><a href="#412-%E8%AE%A9%E6%88%91%E4%BB%AC%E7%9A%84%E7%A8%8B%E5%BA%8F%E8%A2%AB%E4%BC%98%E5%85%88%E5%8A%A0%E8%BD%BD">4.1.2 让我们的程序被优先加载</a></li>
<li><a href="#413-%E7%BC%96%E5%86%99%E8%B0%83%E7%94%A8%E6%96%87%E4%BB%B6">4.1.3 编写调用文件</a></li>
<li><a href="#414-%E6%9B%B4%E6%8D%A2%E8%A3%85%E8%BD%BD%E5%BA%94%E7%94%A8%E7%9A%84%E6%96%B9%E5%BC%8F">4.1.4 更换装载应用的方式</a></li>
<li><a href="#415-include%E6%9C%AC%E8%B4%A8">4.1.5 include本质</a></li>
</ul>
</li>
<li><a href="#42-%E4%B8%BA%E6%AF%8F%E4%B8%AAmodel%E5%AF%B9%E8%B1%A1%E7%94%9F%E6%88%90%E5%AF%B9%E5%BA%94%E7%9A%84url">4.2 为每个model对象生成对应的url</a>
<ul>
<li><a href="#421-%E6%B3%A8%E5%86%8Cmodel%E7%B1%BB">4.2.1 注册model类</a></li>
<li><a href="#422-servicearya%E5%9F%BA%E6%9C%AC%E5%AE%9E%E7%8E%B0">4.2.2 service/arya基本实现</a></li>
<li><a href="#423-%E6%B7%BB%E5%8A%A0urls%E5%8F%8Aviews%E5%87%BD%E6%95%B0">4.2.3 添加urls及views函数</a></li>
</ul>
</li>
<li><a href="#43-%E5%AE%9A%E5%88%B6%E6%98%BE%E7%A4%BA%E5%AD%97%E6%AE%B5">4.3 定制显示字段</a></li>
<li><a href="#44-%E5%88%A0%E9%99%A4%E7%BC%96%E8%BE%91%E6%8C%89%E9%92%AE">4.4 删除编辑按钮</a>
<ul>
<li><a href="#441-%E5%8F%8D%E5%90%91%E7%94%9F%E6%88%90url">4.4.1 反向生成url</a></li>
<li><a href="#442-%E6%8A%BD%E7%A6%BB%E5%85%AC%E5%85%B1%E6%96%B9%E6%B3%95">4.4.2 抽离公共方法</a></li>
<li><a href="#443-%E6%9D%83%E9%99%90%E6%8E%A5%E5%8F%A3">4.4.3 权限接口</a></li>
</ul>
</li>
<li><a href="#45-%E6%8A%BD%E7%A6%BB%E9%A1%B5%E9%9D%A2%E6%98%BE%E7%A4%BA%E9%85%8D%E7%BD%AE">4.5 抽离页面显示配置</a></li>
<li><a href="#46-%E6%B7%BB%E5%8A%A0%E9%A1%B5%E9%9D%A2%E5%AE%9E%E7%8E%B0">4.6 添加页面实现</a>
<ul>
<li><a href="#461-%E6%B7%BB%E5%8A%A0%E6%8C%89%E9%92%AE">4.6.1 添加按钮</a></li>
<li><a href="#462-%E6%B7%BB%E5%8A%A0%E9%A1%B5%E9%9D%A2">4.6.2 添加页面</a></li>
</ul>
</li>
<li><a href="#47-%E7%BC%96%E8%BE%91%E5%88%A0%E9%99%A4%E9%A1%B5%E9%9D%A2%E5%AE%9E%E7%8E%B0">4.7 编辑/删除页面实现</a></li>
<li><a href="#48-%E6%A8%A1%E7%B3%8A%E6%90%9C%E7%B4%A0">4.8 模糊搜素</a></li>
<li><a href="#49-%E5%AE%9A%E5%88%B6action%E4%B8%8B%E6%8B%89%E5%8A%9F%E8%83%BD%E6%A1%86">4.9 定制action下拉功能框</a></li>
</ul>
</li>
</ul>
<!-- /TOC -->
<h1 id="1-django-admin分析">1 django admin分析</h1>
<p>在每个app下都会存在一个admin.py文件用于注册当前app下的models文件，给django admin来管理，仔细观察Django admin针对不同models的管理页面、URL等信息，我们发现</p>
<ol>
<li>不同的类对象生成的url是类似的。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># UserInfo</span>
<span class="o">/</span><span class="n">admin</span><span class="o">/</span><span class="n">app01</span><span class="o">/</span><span class="n">userindo</span><span class="o">/</span>
<span class="o">/</span><span class="n">admin</span><span class="o">/</span><span class="n">app01</span><span class="o">/</span><span class="n">userinfo</span><span class="o">/</span><span class="n">add</span>
<span class="o">/</span><span class="n">admin</span><span class="o">/</span><span class="n">app01</span><span class="o">/</span><span class="n">userinfo</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="n">change</span>
<span class="o">/</span><span class="n">admin</span><span class="o">/</span><span class="n">app01</span><span class="o">/</span><span class="n">userinfo</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">delete</span>
<span class="c1"># Role</span>
<span class="o">/</span><span class="n">admin</span><span class="o">/</span><span class="n">role</span><span class="o">/</span>
<span class="o">/</span><span class="n">admin</span><span class="o">/</span><span class="n">role</span><span class="o">/</span><span class="n">add</span>
<span class="o">/</span><span class="n">admin</span><span class="o">/</span><span class="n">role</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="n">change</span>
<span class="o">/</span><span class="n">admin</span><span class="o">/</span><span class="n">role</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">delete</span>
</code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>不同的类，页面的布局模版也是类似的。
所以，我们分析，admin内部应该是为我们的注册的类，生成了对应的url，以及视图函数，并且通过相同的模版渲染来返回页面的。下面来跟一下源码文件</li>
</ol>
<h1 id="2-django-admin源码分析">2 django admin源码分析</h1>
<h2 id="21-注册部分">2.1 注册部分</h2>
<p>首先从注册开始，看下我们的admin.py文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Userinfo</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>注册是通过site的register方法完成的，那么从这个入口开始看它内部是怎么完成的：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">site</span> <span class="o">=</span> <span class="n">AdminSite</span><span class="p">()</span> 
</code></pre></td></tr></table>
</div>
</div><p>查看他的register方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"> <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_or_iterable</span><span class="p">,</span> <span class="n">admin_class</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="o">...</span> <span class="o">...</span> 
    <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="p">[</span><span class="n">model</span><span class="p">]</span> <span class="o">=</span> <span class="n">admin_class</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>内部把我们的model类使用字典存储起来(self._registry = {}),而admin_class默认情况下的值为ModelAdmin</p>
<h2 id="22-路由分发部分">2.2 路由分发部分</h2>
<p>查看项目的urls.py文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></td></tr></table>
</div>
</div><p>这里的site和admin.py里的site是同一个对象,而在urls代码内部调用了get_urls方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"> <span class="k">def</span> <span class="nf">get_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="o">...</span> <span class="o">...</span>
        <span class="n">valid_app_labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">model</span><span class="p">,</span> <span class="n">model_admin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_registry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">urlpatterns</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span><span class="p">),</span> <span class="n">include</span><span class="p">(</span><span class="n">model_admin</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
            <span class="p">]</span>
</code></pre></td></tr></table>
</div>
</div><p>内部为每一个model类封装了一个url(inclue)路由：</p>
<ul>
<li>model._meta.app_label:就是app的名称</li>
<li>model._meta.model_name：就是model的名称
最后调用的是model_admin的urls方法，其实也就是封装的ModelAdmin对象的urls方法</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python">    <span class="k">def</span> <span class="nf">get_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
        <span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changelist_view</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_changelist&#39;</span> <span class="o">%</span> <span class="n">info</span><span class="p">),</span>
            <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^add/$&#39;</span><span class="p">,</span> <span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_view</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_add&#39;</span> <span class="o">%</span> <span class="n">info</span><span class="p">),</span>
            <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(.+)/history/$&#39;</span><span class="p">,</span> <span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history_view</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_history&#39;</span> <span class="o">%</span> <span class="n">info</span><span class="p">),</span>
            <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(.+)/delete/$&#39;</span><span class="p">,</span> <span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delete_view</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_delete&#39;</span> <span class="o">%</span> <span class="n">info</span><span class="p">),</span>
            <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(.+)/change/$&#39;</span><span class="p">,</span> <span class="n">wrap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">change_view</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_change&#39;</span> <span class="o">%</span> <span class="n">info</span><span class="p">),</span>
            <span class="c1"># For backwards compatibility (was the change url before 1.9)</span>
            <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(.+)/$&#39;</span><span class="p">,</span> <span class="n">wrap</span><span class="p">(</span><span class="n">RedirectView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span>
                <span class="n">pattern_name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_change&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">admin_site</span><span class="o">.</span><span class="n">name</span><span class="p">,)</span> <span class="o">+</span> <span class="n">info</span><span class="p">)</span>
            <span class="p">))),</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">urlpatterns</span>
</code></pre></td></tr></table>
</div>
</div><p>这里才是，为每个model类生成的url列表，对应的就是处理方法。</p>
<h2 id="23-流程总结">2.3 流程总结</h2>
<p>整个流程如下：</p>
<ol>
<li>site 是一个 AdminSite()对象</li>
<li>查看AdminSite()对象的register方法，使用字典封装了我们的model类{model类,ModelAdmin(model类，site对象)}</li>
<li>访问urls时，admin为每个model类创建一个以'/app名称/model类名&rsquo;为前缀的url</li>
<li>映射到包装好的ModelAdmin对象的get_url方法内</li>
<li>在内部为CRUD操作，定义了url列表以及对应的views方法。</li>
</ol>
<h2 id="24-定制admin">2.4 定制admin</h2>
<p>根据分析，我们知道，真正完成数据库的增删改查的任务，其实是ModelAdmin对象，而在我们注册我们的model时，django提供了一个额外的参数admin_class，用于让我们定制自己的admin。
所以，我们可以通过继承ModelAdmin来定制，比如</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.contrib.admin.options</span> <span class="kn">import</span> <span class="n">ModelAdmin</span>
<span class="k">class</span> <span class="nc">MyModelAdmin</span><span class="p">(</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">changelist_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">extra_context</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HTTPResponse</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Permission</span><span class="p">,</span> <span class="n">admin_class</span><span class="o">=</span><span class="n">MyModelAdmin</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>这样，Permission表的，list页面就会被我们修改。</p>
<h1 id="3-django-admin的接口">3 django admin的接口</h1>
<p>上面的方法比较麻烦，django admin提供了不少接口和参数用于控制admin页面的展示
定制Admin
在admin.py中只需要讲Mode中的某个类注册，即可在Admin中实现增删改查的功能，如：
admin.site.register(models.UserInfo)
但是，这种方式比较简单，如果想要进行更多的定制操作，需要利用ModelAdmin进行操作，如：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="err">方式一：</span>
    <span class="k">class</span> <span class="nc">UserAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
        <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;pwd&#39;</span><span class="p">,)</span>
 
    <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">,</span> <span class="n">UserAdmin</span><span class="p">)</span> <span class="c1"># 第一个参数可以是列表</span>
     
 
<span class="err">方式二：</span>
    <span class="nd">@admin.register</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">)</span>                <span class="c1"># 第一个参数可以是列表</span>
    <span class="k">class</span> <span class="nc">UserAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
        <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;pwd&#39;</span><span class="p">,)</span>
</code></pre></td></tr></table>
</div>
</div><p>ModelAdmin中提供了大量的可定制功能，如</p>
<ol>
<li>list_display，列表时，定制显示的列。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@admin.register</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UserAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;pwd&#39;</span><span class="p">,</span> <span class="s1">&#39;xxxxx&#39;</span><span class="p">)</span>
 
    <span class="k">def</span> <span class="nf">xxxxx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&#34;xxxxx&#34;</span>
</code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>list_display_links，列表时，定制列可以点击跳转。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@admin.register</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UserAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;pwd&#39;</span><span class="p">,</span> <span class="s1">&#39;xxxxx&#39;</span><span class="p">)</span>
    <span class="n">list_display_links</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;pwd&#39;</span><span class="p">,)</span>
</code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>list_filter，列表时，定制右侧快速筛选。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext_lazy</span> <span class="k">as</span> <span class="n">_</span>
 
<span class="nd">@admin.register</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UserAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;pwd&#39;</span><span class="p">)</span>
 
    <span class="k">class</span> <span class="nc">Ugg</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">SimpleListFilter</span><span class="p">):</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;decade born&#39;</span><span class="p">)</span>
        <span class="n">parameter_name</span> <span class="o">=</span> <span class="s1">&#39;xxxxxx&#39;</span>
 
        <span class="k">def</span> <span class="nf">lookups</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">model_admin</span><span class="p">):</span>
            <span class="s2">&#34;&#34;&#34;
</span><span class="s2">            显示筛选选项
</span><span class="s2">            :param request:
</span><span class="s2">            :param model_admin:
</span><span class="s2">            :return:
</span><span class="s2">            &#34;&#34;&#34;</span>
            <span class="k">return</span> <span class="n">models</span><span class="o">.</span><span class="n">UserGroup</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">)</span>
 
        <span class="k">def</span> <span class="nf">queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
            <span class="s2">&#34;&#34;&#34;
</span><span class="s2">            点击查询时，进行筛选
</span><span class="s2">            :param request:
</span><span class="s2">            :param queryset:
</span><span class="s2">            :return:
</span><span class="s2">            &#34;&#34;&#34;</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ug</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
 
    <span class="n">list_filter</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="n">Ugg</span><span class="p">,)</span>
</code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>list_select_related，列表时，连表查询是否自动select_related</li>
<li>分页相关</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># 分页，每页显示条数</span>
    <span class="n">list_per_page</span> <span class="o">=</span> <span class="mi">100</span>
 
<span class="c1"># 分页，显示全部（真实数据&lt;该值时，才会有显示全部）</span>
    <span class="n">list_max_show_all</span> <span class="o">=</span> <span class="mi">200</span>
 
<span class="c1"># 分页插件</span>
    <span class="n">paginator</span> <span class="o">=</span> <span class="n">Paginator</span>
</code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>list_editable，列表时，可以编辑的列</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@admin.register</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UserAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;pwd&#39;</span><span class="p">,</span><span class="s1">&#39;ug&#39;</span><span class="p">,)</span>
    <span class="n">list_editable</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;ug&#39;</span><span class="p">,)</span>
</code></pre></td></tr></table>
</div>
</div><ol start="7">
<li>search_fields，列表时，模糊搜索的功能</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@admin.register</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UserAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
     
    <span class="n">search_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;pwd&#39;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><ol start="8">
<li>date_hierarchy，列表时，对Date和DateTime类型进行搜索</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@admin.register</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UserAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
 
    <span class="n">date_hierarchy</span> <span class="o">=</span> <span class="s1">&#39;ctime&#39;</span>
</code></pre></td></tr></table>
</div>
</div><ol start="9">
<li>preserve_filters，详细页面，删除、修改，更新后跳转回列表后，是否保留原搜索条件</li>
<li>save_as = False，详细页面，按钮为“Sava as new” 或 “Sava and add another”</li>
<li>save_as_continue = True，点击保存并继续编辑</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">save_as_continue</span> <span class="o">=</span> <span class="bp">True</span>
 
<span class="c1"># 如果 save_as=True，save_as_continue = True， 点击Sava as new 按钮后继续编辑。</span>
<span class="c1"># 如果 save_as=True，save_as_continue = False，点击Sava as new 按钮后返回列表。</span>
 
<span class="n">New</span> <span class="ow">in</span> <span class="n">Django</span> <span class="mf">1.10</span><span class="o">.</span>
</code></pre></td></tr></table>
</div>
</div><ol start="12">
<li>save_on_top = False，详细页面，在页面上方是否也显示保存删除等按钮</li>
<li>inlines，详细页面，如果有其他表和当前表做FK，那么详细页面可以进行动态增加和删除</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">UserInfoInline</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">StackedInline</span><span class="p">):</span> <span class="c1"># TabularInline</span>
    <span class="n">extra</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
 
 
<span class="k">class</span> <span class="nc">GroupAdminMode</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,)</span>
    <span class="n">inlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">UserInfoInline</span><span class="p">,</span> <span class="p">]</span>
</code></pre></td></tr></table>
</div>
</div><ol start="14">
<li>action，列表时，定制action中的操作</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@admin.register</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UserAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
 
    <span class="c1"># 定制Action行为具体方法</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;_selected_action&#39;</span><span class="p">))</span>
 
    <span class="n">func</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s2">&#34;中文显示自定义Actions&#34;</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="n">func</span><span class="p">,</span> <span class="p">]</span>
 
    <span class="c1"># Action选项都是在页面上方显示</span>
    <span class="n">actions_on_top</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c1"># Action选项都是在页面下方显示</span>
    <span class="n">actions_on_bottom</span> <span class="o">=</span> <span class="bp">False</span>
 
    <span class="c1"># 是否显示选择个数</span>
    <span class="n">actions_selection_counter</span> <span class="o">=</span> <span class="bp">True</span>
</code></pre></td></tr></table>
</div>
</div><ol start="15">
<li>定制HTML模板</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">add_form_template</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">change_form_template</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">change_list_template</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">delete_confirmation_template</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">delete_selected_confirmation_template</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">object_history_template</span> <span class="o">=</span> <span class="bp">None</span>
</code></pre></td></tr></table>
</div>
</div><ol start="16">
<li>raw_id_fields，详细页面，针对FK和M2M字段变成以Input框形式</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@admin.register</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UserAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
 
    <span class="n">raw_id_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;FK字段&#39;</span><span class="p">,</span> <span class="s1">&#39;M2M字段&#39;</span><span class="p">,)</span>
</code></pre></td></tr></table>
</div>
</div><ol start="17">
<li>fields，详细页面时，显示字段的字段</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@admin.register</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UserAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,)</span>
</code></pre></td></tr></table>
</div>
</div><ol start="18">
<li>exclude，详细页面时，排除的字段</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@admin.register</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UserAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">exclude</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,)</span>
</code></pre></td></tr></table>
</div>
</div><ol start="19">
<li>readonly_fields，详细页面时，只读字段</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@admin.register</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UserAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">readonly_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,)</span>
</code></pre></td></tr></table>
</div>
</div><ol start="20">
<li>fieldsets，详细页面时，使用fieldsets标签对数据进行分割显示</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@admin.register</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UserAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">fieldsets</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;基本数据&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;fields&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;pwd&#39;</span><span class="p">,</span> <span class="s1">&#39;ctime&#39;</span><span class="p">,)</span>
        <span class="p">}),</span>
        <span class="p">(</span><span class="s1">&#39;其他&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s1">&#39;classes&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;collapse&#39;</span><span class="p">,</span> <span class="s1">&#39;wide&#39;</span><span class="p">,</span> <span class="s1">&#39;extrapretty&#39;</span><span class="p">),</span>  <span class="c1"># &#39;collapse&#39;,&#39;wide&#39;, &#39;extrapretty&#39;</span>
            <span class="s1">&#39;fields&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;pwd&#39;</span><span class="p">),</span>
        <span class="p">}),</span>
    <span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><ol start="21">
<li>详细页面时，M2M显示时，数据移动选择（方向：上下和左右）</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@admin.register</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UserAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">filter_vertical</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&#34;m2m字段&#34;</span><span class="p">,)</span> <span class="c1"># 或filter_horizontal = (&#34;m2m字段&#34;,)</span>
</code></pre></td></tr></table>
</div>
</div><ol start="22">
<li>ordering，列表时，数据排序规则</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@admin.register</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UserAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;-id&#39;</span><span class="p">,)</span>
    <span class="err">或</span>
    <span class="k">def</span> <span class="nf">get_ordering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;-id&#39;</span><span class="p">,</span> <span class="p">]</span>
</code></pre></td></tr></table>
</div>
</div><ol start="23">
<li>view_on_site，编辑时，是否在页面上显示view on set</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">view_on_site</span> <span class="o">=</span> <span class="bp">False</span>
<span class="err">或</span>
<span class="k">def</span> <span class="nf">view_on_site</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;https://www.baidu.com&#39;</span>
</code></pre></td></tr></table>
</div>
</div><ol start="24">
<li>radio_fields，详细页面时，使用radio显示选项（FK默认使用select）</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">radio_fields</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;ug&#34;</span><span class="p">:</span> <span class="n">admin</span><span class="o">.</span><span class="n">VERTICAL</span><span class="p">}</span> <span class="c1"># 或admin.HORIZONTAL</span>
</code></pre></td></tr></table>
</div>
</div><ol start="25">
<li>show_full_result_count = True，列表时，模糊搜索后面显示的数据个数样式</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@admin.register</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UserAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="c1"># show_full_result_count = True # 1 result (12 total)</span>
    <span class="c1"># show_full_result_count = False  # 1 result (Show all)</span>
    <span class="n">search_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,)</span>
</code></pre></td></tr></table>
</div>
</div><ol start="26">
<li>formfield_overrides = {}，详细页面时，指定现实插件</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.forms</span> <span class="kn">import</span> <span class="n">widgets</span>
<span class="kn">from</span> <span class="nn">django.utils.html</span> <span class="kn">import</span> <span class="n">format_html</span>
 
<span class="k">class</span> <span class="nc">MyTextarea</span><span class="p">(</span><span class="n">widgets</span><span class="o">.</span><span class="n">Widget</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># Use slightly better defaults than HTML&#39;s 20x2 box</span>
        <span class="n">default_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cols&#39;</span><span class="p">:</span> <span class="s1">&#39;40&#39;</span><span class="p">,</span> <span class="s1">&#39;rows&#39;</span><span class="p">:</span> <span class="s1">&#39;10&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">default_attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MyTextarea</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">default_attrs</span><span class="p">)</span>
 
    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">final_attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_attrs</span><span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">format_html</span><span class="p">(</span><span class="s1">&#39;&lt;textarea {}&gt;</span><span class="se">\r\n</span><span class="s1">{}&lt;/textarea&gt;&#39;</span><span class="p">,</span><span class="n">final_attrs</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
 
 
 
<span class="nd">@admin.register</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UserAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
 
    <span class="n">formfield_overrides</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">models</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;widget&#39;</span><span class="p">:</span> <span class="n">MyTextarea</span><span class="p">},</span>
    <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><ol start="27">
<li>prepopulated_fields = {}，添加页面，当在某字段填入值后，自动会将值填充到指定字段。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@admin.register</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UserAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
 
    <span class="n">prepopulated_fields</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;email&#34;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&#34;user&#34;</span><span class="p">,</span><span class="s2">&#34;pwd&#34;</span><span class="p">,)}</span>
<span class="n">PS</span><span class="p">:</span> <span class="n">DjangoAdmin中使用js实现功能</span><span class="err">，页面</span><span class="n">email字段的值会在输入</span><span class="err">：</span><span class="n">user</span><span class="err">、</span><span class="n">pwd时自动填充</span>
</code></pre></td></tr></table>
</div>
</div><ol start="28">
<li>form = ModelForm，用于定制用户请求时候表单验证</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">app01</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.forms</span> <span class="kn">import</span> <span class="n">ModelForm</span>
<span class="kn">from</span> <span class="nn">django.forms</span> <span class="kn">import</span> <span class="n">fields</span>
 
 
<span class="k">class</span> <span class="nc">MyForm</span><span class="p">(</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="n">others</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">CharField</span><span class="p">()</span>
 
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="s2">&#34;__all__&#34;</span>
 
<span class="nd">@admin.register</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UserAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
 
    <span class="n">form</span> <span class="o">=</span> <span class="n">MyForm</span>
</code></pre></td></tr></table>
</div>
</div><ol start="29">
<li>empty_value_display = &ldquo;列数据为空时，显示默认值&rdquo;</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="nd">@admin.register</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">UserInfo</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">UserAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">empty_value_display</span> <span class="o">=</span> <span class="s2">&#34;列数据为空时，默认显示&#34;</span>
 
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="s1">&#39;pwd&#39;</span><span class="p">,</span><span class="s1">&#39;up&#39;</span><span class="p">)</span>
 
    <span class="k">def</span> <span class="nf">up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">user</span>
    <span class="n">up</span><span class="o">.</span><span class="n">empty_value_display</span> <span class="o">=</span> <span class="s2">&#34;指定列数据为空时，默认显示&#34;</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="4-自定义ayra进行crud">4 自定义ayra进行CRUD</h1>
<p>django admin的功能比较强大，比较重，我们可以自己写一个轻量级的类admin的管理工具。</p>
<h2 id="41-准备工作">4.1 准备工作</h2>
<h3 id="411-文件加载顺序">4.1.1 文件加载顺序</h3>
<p>分析djando admin的代码我们知道，在请求进来之前，我们注册的model就已经被包装好了，所以admin.py这个文件是最先被加载的，然后才才可以创建url，完成url的映射</p>
<h3 id="412-让我们的程序被优先加载">4.1.2 让我们的程序被优先加载</h3>
<p>每个应用下的admin.py总是在应用启动的时候就被加载了，我们的程序如何加载呢。观察admin的源码我们发现其内部有一个：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">autodiscover</span><span class="p">():</span>
    <span class="n">autodiscover_modules</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="n">register_to</span><span class="o">=</span><span class="n">site</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>这个方法看名字是自动发现，并加载模块的。它是在哪里调用了呢,通过查看源码，我们发现在django.contrib.admin.apps下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python">
<span class="k">class</span> <span class="nc">AdminConfig</span><span class="p">(</span><span class="n">SimpleAdminConfig</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34;The default AppConfig for admin which does autodiscovery.&#34;&#34;&#34;</span>

    <span class="k">def</span> <span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AdminConfig</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">ready</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">.</span><span class="n">autodiscover</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><p>ready方法调用了autodiscover.</p>
<h3 id="413-编写调用文件">4.1.3 编写调用文件</h3>
<p>知道了怎么被调用的，那么我们先来在每个app下定义一个ayra文件.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># arya.py</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;被加载了&#39;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>然后我们创建一个arya app，然后在他的apps.py文件中做如下修改</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">AryaConfig</span><span class="p">(</span><span class="n">AppConfig</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;arya&#39;</span>

    <span class="k">def</span> <span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">django.utils.module_loading</span> <span class="kn">import</span> <span class="n">autodiscover_modules</span>
        <span class="n">autodiscover_modules</span><span class="p">(</span><span class="s1">&#39;arya&#39;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="414-更换装载应用的方式">4.1.4 更换装载应用的方式</h3>
<p>在settings.py重，更换下面的导入方式</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;django.contrib.admin&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>
    <span class="s1">&#39;arya.apps.AryaConfig&#39;</span><span class="p">,</span>    <span class="c1"># 通过app来导入（顺序无所谓）</span>
    <span class="s1">&#39;rbac&#39;</span><span class="p">,</span>
    <span class="s1">&#39;main&#39;</span><span class="p">,</span>
<span class="p">]</span>
</code></pre></td></tr></table>
</div>
</div><p>这样，准备工作就做好了，启动的django的时候，同时也会加载每个项目目录下的arya.py 文件了</p>
<h3 id="415-include本质">4.1.5 include本质</h3>
<p>观察include源码，我们知道include是一个函数，最后返回的是<code>一个三元组</code>，通过观察源码，可以的指导它们代表的值是：</p>
<ul>
<li>urlconf_module：url列表</li>
<li>app_name：None</li>
<li>namespace：None（这里的namespace，就是在反向生成url的时候，标识当前的url的,在反响生成时，需要使用reverse(namespce:name) 来生成。</li>
</ul>
<p>所以，不使用include时，我们可以有如下操作来分发路由</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># 测试代码</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">HttpResponse</span>

<span class="k">def</span> <span class="nf">test1</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;test1&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test2</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;test2&#39;</span><span class="p">)</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^login/&#39;</span><span class="p">,</span> <span class="n">main</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">login</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^index/&#39;</span><span class="p">,</span> <span class="n">main</span><span class="o">.</span><span class="n">views</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
    <span class="c1"># url(r&#39;^rbac/&#39;, include(&#39;rbac.urls&#39;)) # 等于下面的</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;rbac/&#39;</span><span class="p">,</span> <span class="p">([</span>
                       <span class="n">url</span><span class="p">(</span><span class="s1">&#39;user/info&#39;</span><span class="p">,</span> <span class="n">test1</span><span class="p">),</span>
                       <span class="n">url</span><span class="p">(</span><span class="s1">&#39;user/add&#39;</span><span class="p">,</span> <span class="p">([</span>
                                            <span class="n">url</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="n">test2</span><span class="p">),</span>
                                        <span class="p">],</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)),</span>
                   <span class="p">],</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
<span class="p">]</span>
</code></pre></td></tr></table>
</div>
</div><p>看起来有些杂乱，分析一下产生的url</p>
<ol>
<li>/rbac/user/info 对应test1</li>
<li>/rbac/user/add/list 对应test2</li>
</ol>
<p>这就是include的本质</p>
<h2 id="42-为每个model对象生成对应的url">4.2 为每个model对象生成对应的url</h2>
<p>根据django admin的源码的编写方式，我们来模仿一下，用于动态的生成对应的urls。创建arya app，然后创建service模块，用于存放arya.py文件，在该文件内部编写主要实现逻辑</p>
<h3 id="421-注册model类">4.2.1 注册model类</h3>
<p>首先在每一个app下的arya.py中，模仿admin的方式，注册model类</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">arya.service</span> <span class="kn">import</span> <span class="n">arya</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">arya</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Userinfo</span><span class="p">,</span> <span class="n">arya</span><span class="o">.</span><span class="n">AryaConfig</span><span class="p">)</span>
<span class="n">arya</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Permission</span><span class="p">,</span> <span class="n">arya</span><span class="o">.</span><span class="n">AryaConfig</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>不同的app中调用的是相同的site对象，一般称它为单例模式，并且它存在一个register方法，通过了解admin的源码， 我们知道它包含两个参数，一个是model类，还有一个是默认的一个类对象。</p>
<h3 id="422-servicearya基本实现">4.2.2 service/arya基本实现</h3>
<p>根据上一部的分析，注册功能就实现了，我们的arya如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">HttpResponse</span>

<span class="c1"># 根据admin site的源码实现</span>
<span class="k">class</span> <span class="nc">AryaConfig</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">site</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span> <span class="o">=</span> <span class="n">model_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site</span> <span class="o">=</span> <span class="n">site</span>

<span class="c1"># 根据admin site的源码实现</span>
<span class="k">class</span> <span class="nc">AryaSite</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">arya_class</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register</span><span class="p">[</span><span class="n">model_class</span><span class="p">]</span> <span class="o">=</span> <span class="n">arya_class</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span> <span class="c1"># 接受两个参数</span>

<span class="c1"># 单例模式</span>
<span class="n">site</span> <span class="o">=</span> <span class="n">AryaSite</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="423-添加urls及views函数">4.2.3 添加urls及views函数</h3>
<p>下面从入口继续编写：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># 项目的urls.py文件</span>
<span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^arya/&#39;</span><span class="p">,</span><span class="n">arya</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>根据前面include的本质，和adjango admin的源码我们知道，这里的url返回的是一个三元组，即[],None,None。列表就是urlpatterns</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># service/arya.py</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">HttpResponse</span>

<span class="k">class</span> <span class="nc">AryaConfig</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">site</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span> <span class="o">=</span> <span class="n">model_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site</span> <span class="o">=</span> <span class="n">site</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">urls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>

        <span class="c1"># 为不同的model对象，生成不同的urls</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">changelist_view</span><span class="p">),</span>
            <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^add/&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_view</span><span class="p">),</span>
            <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(\d+)/change/&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_view</span><span class="p">),</span>
            <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(\d+)/delete/&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_view</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">patterns</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>   <span class="c1"># 必须返回三元组</span>

    <span class="c1"># 真正处理CRUD的 views函数</span>
    <span class="k">def</span> <span class="nf">changelist_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;列表页面&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;增加页面&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">change_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;修改页面&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;删除页面&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AryaSite</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;执行了&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">arya_class</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register</span><span class="p">[</span><span class="n">model_class</span><span class="p">]</span> <span class="o">=</span> <span class="n">arya_class</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># 为不同modellei 生成不同的include对象，包含CRUD的urls</span>
        <span class="k">for</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">arya_class</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">url</span><span class="p">(</span><span class="s1">&#39;^{}/{}/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span><span class="p">),</span> <span class="n">arya_class</span><span class="o">.</span><span class="n">urls</span><span class="p">)</span>
            <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">patterns</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>

<span class="n">site</span> <span class="o">=</span> <span class="n">AryaSite</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>注意：urls路径匹配结尾处，要添加/</p>
</blockquote>
<p>为什么要保存model呢？ 观察上面的views函数，内部存在model类对象的话，是不是就可以进行CRUD了呢？配上一个templates模版，就可以完成页面渲染了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="43-定制显示字段">4.3 定制显示字段</h2>
<p>django admin可以通过定义list_display来控制显示的字段，我们也来实现一下类似的功能。</p>
<p>用户的使用方式：（模仿django admin）</p>
<ul>
<li>继承我们的AryaConfig</li>
<li>添加参数来定制要显示的字段</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">arya.service</span> <span class="kn">import</span> <span class="n">arya</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">django.utils.safestring</span> <span class="kn">import</span> <span class="n">mark_safe</span>


<span class="k">class</span> <span class="nc">UserConfig</span><span class="p">(</span><span class="n">arya</span><span class="o">.</span><span class="n">AryaConfig</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">title</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">code</span>

    <span class="k">def</span> <span class="nf">checkbox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">mark_safe</span><span class="p">(</span><span class="s1">&#39;&lt;input type=&#34;checkbox&#34; value={}/&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

    <span class="c1"># mark_safe在后段对生成的html进行安全格式化，这里的obj，就是传入的每个model对象</span>
    <span class="k">def</span> <span class="nf">button</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">obj</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">mark_safe</span><span class="p">(</span><span class="s1">&#39;&lt;button value={} &gt;编辑&lt;/button&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

    <span class="n">list_display</span> <span class="o">=</span> <span class="p">[</span><span class="n">checkbox</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span><span class="n">button</span><span class="p">]</span>

<span class="n">arya</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Permission</span><span class="p">,</span> <span class="n">UserConfig</span><span class="p">)</span>  <span class="c1"># Permission类使用我们定制的类</span>
<span class="n">arya</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Userinfo</span><span class="p">,</span> <span class="n">arya</span><span class="o">.</span><span class="n">AryaConfig</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>那么 必然需要在，我们的 AryaConfig类 中定义这个参数，并对该参数做一些显示方面的逻辑。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># 修改AryaConfig</span>
    <span class="k">def</span> <span class="nf">changelist_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>

        <span class="n">data_query_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_query_set</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_display</span><span class="p">:</span>
                <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">col_or_func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_display</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col_or_func</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">props</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">col_or_func</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col_or_func</span><span class="p">,</span><span class="n">Callable</span><span class="p">):</span>
                        <span class="n">props</span> <span class="o">=</span> <span class="n">col_or_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
                <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">data_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;changelist.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;data_list&#39;</span><span class="p">:</span> <span class="n">data_list</span><span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>上面的代码主要构建了一个两层结构</p>
<ul>
<li>当list_display是一个空列表时，结构为[[obj1,],[obj2,],[obj3,]&hellip;]</li>
<li>当list_display有值时，结构为[[&lsquo;字段1&rsquo;,&lsquo;字段2&rsquo;],[&lsquo;字段1&rsquo;,&lsquo;字段2&rsquo;],[&lsquo;字段1&rsquo;,&lsquo;字段2&rsquo;]&hellip;]</li>
</ul>
<p>并且针对字段做了优化，如果传入的是一个函数，那么将函数的执行结果当作字段进行显示，这样构建嵌套结构在模版渲染的同时，可以方便的使用两层循环，进行数据渲染。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># templates 模版文件changelist.html</span>
<span class="o">&lt;</span><span class="err">!</span><span class="n">DOCTYPE</span> <span class="n">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">html</span> <span class="n">lang</span><span class="o">=</span><span class="s2">&#34;en&#34;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">meta</span> <span class="n">charset</span><span class="o">=</span><span class="s2">&#34;UTF-8&#34;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">Title</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">table</span> <span class="n">border</span><span class="o">=</span><span class="s2">&#34;1&#34;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">tbody</span><span class="o">&gt;</span>   <span class="c1"># 两层循环结构</span>
    <span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_list</span> <span class="o">%</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="n">tr</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span> <span class="o">%</span><span class="p">}</span>  
                <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">item</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
        <span class="o">&lt;/</span><span class="n">tr</span><span class="o">&gt;</span>
    <span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
    <span class="o">&lt;/</span><span class="n">tbody</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">table</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="44-删除编辑按钮">4.4 删除编辑按钮</h2>
<p>定制显示字段的同时，我们其实就已经实现了动态添加删除/编辑按钮了，但是有一些问题，比如：</p>
<ol>
<li>添加删除的url如何生成</li>
<li>能否预留一些接口，可以结合权限系统，如果有删除权限，就显示删除按钮等。</li>
</ol>
<h3 id="441-反向生成url">4.4.1 反向生成url</h3>
<p>我们知道通过include做url分发时，可以指定一个namespce关键字，用于标识当前url，在子url中，可以指定name关键字，来指定当前的url，而把二者结合只需要使用&quot;namespace:name&quot;即可。</p>
<p>所以修改我们的代码，添加namespace和name关键字</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># service/arya.py</span>
<span class="k">class</span> <span class="nc">AryaSite</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">arya_class</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_register</span><span class="p">[</span><span class="n">model_class</span><span class="p">]</span> <span class="o">=</span> <span class="n">arya_class</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">arya_class</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_register</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">pt</span> <span class="o">=</span> <span class="n">url</span><span class="p">(</span><span class="s1">&#39;^{}/{}/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="p">,</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span><span class="p">),</span> <span class="n">arya_class</span><span class="o">.</span><span class="n">urls</span><span class="p">)</span>
            <span class="n">patterns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">patterns</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;arya&#39;</span>   <span class="c1"># 第三个参数就是namespace</span>
</code></pre></td></tr></table>
</div>
</div><p>namespace设置完毕，接下来就为每个url设置标识它的name属性</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># service/arya.py</span>
<span class="k">class</span> <span class="nc">AryaConfig</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">site</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span> <span class="o">=</span> <span class="n">model_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site</span> <span class="o">=</span> <span class="n">site</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">urls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
        <span class="n">app_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span>

        <span class="c1"># 添加name属性，针对不同的model，生成不同的name</span>
        <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^$&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">changelist_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;{}_{}_changelist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)),</span>
            <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^add/&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;{}_{}_add&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)),</span>
            <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(\d+)/change&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">change_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;{}_{}_change&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)),</span>
            <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^(\d+)/delete&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_view</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;{}_{}_delete&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">model_name</span><span class="p">)),</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">patterns</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
    
    <span class="c1"># ... ... </span>
</code></pre></td></tr></table>
</div>
</div><p>需要反向生成url的时候，只需要即可</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">reverse_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">app_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="n">viewname</span><span class="o">=</span><span class="s1">&#39;arya:{}_{}_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">args</span><span class="p">,)</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">url</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="442-抽离公共方法">4.4.2 抽离公共方法</h3>
<p>像编辑按钮，删除按钮的，不应该让用户来自定义，所以可以把这些函数，提到父类中去，所以，在AryaConfig中定义编辑/删除函数,结合反推url以后，代码如下</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># service/arya.py</span>
<span class="k">class</span> <span class="nc">AryaConfig</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_class</span><span class="p">,</span> <span class="n">site</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span> <span class="o">=</span> <span class="n">model_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">site</span> <span class="o">=</span> <span class="n">site</span>

    <span class="k">def</span> <span class="nf">reverse_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">app_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span>
        <span class="n">model_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="n">viewname</span><span class="o">=</span><span class="s1">&#39;arya:{}_{}_{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">args</span><span class="p">,)</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="bp">None</span><span class="p">)</span>
        <span class="c1"># 这里的arya是namespce写死的，args是为url传递的参数(动态的为每一行对象构建专属id的url)</span>

        <span class="k">return</span> <span class="n">url</span>

    <span class="k">def</span> <span class="nf">change_button</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_url</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mark_safe</span><span class="p">(</span><span class="s1">&#39;&lt;a href=&#34;{}&#34; &gt;编辑&lt;/a&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span> 

    <span class="k">def</span> <span class="nf">delete_button</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reverse_url</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mark_safe</span><span class="p">(</span><span class="s1">&#39;&lt;a href=&#34;{}&#34; &gt;删除&lt;/a&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="443-权限接口">4.4.3 权限接口</h3>
<p>如果有编辑权限，那么就要显示编辑按钮，如果有删除权限，就要显示删除按钮，那么如何做呢？又或者不需要对权限控制，整体显示？根据上面代码的思路，我们知道只需要操作list_display就好了，如果有权限就住家一个change_button，没有就不显示即可，为了完成需求，抽离一个函数专门处理</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">AryaConfig</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="c1"># 权限相关的修改</span>
    <span class="k">def</span> <span class="nf">get_list_display</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_display</span><span class="p">)</span>
        
        <span class="c1"># list_display为空时(用户未指定)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># 如果有编辑权限</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AryaConfig</span><span class="o">.</span><span class="n">change_button</span><span class="p">)</span>  <span class="c1"># 这里调用的是函数，不是方法(self.change_button)，如果是方法的话，那么在调用时，self会被自动传入，而这不是我们想要的</span>
        <span class="c1"># 如果有删除权限</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AryaConfig</span><span class="o">.</span><span class="n">delete_button</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">changelist_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">data_query_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">data_query_set</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_display</span><span class="p">:</span>
                <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1"># 这里调用get_list_display，来渲染修改后的list_display</span>
                <span class="k">for</span> <span class="n">col_or_func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_list_display</span><span class="p">():</span> 
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col_or_func</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">props</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">col_or_func</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col_or_func</span><span class="p">,</span> <span class="n">Callable</span><span class="p">):</span>
                        <span class="n">props</span> <span class="o">=</span> <span class="n">col_or_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
                <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;changelist.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;data_list&#39;</span><span class="p">:</span> <span class="n">data_list</span><span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="45-抽离页面显示配置">4.5 抽离页面显示配置</h2>
<p>上面的代码虽然完成了页面的定制化显示，但是如果要在页面中持续添加数据源，那么changelist_view函数中将会非常冗长，那么接下来我们可以把这些页面显示的配置和数据封装成一个类，这样，在页面上就可以整体调用了。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">ChangeList</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_display</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_list_display</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">table_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">col_or_func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_display</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col_or_func</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">col_or_func</span><span class="p">)</span><span class="o">.</span><span class="n">verbose_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">col_or_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">model_class</span><span class="p">,</span> <span class="n">is_header</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">header</span>

    <span class="k">def</span> <span class="nf">table_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_display</span><span class="p">:</span>
                <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">col_or_func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_display</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col_or_func</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">props</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">col_or_func</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col_or_func</span><span class="p">,</span> <span class="n">Callable</span><span class="p">):</span>
                        <span class="n">props</span> <span class="o">=</span> <span class="n">col_or_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
                    <span class="n">tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>
                <span class="n">data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data_list</span>
</code></pre></td></tr></table>
</div>
</div><p>将定制化页面显示封装成ChangeList类，那么只需要在页面渲染的同时，传入ChangeList对象，在模版中调用方法，来渲染页面。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># changelist_view</span>
<span class="k">def</span> <span class="nf">changelist_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="n">data_query_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">cl</span> <span class="o">=</span> <span class="n">ChangeList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_query_set</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;changelist.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;cl&#39;</span><span class="p">:</span> <span class="n">cl</span><span class="p">})</span>

<span class="c1"># 页面渲染</span>
<span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">&#34;container&#34;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="err">列表页面</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">table</span> <span class="n">border</span><span class="o">=</span><span class="s2">&#34;1&#34;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&#34;table table-bordered table-hover&#34;</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">tbody</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">thead</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">tr</span><span class="o">&gt;</span>
            <span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">head</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">table_header</span> <span class="o">%</span><span class="p">}</span>
                <span class="o">&lt;</span><span class="n">th</span><span class="o">&gt;</span>
                    <span class="p">{{</span> <span class="n">head</span> <span class="p">}}</span>
                <span class="o">&lt;/</span><span class="n">th</span><span class="o">&gt;</span>
            <span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
        <span class="o">&lt;/</span><span class="n">tr</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">thead</span><span class="o">&gt;</span>
    <span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">cl</span><span class="o">.</span><span class="n">table_body</span> <span class="o">%</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="n">tr</span><span class="o">&gt;</span>
            <span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">data</span> <span class="o">%</span><span class="p">}</span>
                <span class="o">&lt;</span><span class="n">td</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">item</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">td</span><span class="o">&gt;</span>
            <span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
        <span class="o">&lt;/</span><span class="n">tr</span><span class="o">&gt;</span>
    <span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
    <span class="o">&lt;/</span><span class="n">tbody</span><span class="o">&gt;</span>

<span class="o">&lt;/</span><span class="n">table</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="46-添加页面实现">4.6 添加页面实现</h2>
<p>添加页面这里主要分为两部分来做，</p>
<ul>
<li>显示添加按钮</li>
<li>添加表单的显示</li>
</ul>
<h3 id="461-添加按钮">4.6.1 添加按钮</h3>
<p>关于添加按钮，可以让用户自定义是否显示，可以通过关键字指定,下面添加一个配置项</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">AryaConfig</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">show_add_button</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c1"># 为什么要添加这个方法，是因为可以在内部完成权限判断的需求</span>
    <span class="k">def</span> <span class="nf">get_show_button</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_add_button</span>
</code></pre></td></tr></table>
</div>
</div><p>由于前面，页面显示的东西，封装成了一个ChangeList对象，那么在这里就可以为它绑定这两个属性，而不用修改changelist_view函数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">ChangeList</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">queryset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_display</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_list_display</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_add_button</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_show_button</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_url</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">reverse_url</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>在页面上显示时</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-jinja" data-lang="jinja"><span class="cp">{%</span> <span class="k">if</span> <span class="nv">cl.show_add_button</span> <span class="cp">%}</span><span class="x">
</span><span class="x">    &lt;a href=&#34;</span><span class="cp">{{</span> <span class="nv">cl.add_url</span> <span class="cp">}}</span><span class="x">&#34; type=&#34;btn btn-primary&#34;&gt;添加&lt;/a&gt;
</span><span class="x"></span><span class="cp">{%</span> <span class="k">endif</span>  <span class="cp">%}</span><span class="x">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="462-添加页面">4.6.2 添加页面</h3>
<p>添加页面，这里使用ModelForm来完成</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="c1"># AryaConfig</span>

    <span class="c1"># 使用函数来创建，当用户指定了自己的ModelForm，就用用户自己的配置</span>
    <span class="k">def</span> <span class="nf">get_form_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_from</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_from</span>

        <span class="c1"># 否则新建一个基础的ModelForm</span>
        <span class="k">class</span> <span class="nc">DynamicModelForm</span><span class="p">(</span><span class="n">ModelForm</span><span class="p">):</span>
            <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="s1">&#39;__all__&#39;</span>

        <span class="k">return</span> <span class="n">DynamicModelForm</span>
</code></pre></td></tr></table>
</div>
</div><p>在add_view方法中更新如下代码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python">    <span class="k">def</span> <span class="nf">add_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># 用于实例化ModelForm</span>
        <span class="n">form_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_form_class</span><span class="p">()</span>    
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
            <span class="n">mf</span> <span class="o">=</span> <span class="n">form_class</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;add.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;mf&#39;</span><span class="p">:</span> <span class="n">mf</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
            <span class="n">mf</span> <span class="o">=</span> <span class="n">form_class</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mf</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                <span class="c1"># 如果数据验证，无误可以直接保存到数据库中</span>
                <span class="n">mf</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse_url</span><span class="p">(</span><span class="s1">&#39;changelist&#39;</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;add.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;mf&#39;</span><span class="p">:</span> <span class="n">mf</span><span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="47-编辑删除页面实现">4.7 编辑/删除页面实现</h2>
<p>编辑页面与添加页面逻辑相同，只不过是在渲染form表单的时候，将要修改的数据当作form的初始化数据，传入即可。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python">    <span class="k">def</span> <span class="nf">change_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="c1"># 将要修改的数据，预先查询得到</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
            <span class="n">form_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_form_class</span><span class="p">()</span>
            <span class="c1"># 查到数据</span>
            <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
                <span class="c1"># 初始化ModelForm表单数据</span>
                <span class="n">mf</span> <span class="o">=</span> <span class="n">form_class</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;change.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;mf&#39;</span><span class="p">:</span> <span class="n">mf</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse_url</span><span class="p">(</span><span class="s1">&#39;changelist&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
            <span class="n">form_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_form_class</span><span class="p">()</span>
            <span class="c1"># 修改已存在数据，需要将已存在的数据传入，否则是新增</span>
            <span class="n">fm</span> <span class="o">=</span> <span class="n">form_class</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fm</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
                <span class="n">fm</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse_url</span><span class="p">(</span><span class="s1">&#39;changelist&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;change.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;mf&#39;</span><span class="p">:</span> <span class="n">fm</span><span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="48-模糊搜素">4.8 模糊搜素</h2>
<p>关于模糊搜索，提供一个配置接口，默认是不显示模糊搜索的，如果要进行搜索，那么需要配置支持模糊搜索的字段信息。首先在前端页面上显示搜索框，条件根据后端信息，来看是否显示</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html">{% if cl.search_button %}
        <span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">&#39;GET&#39;</span><span class="p">&gt;</span>
            {% if cl.search_key %}
                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;query&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;{{ cl.search_key }}&#39;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-control&#34;</span>
                       <span class="na">style</span><span class="o">=</span><span class="s">&#34;display: inline-block;width: 200px;&#34;</span><span class="p">/&gt;</span>
            {% else %}
                <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;q&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-control&#34;</span> <span class="na">style</span><span class="o">=</span><span class="s">&#34;display: inline-block;width: 200px;&#34;</span><span class="p">/&gt;</span>
            {% endif %}
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;搜索&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;btn btn-primary&#34;</span><span class="p">/&gt;</span>
        <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
    {% endif %}
</code></pre></td></tr></table>
</div>
</div><p>后端指定默认值，或者接口，看用户是否配置了模糊搜索的字段</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python">
 <span class="k">def</span> <span class="nf">changelist_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
            <span class="n">search_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

            <span class="c1"># 如果提交了查询字符串，并且设置了模糊搜索的字段</span>
            <span class="k">if</span> <span class="n">search_key</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_search_list</span><span class="p">():</span>

                <span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Q</span>
                <span class="n">condition</span> <span class="o">=</span> <span class="n">Q</span><span class="p">()</span>  <span class="c1"># 通过Q对象来封装条件</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_search_list</span><span class="p">():</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">Q</span><span class="p">()</span>
                    <span class="n">temp</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">item</span><span class="p">,</span> <span class="n">search_key</span><span class="p">))</span>  <span class="c1"># 封装条件</span>
                    <span class="n">condition</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">conn_type</span><span class="o">=</span><span class="s1">&#39;OR&#39;</span><span class="p">)</span>  <span class="c1"># 多个条件之间是or关系</span>
                <span class="n">data_query_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>  <span class="c1"># 获取数据</span>
                <span class="n">cl</span> <span class="o">=</span> <span class="n">ChangeList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_query_set</span><span class="p">)</span>
                <span class="n">cl</span><span class="o">.</span><span class="n">search_key</span> <span class="o">=</span> <span class="n">search_key</span>   <span class="c1"># 用于在搜索框中默认显示搜索的字符串</span>
                <span class="n">cl</span><span class="o">.</span><span class="n">search_button</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_query_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                <span class="n">cl</span> <span class="o">=</span> <span class="n">ChangeList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_query_set</span><span class="p">)</span>

                <span class="c1"># 如果配置了搜索字段，那就显示搜索框</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_search_list</span><span class="p">():</span>
                    <span class="n">cl</span><span class="o">.</span><span class="n">search_button</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;changelist.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;cl&#39;</span><span class="p">:</span> <span class="n">cl</span><span class="p">})</span>
</code></pre></td></tr></table>
</div>
</div><p>这样用户在配置时，可以选择</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">UserinfoUserConfig</span><span class="p">(</span><span class="n">arya</span><span class="o">.</span><span class="n">AryaConfig</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">]</span>
    <span class="n">show_add_button</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c1"># 模糊匹配</span>
    <span class="n">search_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;username__contains&#39;</span><span class="p">,</span> <span class="s1">&#39;password__contains&#39;</span><span class="p">]</span>  

    <span class="c1"># 精确匹配</span>
    <span class="n">search_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">]</span>  
</code></pre></td></tr></table>
</div>
</div><h2 id="49-定制action下拉功能框">4.9 定制action下拉功能框</h2>
<p>同样把这个功能配置为可定制的，用户需要在自己的Config类中，编写处理函数，并为函数指定显示的名称</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">multi_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">):</span>
    <span class="k">pass</span> 

<span class="n">multi_delete</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;批量删除&#39;</span>
<span class="n">action</span> <span class="o">=</span> <span class="p">[</span><span class="n">multi_delete</span><span class="p">]</span>
</code></pre></td></tr></table>
</div>
</div><p>处理逻辑是，在前端通过判断action，来确认是否显示，对于显示，构建以下数据结构，便于在前端渲染</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">actions_option</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_action</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_action</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">func</span><span class="o">.</span><span class="n">text</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">result</span>

<span class="c1"># 结构如下：</span>
<span class="n">actions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="n">func</span><span class="o">.</span><span class="n">text</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="n">func</span><span class="o">.</span><span class="n">text</span><span class="p">},</span>
    <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="n">func</span><span class="o">.</span><span class="n">text</span><span class="p">},</span>
<span class="p">]</span>
</code></pre></td></tr></table>
</div>
</div><p>在前端渲染select输入框，为了能和前面渲染的表格中的checkbox，一起提交，这里选择，将表格和select输入框，添加到一个form里，使用submit进行整体提交，注意，这里要为每个checkbox框绑定name属性，否则无法提交信息</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-html" data-lang="html">    <span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">&#34;post&#34;</span><span class="p">&gt;</span>
        {% csrf_token %}
        {% if cl.get_action %}  <span class="c">&lt;!--  如果配置了action --&gt;</span>
            <span class="p">&lt;</span><span class="nt">select</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;select_ac&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;form-control&#34;</span> <span class="na">style</span><span class="o">=</span><span class="s">&#34;display: inline-block;width: 200px;&#34;</span><span class="p">&gt;</span>
                {% for item in cl.actions %}
                    <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&#34;{{ item.value }}&#34;</span><span class="p">&gt;</span>{{ item.text }}<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
                {% endfor %}
            <span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;submit&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;btn btn-success&#34;</span><span class="p">&gt;</span>执行<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        {% endif %}
        <span class="p">&lt;</span><span class="nt">table</span> <span class="na">border</span><span class="o">=</span><span class="s">&#34;1&#34;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#34;table table-bordered table-hover&#34;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">tbody</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">thead</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
                {% for head in cl.table_header %}
                    <span class="p">&lt;</span><span class="nt">th</span><span class="p">&gt;</span>
                        {{ head }}
                    <span class="p">&lt;/</span><span class="nt">th</span><span class="p">&gt;</span>
                {% endfor %}
            <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">thead</span><span class="p">&gt;</span>
            {% for data in cl.table_body %}
                <span class="p">&lt;</span><span class="nt">tr</span><span class="p">&gt;</span>
                    {% for item in data %}
                        <span class="p">&lt;</span><span class="nt">td</span><span class="p">&gt;</span>{{ item }}<span class="p">&lt;/</span><span class="nt">td</span><span class="p">&gt;</span>
                    {% endfor %}
                <span class="p">&lt;/</span><span class="nt">tr</span><span class="p">&gt;</span>
            {% endfor %}
            <span class="p">&lt;/</span><span class="nt">tbody</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">table</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></td></tr></table>
</div>
</div><p>那么接下来只需要在changelist_view函数中做如下处理即可</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
    <span class="n">func_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;select_ac&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">func_str</span><span class="p">:</span>
        <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_str</span><span class="p">)</span>
        <span class="n">func</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>   <span class="c1"># 通过反射执行</span>

    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse_url</span><span class="p">(</span><span class="s1">&#39;changelist&#39;</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div><p>所以，真正处理业务的函数在用户配置的函数内</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python">    <span class="c1"># 接受提交的数据（这里为checkbox命名的name为pk）</span>
   <span class="k">def</span> <span class="nf">multi_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">):</span>
        <span class="n">pk</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;pk&#39;</span><span class="p">)</span>  
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_class</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>  <span class="c1"># 查找，批量删除</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="n">multi_delete</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;批量删除&#39;</span>

    <span class="n">action</span> <span class="o">=</span> <span class="p">[</span><span class="n">multi_delete</span><span class="p">]</span>

</code></pre></td></tr></table>
</div>
</div>
    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">daxin.li</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
      0001-01-01
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">Reward</label>
  <div class="qr-code">
    
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/wechat-qr-code.png">
        <span>Wechat</span>
      </label>
    
      <label class="qr-code-image" for="reward">
        <img class="image" src="/alipay-qr-code.png">
        <span>Alipay</span>
      </label>
  </div>
</div>

    <footer class="post-footer">
      

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/7-%E5%88%97%E8%A1%A8%E8%A7%A3%E6%9E%90%E5%BC%8F-%E7%94%9F%E6%88%90%E5%99%A8/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">7-列表解析式-生成器</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/post/8-rbac%E6%9D%83%E9%99%90%E7%B3%BB%E7%BB%9F/">
            <span class="next-text nav-default">8-rbac权限系统</span>
            <span class="prev-text nav-mobile">Next</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  
  
  

  
  

  

  
  
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "dachenzi/dachenzi.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:dahlhin.li@gmail.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/dachenzi" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://weibo.com/2401416804/profile?rightmod=1&amp;wvr=6&amp;mod=personinfo" rel="me noopener" class="iconfont"
      title="weibo"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M385.714286 733.714286q12-19.428571 6.285714-39.428571t-25.714286-28.571429q-19.428571-8-41.714286-0.571429t-34.285714 26.285714q-12.571429 19.428571-7.428571 39.142857t24.571429 28.857143 42.571429 1.428571 35.714286-27.142857zm53.714286-69.142857q4.571429-7.428571 2-15.142857t-10-10.571429q-8-2.857143-16.285714 2.857143t-12.285714 10.571429q-9.714286 17.714286 7.428571 25.714286 8 2.857143 16.571429 2.857143t12.571429-10.571429zm99.428571 61.142857q-25.714286 58.285714-90.285714 85.714286t-128 6.857143q-61.142857-19.428571-84.285714-72.285714t3.714286-107.142857q26.857143-53.142857 86.571429-79.428571t120.285714-10.857143q63.428571 16.571429 90.571429 68.285714t1.428571 108.857143zm178.285714-91.428571q-5.142857-54.857143-50.857143-97.142857t-119.142857-62.285714-156.857143-12q-127.428571 13.142857-211.142857 80.857143t-75.714286 151.142857q5.142857 54.857143 50.857143 97.142857t119.142857 62.285714 156.857143 12q127.428571-13.142857 211.142857-80.857143t75.714286-151.142857zm176 2.285714q0 38.857143-21.142857 79.714286t-62.285714 78.285714-96.285714 67.142857-129.142857 47.428571-154.571429 17.714286-157.142857-19.142857-137.428571-53.142857-98-86.285714-37.142857-114q0-65.714286 39.714286-140t112.857143-147.428571q96.571429-96.571429 195.142857-134.857143t140.857143 4q37.142857 36.571429 11.428571 119.428571-2.285714 8-0.571429 11.428571t5.714286 4 8.285714 2.857143 7.714286-2l3.428571-1.142857q79.428571-33.714286 140.571429-33.714286t87.428571 34.857143q25.714286 36 0 101.714286-1.142857 7.428571-2.571429 11.428571t2.571429 7.142857 6.857143 4.285714 9.714286 3.428571q32.571429 10.285714 58.857143 26.857143t45.714286 46.571429 19.428571 66.571429zm-42.285714-356.571429q24 26.857143 31.142857 62t-3.714286 67.142857q-4.571429 13.142857-16.857143 19.428571t-25.428571 2.285714q-13.142857-4.571429-19.428571-16.857143t-2.285714-25.428571q11.428571-36-13.714286-63.428571t-61.142857-20q-13.714286 2.857143-25.714286-4.571429t-14.285714-21.142857q-2.857143-13.714286 4.571429-25.428571t21.142857-14.571429q34.285714-7.428571 68 3.142857t57.714286 37.428571zm103.428571-93.142857q49.714286 54.857143 64.285714 127.142857t-7.714286 138q-5.142857 15.428571-19.428571 22.857143t-29.714286 2.285714-22.857143-19.428571-2.857143-29.714286q16-46.857143 5.714286-98.285714t-45.714286-90.285714q-35.428571-39.428571-84.571429-54.571429t-98.857143-4.857143q-16 3.428571-29.714286-5.428571t-17.142857-24.857143 5.428571-29.428571 24.857143-16.857143q70.285714-14.857143 139.428571 6.571429t118.857143 76.857143z"></path>
</svg>

    </a>
  
    <a href="https://www.zhihu.com/people/da-chen-zi-67" rel="me noopener" class="iconfont"
      title="zhihu"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M351.791182 562.469462l192.945407 0c0-45.367257-21.3871-71.939449-21.3871-71.939449L355.897709 490.530013c3.977591-82.182744 7.541767-187.659007 8.816806-226.835262l159.282726 0c0 0-0.86367-67.402109-18.578124-67.402109s-279.979646 0-279.979646 0 16.850783-88.141456 39.318494-127.053698c0 0-83.60514-4.510734-112.121614 106.962104S81.344656 355.077018 76.80834 367.390461c-4.536316 12.313443 24.62791 5.832845 36.941354 0 12.313443-5.832845 68.050885-25.924439 84.252893-103.69571l86.570681 0c1.165546 49.28652 4.596691 200.335724 3.515057 226.835262L109.86113 490.530013c-25.275663 18.147312-33.701566 71.939449-33.701566 71.939449L279.868105 562.469462c-8.497535 56.255235-23.417339 128.763642-44.275389 167.210279-33.05279 60.921511-50.55235 116.65793-169.802314 212.576513 0 0-19.442818 14.257725 40.829917 9.073656 60.273758-5.185093 117.305683-20.739347 156.840094-99.807147 20.553105-41.107233 41.805128-93.250824 58.386782-146.138358l-0.055259 0.185218 167.855986 193.263655c0 0 22.035876-51.847855 5.832845-108.880803L371.045711 650.610918l-42.1244 31.157627-0.045025 0.151449c11.69946-41.020252 20.11206-81.5749 22.726607-116.858498C351.665315 564.212152 351.72876 563.345412 351.791182 562.469462z"></path>
  <path d="M584.918753 182.033893l0 668.840094 70.318532 0 28.807093 80.512708 121.875768-80.512708 153.600307 0L959.520453 182.033893 584.918753 182.033893zM887.150192 778.934538l-79.837326 0-99.578949 65.782216-23.537066-65.782216-24.855084 0L659.341766 256.673847l227.807403 0L887.149169 778.934538z"></path>
</svg>

    </a>


<a href="https://dachenzi.github.io/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2016 -
    2020
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        daxin.li
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
