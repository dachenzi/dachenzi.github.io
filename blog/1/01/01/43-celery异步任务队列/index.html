<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>43-celery异步任务队列 &middot; Lee Xin</title>

  
  <link rel="stylesheet" href="https://dachenzi.github.io/css/poole.css">
  <link rel="stylesheet" href="https://dachenzi.github.io/css/hyde.css">
  <link rel="stylesheet" href="https://dachenzi.github.io/css/poole-overrides.css">
  <link rel="stylesheet" href="https://dachenzi.github.io/css/hyde-overrides.css">
  <link rel="stylesheet" href="https://dachenzi.github.io/css/hyde-x.css">
  <link rel="stylesheet" href="https://dachenzi.github.io/css/highlight/sunburst.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://dachenzi.github.io/touch-icon-144-precomposed.png">
  <link href="https://dachenzi.github.io/favicon.png" rel="icon">

  
  
  
  

  <meta name="description" content="Your default page description">
  <meta name="keywords" content="your,default,page,keywords">
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'Your Google Analytics tracking code', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>
<body class="theme-base-08">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      
      <h1>Lee Xin</h1>
      <p class="lead">Your favourite quote or soundbite.</p>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="https://dachenzi.github.io/">Blog</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      
      
      
      
      
      
      
      
      
      </li>
    </ul>

    
    <p><script id='flattr'>
      (function(id){
        var s = document.getElementById(id);
        var f = document.createElement('iframe');
        f.src = '//api.flattr.com/button/view/?uid=&button=compact&url=https:\/\/dachenzi.github.io\/&title=daxin\u0027s blog';
        f.title = 'Flattr';
        f.height = 20;
        f.width = 110;
        f.style.borderWidth = 0;
        s.parentNode.insertBefore(f, s);
      })('flattr');
    </script></p>
    

    <p>Copyright &copy; 2020 <a href="https://dachenzi.github.io/license/">License</a><br/>
       Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://github.com/zyro/hyde-x">Hyde-X</a></p>

  </div>
</div>


<div class="content container">
  <div class="post">
    <h1 class="post-title">43-celery异步任务队列</h1>
    <span class="post-date">Jan 1, 0001 &middot; 5 minute read &middot; <a href="https://dachenzi.github.io/blog/1/01/01/43-celery%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E9%98%9F%E5%88%97/#disqus_thread">Comments</a>
    </span>
    <p>{% raw %}</p>
<h1 id="1-celery概述">1 Celery概述</h1>
<p>关于celery的定义，首先来看官方网站：
<strong>Celery(芹菜) 是一个简单、灵活且可靠的，处理大量消息的分布式系统，并且提供维护这样一个系统的必需工具。</strong></p>
<p>        简单来看，是一个基于python开发的分布式异步消息任务队列，持使用任务队列的方式在分布的机器、进程、线程上执行任务调度。通过它可以轻松的实现任务的异步处理， 如果你的业务场景中需要用到异步任务，就可以考虑使用celery， 举几个实例场景中可用的例子:</p>
<ol>
<li>你想对100台机器执行一条批量命令，可能会花很长时间 ，但你不想让你的程序等着结果返回，而是给你返回 一个任务ID,你过一段时间只需要拿着这个任务id就可以拿到任务执行结果，在任务执行ing进行时，你可以继续做其它的事情。 　　</li>
<li>你想做一个定时任务，比如每天检测一下你们所有客户的资料，如果发现今天 是客户的生日，就给他发个短信祝福 。　　</li>
</ol>
<p>Celery 在执行任务时需要通过一个中间人(消息中间件)来接收和发送任务消息，以及存储任务结果，完整的中间人列表请查阅官方网站</p>
<p>PS：任务队列是一种在线程或机器间分发任务的机制。
PS：消息队列的输入是工作的一个单元，称为任务，独立的工作（Worker）进程持续监视队列中是否有需要处理的新任务。</p>
<h1 id="2-celery简介">2 Celery简介</h1>
<p>        Celery 系统可包含多个职程和中间人，以此获得高可用性和横向扩展能力，其基本架构由三部分组成，<code>消息中间件</code>（message broker），<code>任务执行单元</code>（worker）和<code>任务执行结果存储</code>（task result store）组成。</p>
<ul>
<li><code>消息中间件</code>，Celery本身不提供消息服务，但是可以方便的和第三方提供的消息中间件集成，一般使用rabbitMQ or Redis，当然其他的还有MySQL以及Mongodb。</li>
<li><code>任务执行单元</code>，Worker是Celery提供的任务执行的单元，worker并发的运行在分布式的系统节点中。</li>
<li><code>任务结果存储</code>，Task result store用来存储Worker执行的任务的结果，Celery支持以不同方式存储任务的结果，包括Redis，MongoDB，Django ORM，AMQP等。</li>
</ul>
<p>Celery的主要特点：</p>
<ol>
<li>简单：一单熟悉了celery的工作流程后，配置和使用还是比较简单的</li>
<li>高可用：当任务执行失败或执行过程中发生连接中断，celery 会自动尝试重新执行任务</li>
<li>快速：一个单进程的celery每分钟可处理上百万个任务</li>
<li>灵活： 几乎celery的各个组件都可以被扩展及自定制</li>
</ol>
<p><img src="photo/celery.png" alt="celery"></p>
<p>根据前面的介绍，我们可以得出如下流程图：</p>
<ol>
<li>用户应用程序将任务(已经在celery app中注册的)放入Broker中。</li>
<li>多个worker通过Broker获取任务并执行。</li>
<li>worker执行完成后，会把任务的结果、状态等信息返回到Broker中存储，供用户程序读取。</li>
</ol>
<p>PS：Celery 用消息通信，通常使用中间人（Broker）在客户端和职程(worker)间斡旋。这个过程从客户端向队列添加消息开始，之后中间人把消息派送给职程(worker)。</p>
<h1 id="3-celery模块的基本使用">3 Celery模块的基本使用</h1>
<p>要使用Celery需要先安装celery模块，下面的例子使用Python3进行举例,使用redis作为消息中间人的角色。</p>
<h2 id="31-利用pip3命令安装celery模块">3.1 利用pip3命令安装celery模块</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">pip3 install celery

<span style="color:#75715e"># 测试是否成功安装</span>
[root<span style="color:#a6e22e">@namenode</span> <span style="color:#f92672">~</span>]<span style="color:#75715e"># python3</span>
Python <span style="color:#ae81ff">3.6</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span> (default, Dec <span style="color:#ae81ff">21</span> <span style="color:#ae81ff">2017</span>, <span style="color:#ae81ff">17</span>:<span style="color:#ae81ff">26</span>:<span style="color:#ae81ff">43</span>)
[GCC <span style="color:#ae81ff">4.4</span><span style="color:#f92672">.</span><span style="color:#ae81ff">7</span> <span style="color:#ae81ff">20120313</span> (Red Hat <span style="color:#ae81ff">4.4</span><span style="color:#f92672">.</span><span style="color:#ae81ff">7</span><span style="color:#f92672">-</span><span style="color:#ae81ff">16</span>)] on linux
Type <span style="color:#e6db74">&#34;help&#34;</span>, <span style="color:#e6db74">&#34;copyright&#34;</span>, <span style="color:#e6db74">&#34;credits&#34;</span> <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;license&#34;</span> <span style="color:#66d9ef">for</span> more information<span style="color:#f92672">.</span>
<span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">import</span> celery      <span style="color:#75715e"># 没有报错表示模块安装正常</span>
<span style="color:#f92672">&gt;&gt;&gt;</span>
</code></pre></div><p>PS：如果你是编译安装的Python3，执行以上步骤后不一定代表正确安装，还需要在命令行下执行celery命令，如果报错请参考这篇文章：<a href="http://www.cnblogs.com/dachenzi/p/8082129.html">Python3安装Celery模块后执行Celery命令报错</a></p>
<h2 id="32-创建一个celery-application">3.2 创建一个celery application</h2>
<p>用来定义任务列表，这里任务文件的名称叫做task.py(注意后面会用到文件名)。</p>
<h3 id="321-通过实例定制化celery">3.2.1 通过实例定制化celery</h3>
<p>在实例化celery应用时，对celery进行配置</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> celery <span style="color:#f92672">import</span> Celery
 
app <span style="color:#f92672">=</span> Celery(<span style="color:#e6db74">&#39;task&#39;</span>,　　<span style="color:#75715e"># 是当前模块的名称，这个参数是必须的，这样的话名称可以自动生成</span>
    broker<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;redis://10.0.0.3:6379/0&#34;</span>,     <span style="color:#75715e"># 中间人的地址</span>
    backend<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;redis://10.0.0.3:6379/1&#34;</span>　　　<span style="color:#75715e"># 结果数据存放地址</span>
)
 
<span style="color:#a6e22e">@app.task</span>　　　　　<span style="color:#75715e"># 使用celery标识一个任务，多个任务都需要使用该装饰器　</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add</span>(x,y):　　　　
    <span style="color:#66d9ef">return</span> x<span style="color:#f92672">+</span>y
</code></pre></div><h3 id="322-通过配置信息定制化celery">3.2.2 通过配置信息定制化celery</h3>
<p>实例化celery应用后，通过conf对celery进行定制化配置（可以将配置项写在配置文件中，一般使用这种方式）</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> celery <span style="color:#f92672">import</span> Celery

app <span style="color:#f92672">=</span> Celery(<span style="color:#e6db74">&#39;mycelery&#39;</span>)

<span style="color:#75715e"># 全局配置(启用UTC时间，并配置时区)</span>
app<span style="color:#f92672">.</span>conf<span style="color:#f92672">.</span>update(enable_utc<span style="color:#f92672">=</span>True, timezone<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Asia/ShangHai&#39;</span>)
<span style="color:#75715e"># 派发任务要使用的队列(broker)</span>
app<span style="color:#f92672">.</span>conf<span style="color:#f92672">.</span>broker_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;redis://:daxin@10.0.0.10:6379/0&#39;</span>
<span style="color:#75715e"># 避免重复执行(执行超过visibility_timeout指定的时间，会重新派发任务，一般的解决办法是把这个时间调长</span>
app<span style="color:#f92672">.</span>conf<span style="color:#f92672">.</span>broker_transport_options <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;visibility_timeout&#39;</span>: <span style="color:#ae81ff">3600</span><span style="color:#f92672">*</span><span style="color:#ae81ff">12</span>}
<span style="color:#75715e"># 任务执行结果存储</span>
app<span style="color:#f92672">.</span>conf<span style="color:#f92672">.</span>result_backend <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;redis://:daxin@10.0.0.10:6379/1&#39;</span>
</code></pre></div><p>其他中间人的配置</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># rabbitmq</span>
broker <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;amqp://user:password@ip:5672//&#39;</span>

<span style="color:#75715e"># redis</span>
broker <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;redis://:passwordf@ip:6379/db&#39;</span>
</code></pre></div><h2 id="33-运行一个worker">3.3 运行一个worker</h2>
<p>当然这里可以执行多个worker，在命令行下执行(在test.py文件所在目录下执行)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">celery -A task worker --loglevel<span style="color:#f92672">=</span>debug
celery -A task worker -l debug  <span style="color:#75715e"># 使用-l设置输出日志级别也可以</span>
</code></pre></div><p>参数含义：</p>
<ul>
<li>-A参数表示的是Celery APP的名称，task就是APP的名称(<code>应用文件名</code>)</li>
<li>worker表示是一个执行任务角色</li>
<li>loglevel=info记录日志类型默认是info。</li>
</ul>
<h2 id="34-发布调用任务">3.4 发布(调用)任务</h2>
<p>这里在task.py所在的目录调用Python解释器执行，这样可以方便的引入这个app。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">&gt;&gt;&gt;</span> <span style="color:#f92672">from</span> task <span style="color:#f92672">import</span> add
<span style="color:#f92672">&gt;&gt;&gt;</span> add<span style="color:#f92672">.</span>delay(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">4</span>)
</code></pre></div><ul>
<li>使用 <code>delay()</code> 方法来调用任务，这是 <code>apply_async()</code> 方法的快捷方式，该方法允许你更好地控制任务执行(异步执行)。</li>
<li>这个任务已经由之前启动的职程(worker)执行，可以查看职程的控制台输出来验证。</li>
</ul>
<p>PS：调用任务会返回一个 <code>AsyncResult</code> 实例，可用于检查任务的状态，等待任务完成或获取返回值（如果任务失败，则为异常和回溯）。 但这个功能默认是不开启的，需要设置一个 Celery 的结果后端(配置了backend才会生效)。</p>
<h2 id="35-观察执行结果">3.5 观察执行结果</h2>
<p>下面是worker在终端输出的日志</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">[<span style="color:#ae81ff">2017</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">22</span> <span style="color:#ae81ff">15</span>:<span style="color:#ae81ff">34</span>:<span style="color:#ae81ff">36</span>,<span style="color:#ae81ff">819</span>: INFO<span style="color:#f92672">/</span>MainProcess] Received task: task<span style="color:#f92672">.</span>add[b881bbea<span style="color:#f92672">-</span>e729<span style="color:#f92672">-</span><span style="color:#ae81ff">444e-9</span>efd<span style="color:#f92672">-</span><span style="color:#ae81ff">434</span>fa6e43f57]
[<span style="color:#ae81ff">2017</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">22</span> <span style="color:#ae81ff">15</span>:<span style="color:#ae81ff">34</span>:<span style="color:#ae81ff">46</span>,<span style="color:#ae81ff">828</span>: INFO<span style="color:#f92672">/</span>ForkPoolWorker<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] Task task<span style="color:#f92672">.</span>add[b881bbea<span style="color:#f92672">-</span>e729<span style="color:#f92672">-</span><span style="color:#ae81ff">444e-9</span>efd<span style="color:#f92672">-</span><span style="color:#ae81ff">434</span>fa6e43f57] succeeded <span style="color:#f92672">in</span> <span style="color:#ae81ff">10.008738335978705</span>s: <span style="color:#ae81ff">3</span>
</code></pre></div><p>        从上面日志可以看到，当worker从中间人那获取任务后，会生成一个task ID，这里我们和之前发送任务返回的AsyncResult对比我们发现，每个task都有一个唯一的ID，第二行说明了这个任务执行succeed,执行结果为3。</p>
<p>PS：通过检查redis的数据也可以查看结果信息</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">root<span style="color:#a6e22e">@namenode</span> python]<span style="color:#75715e"># redis-cli</span>
<span style="color:#ae81ff">127.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0.1</span>:<span style="color:#ae81ff">6379</span>[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">&gt;</span> keys <span style="color:#f92672">*</span>
<span style="color:#ae81ff">1</span>) <span style="color:#e6db74">&#34;celery-task-meta-31f2f75d-20d9-4bb6-8b04-079ef65afbab&#34;</span>
<span style="color:#ae81ff">2</span>) <span style="color:#e6db74">&#34;celery-task-meta-334f0e9b-87f6-461a-a068-571bd3773691&#34;</span>
<span style="color:#ae81ff">3</span>) <span style="color:#e6db74">&#34;celery-task-meta-57bb002b-017d-43bc-a88a-6d470a9dfe95&#34;</span>
<span style="color:#ae81ff">4</span>) <span style="color:#e6db74">&#34;celery-task-meta-05161a38-3fd9-4be1-bae9-dc674d30296c&#34;</span>
<span style="color:#ae81ff">127.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0.1</span>:<span style="color:#ae81ff">6379</span>[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">&gt;</span> get celery<span style="color:#f92672">-</span>task<span style="color:#f92672">-</span>meta<span style="color:#f92672">-</span>cddbc105<span style="color:#f92672">-</span>ce52<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>d30<span style="color:#f92672">-</span>bab0<span style="color:#f92672">-</span><span style="color:#ae81ff">2114749</span>dcf99
<span style="color:#e6db74">&#34;{</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">status</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">SUCCESS</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">, </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">result</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: 4, </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">traceback</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: null, </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">children</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: [], </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">task_id</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">: </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">cddbc105-ce52-4d30-bab0-2114749dcf99</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">}&#34;</span>
<span style="color:#ae81ff">127.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0.1</span>:<span style="color:#ae81ff">6379</span>[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">&gt;</span>
</code></pre></div><ul>
<li>可以看到有很多celery任务执行的结果</li>
<li>使用get就可以查看存储的信息(类型为string)</li>
</ul>
<h2 id="36-asyncresult-实例常用方法">3.6 AsyncResult 实例常用方法</h2>
<p>通过获取异步执行对象的返回值来获取AsyncResult实例对象</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>forget()</td>
<td>清除执行结果</td>
</tr>
<tr>
<td>revoke(terminate=True)</td>
<td>取消任务，terminate默认为False，正在执行的无法中断，为True时，正在执行的也会被中断</td>
</tr>
<tr>
<td>get(timeout=None,<!-- raw HTML omitted -->propagate=False)</td>
<td>阻塞等待获取结果(可以重复拿)<!-- raw HTML omitted -->1.timeout为超时时间,如果在指定时间内没有返回会报异常，否则永远等待<!-- raw HTML omitted -->2.propagate为True时，可以美化输出信息<!-- raw HTML omitted -->3.倘若任务抛出了一个异常， get() 会重新抛出异常。<!-- raw HTML omitted -->4.如果celery没有配置backend，那么执行get方法将会异</td>
</tr>
<tr>
<td>ready()</td>
<td>结果为 True/False 表示 完成/未完成</td>
</tr>
<tr>
<td>successful()</td>
<td>执行成功时返回True</td>
</tr>
<tr>
<td>failed()</td>
<td>执行失败时返回True</td>
</tr>
<tr>
<td>result</td>
<td>获取结果</td>
</tr>
<tr>
<td>state</td>
<td>任务当前的状态<!-- raw HTML omitted -->1.SUCCESS:运行成功<!-- raw HTML omitted -->2.PENDING:等待被执行<!-- raw HTML omitted -->3.STARTED:已经开始执行<!-- raw HTML omitted -->4.RETRY:正在重试<!-- raw HTML omitted -->5.FAILURE:执行失败</td>
</tr>
<tr>
<td>task_id</td>
<td>任务的id</td>
</tr>
<tr>
<td>traceback</td>
<td>获取原始的回溯信息</td>
</tr>
</tbody>
</table>
<p>导入AsyncResult对象，来查看结果的方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> celery.result <span style="color:#f92672">import</span> AsyncResult
<span style="color:#f92672">from</span> task <span style="color:#f92672">import</span> app

result <span style="color:#f92672">=</span> AsyncResult(id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;d01289e4-9034-4a46-8c63-7bca45946efa&#39;</span>, app<span style="color:#f92672">=</span>app)
<span style="color:#66d9ef">print</span>(result<span style="color:#f92672">.</span>task_id)  <span style="color:#75715e"># d01289e4-9034-4a46-8c63-7bca45946efa</span>
<span style="color:#66d9ef">print</span>(result<span style="color:#f92672">.</span>successful())  <span style="color:#75715e"># True</span>
</code></pre></div><p>注意：AsyncResult对象，需要一个id，和它对应的app，才可以解析到结果。</p>
<h2 id="37-定时执行一次">3.7 定时执行一次</h2>
<p>        celery内置定时任务和crontab的效果一样，现在我的需求是在某一时刻来执行(比如at命令)，那么可以使用apply_async的eta参数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> task <span style="color:#f92672">import</span> func
<span style="color:#f92672">import</span> datetime

ctime <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>now()
<span style="color:#66d9ef">print</span>(ctime)
utc_time <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>utcfromtimestamp(ctime<span style="color:#f92672">.</span>timestamp())
<span style="color:#66d9ef">print</span>(utc_time)

addten <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>timedelta(seconds<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>)
utc_time <span style="color:#f92672">+=</span> addten

<span style="color:#75715e"># utc_time = datetime.datetime(year=2019, month=4, day=11, hour=9, minute=41)  # 直接构建，也需要是utc时间</span>

result <span style="color:#f92672">=</span> func<span style="color:#f92672">.</span>apply_async(args<span style="color:#f92672">=</span>[<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>], eta<span style="color:#f92672">=</span>utc_time)
</code></pre></div><h1 id="4-多目录结构">4 多目录结构</h1>
<p>上面只是基础的用法，在生产中我们往往不这样使用，一般的目录结构如下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#960050;background-color:#1e0010">├──</span> celery_task
<span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#960050;background-color:#1e0010">├──</span> account<span style="color:#f92672">.</span>py
<span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#960050;background-color:#1e0010">├──</span> celery<span style="color:#f92672">.</span>py  <span style="color:#75715e"># 配置文件</span>
<span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#960050;background-color:#1e0010">└──</span> tasks<span style="color:#f92672">.</span>py
<span style="color:#960050;background-color:#1e0010">└──</span> givetask<span style="color:#f92672">.</span>py  <span style="color:#75715e"># 分发任务</span>
</code></pre></div><p>说明：</p>
<ul>
<li>一般会在项目目录下直接创建一个以celery开头的文件夹用于存放celery的配置文件和任务</li>
<li>必须存在一个celery.py文件，连接等相关的配置需要在这里创建</li>
<li>task函数所在的文件名称可以自定义,只需要在celery.py中，列出即可</li>
</ul>
<p>下面是一个典型的celery.py的内容</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># 必须是celery名字，celery连接相关的配置(配置文件)</span>
<span style="color:#f92672">from</span> celery <span style="color:#f92672">import</span> Celery

cel <span style="color:#f92672">=</span> Celery(<span style="color:#e6db74">&#39;cel&#39;</span>,
             broker<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;redis://10.0.0.10:6379&#39;</span>,
             backend<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;redis://10.0.0.10:6379&#39;</span>,
             include<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;celery_task.tasks&#39;</span>, <span style="color:#e6db74">&#39;celery_task.account&#39;</span>])

<span style="color:#75715e"># 时区</span>
cel<span style="color:#f92672">.</span>conf<span style="color:#f92672">.</span>timezone <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Asia/Shanghai&#39;</span>

<span style="color:#75715e"># 使用使用UTC</span>
cel<span style="color:#f92672">.</span>conf<span style="color:#f92672">.</span>enable_utc <span style="color:#f92672">=</span> False
</code></pre></div><ul>
<li>include列表中，包含所有task的文件名称即可，注意要从celery_task目录开始写起。</li>
<li>调用时，可以在celery_task目录同级目录，来导入task函数，来传递任务。</li>
</ul>
<h2 id="41-运行">4.1 运行</h2>
<p>需要注意的是必须在celery_task目录同级目录下，执行命令运行worker服务</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">celery <span style="color:#f92672">-</span>A celery_task worker <span style="color:#f92672">-</span>l info
</code></pre></div><h2 id="42-后台启动多进程celery-work">4.2 后台启动多进程celery work</h2>
<p>前面的启动方法一次只能启动一个，会在前台显示并打印日志，终端退出，那么celery进程也会退出，当然我们可以使用&amp;来进行后台启动，日志可以使用-q来禁止输出，但是这毕竟不是最佳方法，官方提供了多进程后台的启动方式利用 celery  multi 启动</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># 后台启动 celery worker进程</span>
 
celery multi start work_1 <span style="color:#f92672">-</span>A appcelery 
 
<span style="color:#75715e"># work_1 为woker的名称，可以用来进行对该进程进行管理</span>
</code></pre></div><h2 id="43-常用其他命令">4.3 常用其他命令</h2>
<p>多进程相关</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># 停止worker进程,有的时候这样无法停止进程，就需要加上-A 项目名，才可以删掉</span>
celery multi stop WOERNAME      

<span style="color:#75715e"># 重启worker进程</span>
celery multi restart WORKNAME       

<span style="color:#75715e"># 查看该项目运行的进程数</span>
celery status <span style="color:#f92672">-</span>A celery_task      
</code></pre></div><h1 id="5-celery的定时任务">5 Celery的定时任务</h1>
<p>        celery支持定时任务，设定好任务的执行时间，celery就会定时自动帮你执行， 这个定时任务模块叫celery beat，类似于Linux中的crontab。主要有两种类型：每隔多久执行一次或者定期执行。</p>
<p>        由于是定期执行，所以celery的定时任务主要有两类进程，即完成任务的worker进程和分发任务的beat进程。</p>
<p>下面是一个定时任务程序</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> celery <span style="color:#f92672">import</span> Celery
<span style="color:#f92672">from</span> celery.schedules <span style="color:#f92672">import</span> crontab
 
app <span style="color:#f92672">=</span> Celery(<span style="color:#e6db74">&#39;celeryperiodoc&#39;</span>,
    broker<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;redis://10.0.0.10:6379/0&#34;</span>,
    backend<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;redis://10.0.0.10:6379/1&#34;</span>
)
 
<span style="color:#a6e22e">@app.on_after_configure.connect</span>        <span style="color:#75715e"># 定时任务必须要用的装饰器</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">setup_periodic_tasks</span>(sender, <span style="color:#f92672">**</span>kwargs):      <span style="color:#75715e"># sender是必须传递的参数，类似于django的requests一样</span>
    <span style="color:#75715e"># Calls test(&#39;hello&#39;) every 10 seconds.</span>
    sender<span style="color:#f92672">.</span>add_periodic_task(<span style="color:#ae81ff">10.0</span>, test<span style="color:#f92672">.</span>s(<span style="color:#e6db74">&#39;hello&#39;</span>), name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;add every 10&#39;</span>)    <span style="color:#75715e"># 添加一个定时任务，10.0表示每隔10秒，test.s表示给test函数传递的参数，name表示任务名称</span>
 
    <span style="color:#75715e"># Calls test(&#39;world&#39;) every 30 seconds</span>
    sender<span style="color:#f92672">.</span>add_periodic_task(<span style="color:#ae81ff">30.0</span>, test<span style="color:#f92672">.</span>s(<span style="color:#e6db74">&#39;world&#39;</span>), expires<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)
 
    <span style="color:#75715e"># Executes every Thureday at 19:52 p.m.</span>
    sender<span style="color:#f92672">.</span>add_periodic_task(          
        crontab(hour<span style="color:#f92672">=</span><span style="color:#ae81ff">19</span>, minute<span style="color:#f92672">=</span><span style="color:#ae81ff">52</span>,day_of_week<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;thu&#39;</span>),      <span style="color:#75715e"># 利用crontab设定定时执行</span>
        test<span style="color:#f92672">.</span>s(<span style="color:#e6db74">&#39;Happy Mondays!&#39;</span>),
    )
 
<span style="color:#a6e22e">@app.task</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test</span>(arg):
    <span style="color:#66d9ef">print</span>(arg)
</code></pre></div><p>启动一个beat进程：celery -A celeryFIleName beat</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"> [root<span style="color:#a6e22e">@namenode</span> celerymodule]<span style="color:#75715e"># celery -A celeryperiodoc beat</span>
celery beat v4<span style="color:#f92672">.</span><span style="color:#ae81ff">1.0</span> (latentcall) <span style="color:#f92672">is</span> starting<span style="color:#f92672">.</span>
__    <span style="color:#f92672">-</span>    <span style="color:#f92672">...</span> __   <span style="color:#f92672">-</span>        _
LocalTime <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">2017</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span> <span style="color:#ae81ff">20</span>:<span style="color:#ae81ff">13</span>:<span style="color:#ae81ff">54</span>
Configuration <span style="color:#f92672">-&gt;</span>
    <span style="color:#f92672">.</span> broker <span style="color:#f92672">-&gt;</span> redis:<span style="color:#f92672">//</span><span style="color:#ae81ff">10.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0.10</span>:<span style="color:#ae81ff">6379</span><span style="color:#f92672">/</span><span style="color:#ae81ff">0</span>
    <span style="color:#f92672">.</span> loader <span style="color:#f92672">-&gt;</span> celery<span style="color:#f92672">.</span>loaders<span style="color:#f92672">.</span>app<span style="color:#f92672">.</span>AppLoader
    <span style="color:#f92672">.</span> scheduler <span style="color:#f92672">-&gt;</span> celery<span style="color:#f92672">.</span>beat<span style="color:#f92672">.</span>PersistentScheduler
    <span style="color:#f92672">.</span> db <span style="color:#f92672">-&gt;</span> celerybeat<span style="color:#f92672">-</span>schedule
    <span style="color:#f92672">.</span> logfile <span style="color:#f92672">-&gt;</span> [stderr]<span style="color:#960050;background-color:#1e0010">@</span><span style="color:#f92672">%</span>WARNING
    <span style="color:#f92672">.</span> maxinterval <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">5.00</span> minutes (<span style="color:#ae81ff">300</span>s)
</code></pre></div><p>启动一个worker进程： celery -A celeryFIleName worker</p>
<p>日志结果</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">[<span style="color:#ae81ff">2017</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span> <span style="color:#ae81ff">20</span>:<span style="color:#ae81ff">24</span>:<span style="color:#ae81ff">14</span>,<span style="color:#ae81ff">267</span>: INFO<span style="color:#f92672">/</span>MainProcess] Received task: celeryperiodoc<span style="color:#f92672">.</span>test[<span style="color:#ae81ff">641</span>d0e17<span style="color:#f92672">-</span>ff26<span style="color:#f92672">-</span><span style="color:#ae81ff">4791</span><span style="color:#f92672">-</span>acca<span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>c0cce8d6709] 
[<span style="color:#ae81ff">2017</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span> <span style="color:#ae81ff">20</span>:<span style="color:#ae81ff">24</span>:<span style="color:#ae81ff">14</span>,<span style="color:#ae81ff">269</span>: WARNING<span style="color:#f92672">/</span>ForkPoolWorker<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] hello
[<span style="color:#ae81ff">2017</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span> <span style="color:#ae81ff">20</span>:<span style="color:#ae81ff">24</span>:<span style="color:#ae81ff">14</span>,<span style="color:#ae81ff">276</span>: INFO<span style="color:#f92672">/</span>ForkPoolWorker<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] Task celeryperiodoc<span style="color:#f92672">.</span>test[<span style="color:#ae81ff">641</span>d0e17<span style="color:#f92672">-</span>ff26<span style="color:#f92672">-</span><span style="color:#ae81ff">4791</span><span style="color:#f92672">-</span>acca<span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>c0cce8d6709] succeeded <span style="color:#f92672">in</span> <span style="color:#ae81ff">0.007056772010400891</span>s: None
 
[<span style="color:#ae81ff">2017</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span> <span style="color:#ae81ff">20</span>:<span style="color:#ae81ff">24</span>:<span style="color:#ae81ff">24</span>,<span style="color:#ae81ff">269</span>: INFO<span style="color:#f92672">/</span>MainProcess] Received task: celeryperiodoc<span style="color:#f92672">.</span>test[<span style="color:#ae81ff">25</span>b3ea6a<span style="color:#f92672">-</span><span style="color:#ae81ff">0405</span><span style="color:#f92672">-</span><span style="color:#ae81ff">4431</span><span style="color:#f92672">-</span>a1e1<span style="color:#f92672">-</span><span style="color:#ae81ff">840</span>f5dbdc57e]   expires:[<span style="color:#ae81ff">2017</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span> <span style="color:#ae81ff">12</span>:<span style="color:#ae81ff">24</span>:<span style="color:#ae81ff">34.266983</span><span style="color:#f92672">+</span><span style="color:#ae81ff">00</span>:<span style="color:#ae81ff">00</span>]
[<span style="color:#ae81ff">2017</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span> <span style="color:#ae81ff">20</span>:<span style="color:#ae81ff">24</span>:<span style="color:#ae81ff">24</span>,<span style="color:#ae81ff">270</span>: WARNING<span style="color:#f92672">/</span>ForkPoolWorker<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] world
[<span style="color:#ae81ff">2017</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span> <span style="color:#ae81ff">20</span>:<span style="color:#ae81ff">24</span>:<span style="color:#ae81ff">24</span>,<span style="color:#ae81ff">271</span>: INFO<span style="color:#f92672">/</span>ForkPoolWorker<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] Task celeryperiodoc<span style="color:#f92672">.</span>test[<span style="color:#ae81ff">25</span>b3ea6a<span style="color:#f92672">-</span><span style="color:#ae81ff">0405</span><span style="color:#f92672">-</span><span style="color:#ae81ff">4431</span><span style="color:#f92672">-</span>a1e1<span style="color:#f92672">-</span><span style="color:#ae81ff">840</span>f5dbdc57e] succeeded <span style="color:#f92672">in</span> <span style="color:#ae81ff">0.0009060979355126619</span>s: None
 
[<span style="color:#ae81ff">2017</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span> <span style="color:#ae81ff">20</span>:<span style="color:#ae81ff">24</span>:<span style="color:#ae81ff">24</span>,<span style="color:#ae81ff">271</span>: INFO<span style="color:#f92672">/</span>MainProcess] Received task: celeryperiodoc<span style="color:#f92672">.</span>test[b5dce374<span style="color:#f92672">-</span><span style="color:#ae81ff">4596</span><span style="color:#f92672">-</span><span style="color:#ae81ff">4282</span><span style="color:#f92672">-</span><span style="color:#ae81ff">987</span>a<span style="color:#f92672">-</span><span style="color:#ae81ff">494e2</span>ede365c] 
[<span style="color:#ae81ff">2017</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span> <span style="color:#ae81ff">20</span>:<span style="color:#ae81ff">24</span>:<span style="color:#ae81ff">24</span>,<span style="color:#ae81ff">273</span>: WARNING<span style="color:#f92672">/</span>ForkPoolWorker<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] hello
[<span style="color:#ae81ff">2017</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span> <span style="color:#ae81ff">20</span>:<span style="color:#ae81ff">24</span>:<span style="color:#ae81ff">24</span>,<span style="color:#ae81ff">273</span>: INFO<span style="color:#f92672">/</span>ForkPoolWorker<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] Task celeryperiodoc<span style="color:#f92672">.</span>test[b5dce374<span style="color:#f92672">-</span><span style="color:#ae81ff">4596</span><span style="color:#f92672">-</span><span style="color:#ae81ff">4282</span><span style="color:#f92672">-</span><span style="color:#ae81ff">987</span>a<span style="color:#f92672">-</span><span style="color:#ae81ff">494e2</span>ede365c] succeeded <span style="color:#f92672">in</span> <span style="color:#ae81ff">0.0006978920428082347</span>s: None
 
[<span style="color:#ae81ff">2017</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span> <span style="color:#ae81ff">20</span>:<span style="color:#ae81ff">24</span>:<span style="color:#ae81ff">34</span>,<span style="color:#ae81ff">270</span>: INFO<span style="color:#f92672">/</span>MainProcess] Received task: celeryperiodoc<span style="color:#f92672">.</span>test[<span style="color:#ae81ff">1</span>a67a24a<span style="color:#f92672">-</span><span style="color:#ae81ff">034</span><span style="color:#ae81ff">8</span><span style="color:#f92672">-</span><span style="color:#ae81ff">416</span>d<span style="color:#f92672">-</span>a4c0<span style="color:#f92672">-</span>fc033108cda1] 
[<span style="color:#ae81ff">2017</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span> <span style="color:#ae81ff">20</span>:<span style="color:#ae81ff">24</span>:<span style="color:#ae81ff">34</span>,<span style="color:#ae81ff">271</span>: WARNING<span style="color:#f92672">/</span>ForkPoolWorker<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] hello
[<span style="color:#ae81ff">2017</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span> <span style="color:#ae81ff">20</span>:<span style="color:#ae81ff">24</span>:<span style="color:#ae81ff">34</span>,<span style="color:#ae81ff">272</span>: INFO<span style="color:#f92672">/</span>ForkPoolWorker<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] Task celeryperiodoc<span style="color:#f92672">.</span>test[<span style="color:#ae81ff">1</span>a67a24a<span style="color:#f92672">-</span><span style="color:#ae81ff">034</span><span style="color:#ae81ff">8</span><span style="color:#f92672">-</span><span style="color:#ae81ff">416</span>d<span style="color:#f92672">-</span>a4c0<span style="color:#f92672">-</span>fc033108cda1] succeeded <span style="color:#f92672">in</span> <span style="color:#ae81ff">0.0008945289300754666</span>s: None
 
[<span style="color:#ae81ff">2017</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span> <span style="color:#ae81ff">20</span>:<span style="color:#ae81ff">24</span>:<span style="color:#ae81ff">44</span>,<span style="color:#ae81ff">272</span>: INFO<span style="color:#f92672">/</span>MainProcess] Received task: celeryperiodoc<span style="color:#f92672">.</span>test[e6853e92<span style="color:#f92672">-</span><span style="color:#ae81ff">9</span>c42<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>c49<span style="color:#f92672">-</span><span style="color:#ae81ff">8148</span><span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>d575268f3a7] 
[<span style="color:#ae81ff">2017</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span> <span style="color:#ae81ff">20</span>:<span style="color:#ae81ff">24</span>:<span style="color:#ae81ff">44</span>,<span style="color:#ae81ff">273</span>: WARNING<span style="color:#f92672">/</span>ForkPoolWorker<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] hello
[<span style="color:#ae81ff">2017</span><span style="color:#f92672">-</span><span style="color:#ae81ff">12</span><span style="color:#f92672">-</span><span style="color:#ae81ff">26</span> <span style="color:#ae81ff">20</span>:<span style="color:#ae81ff">24</span>:<span style="color:#ae81ff">44</span>,<span style="color:#ae81ff">274</span>: INFO<span style="color:#f92672">/</span>ForkPoolWorker<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] Task celeryperiodoc<span style="color:#f92672">.</span>test[e6853e92<span style="color:#f92672">-</span><span style="color:#ae81ff">9</span>c42<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>c49<span style="color:#f92672">-</span><span style="color:#ae81ff">8148</span><span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>d575268f3a7] succeeded <span style="color:#f92672">in</span> <span style="color:#ae81ff">0.0009920489974319935</span>s: None
</code></pre></div><ul>
<li>观察hello的输出间隔，发现是每隔10秒输出一次</li>
<li>观察world的输出间隔，可以看出是每隔30秒输出一次</li>
</ul>
<p>其他:执行完毕后会在当前目录下产生一个二进制文件celerybeat-schedule,该文件用于存放上次执行结果：</p>
<ul>
<li>如果存在celerybeat-schedule文件，那么读取后根据上一次执行的时间，继续执行。</li>
<li>如果不存在celerybeat-schedule文件，那么会立即执行一次。</li>
<li>如果存在celerybeat-schedule文件，读取后，发现间隔时间已过，那么会立即执行。</li>
</ul>
<h1 id="6-在django中集成celery">6 在django中集成celery</h1>
<p>最常用的场景，应该就是用户注册时的发送邮件了，下面以完成邮件发送为目的来，编写celery任务</p>
<h2 id="61-编写celerypy配置文件">6.1 编写celery.py配置文件</h2>
<p>在项目的目录下(与settings.py文件同级)，创建celery文件</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> __future__ <span style="color:#f92672">import</span> absolute_import, unicode_literals
<span style="color:#f92672">import</span> os
<span style="color:#f92672">from</span> celery <span style="color:#f92672">import</span> Celery

<span style="color:#75715e"># set the default Django settings module for the &#39;celery&#39; program.</span>
os<span style="color:#f92672">.</span>environ<span style="color:#f92672">.</span>setdefault(<span style="color:#e6db74">&#39;DJANGO_SETTINGS_MODULE&#39;</span>, <span style="color:#e6db74">&#39;stu_crm.settings&#39;</span>)

app <span style="color:#f92672">=</span> Celery(<span style="color:#e6db74">&#39;stu_crm&#39;</span>)

<span style="color:#75715e"># Using a string here means the worker doesn&#39;t have to serialize</span>
<span style="color:#75715e"># the configuration object to child processes.</span>
<span style="color:#75715e"># - namespace=&#39;CELERY&#39; means all celery-related configuration keys</span>
<span style="color:#75715e">#   should have a `CELERY_` prefix.</span>
app<span style="color:#f92672">.</span>config_from_object(<span style="color:#e6db74">&#39;django.conf:settings&#39;</span>, namespace<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;CELERY&#39;</span>)

<span style="color:#75715e"># Load task modules from all registered Django app configs.</span>
app<span style="color:#f92672">.</span>autodiscover_tasks()

<span style="color:#75715e"># ------------------------------------</span>
<span style="color:#75715e">## 后面的是celery的配置信息，可以放在setting.py中，通过配置来调用</span>
app<span style="color:#f92672">.</span>conf<span style="color:#f92672">.</span>update(utc_time<span style="color:#f92672">=</span>True, timezone<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Asia/Shanghai&#39;</span>)
app<span style="color:#f92672">.</span>conf<span style="color:#f92672">.</span>broker_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;redis://:daxin@10.0.0.10:6379/0&#39;</span>
app<span style="color:#f92672">.</span>conf<span style="color:#f92672">.</span>result_backend <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;redis://:daxin@10.0.0.10:6379/1&#39;</span>
app<span style="color:#f92672">.</span>conf<span style="color:#f92672">.</span>broker_transport_option <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;visibility_timeout&#39;</span>: <span style="color:#ae81ff">3600</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">12</span>}
</code></pre></div><h2 id="62-编写__init__py文件">6.2 编写__init__.py文件</h2>
<p>需要修改项目的__init__.py文件，添加如下内容</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> __future__ <span style="color:#f92672">import</span> absolute_import, unicode_literals

<span style="color:#75715e"># This will make sure the app is always imported when</span>
<span style="color:#75715e"># Django starts so that shared_task will use this app.</span>
<span style="color:#f92672">from</span> .celery <span style="color:#f92672">import</span> app <span style="color:#66d9ef">as</span> celery_app

__all__ <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;celery_app&#39;</span>,)
</code></pre></div><h2 id="63-编写taskspy文件发送邮件">6.3 编写tasks.py文件(发送邮件)</h2>
<p>在各个项目内，创建tasks.py文件，针对不同的项目编写不同的task任务</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># 需要引入</span>
<span style="color:#f92672">from</span> __future__ <span style="color:#f92672">import</span> absolute_import, unicode_literals
<span style="color:#75715e"># 通过app.task来标识celery任务函数，也可以使用from celery import shared_task，shared_task来装饰</span>
<span style="color:#f92672">from</span> stu_crm.celery <span style="color:#f92672">import</span> app
<span style="color:#f92672">from</span> django.conf <span style="color:#f92672">import</span> settings
<span style="color:#f92672">from</span> django.core.mail <span style="color:#f92672">import</span> send_mail

<span style="color:#75715e"># @shared_task(name=&#39;send&#39;)</span>
<span style="color:#a6e22e">@app.task</span>(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;send&#39;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sendmail</span>():
    send_mail(
        subject<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Test测试邮件&#39;</span>,
        message<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;这是一封测试邮件&#39;</span>,
        from_email<span style="color:#f92672">=</span>settings<span style="color:#f92672">.</span>EMAIL_HOST_USER,
        recipient_list<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;287990400@qq.com&#39;</span>],
        fail_silently<span style="color:#f92672">=</span>False
    )
</code></pre></div><p>这里利用了django的提供的邮件发送功能，所以需要添加如下关于邮箱的配置，在settings.py中</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">EMAIL_HOST_USER <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;beyondlee2011@126.com&#39;</span>
EMAIL_PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">465</span>
EMAIL_HOST_PASSWORD <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;xxxxxxxxxxx&#39;</span>
EMAIL_HOST <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;smtp.126.com&#39;</span>
EMAIL_USE_SSL <span style="color:#f92672">=</span> True   <span style="color:#75715e"># 是否使用SSL</span>
EMAIL_USE_TLS <span style="color:#f92672">=</span> False
</code></pre></div><p>当然也可以使用yagmail来发送邮件：<a href="http://www.cnblogs.com/dachenzi/p/8655022.html">yagmail发送邮件</a></p>
<h2 id="64-编写views视图函数">6.4 编写views视图函数</h2>
<p>通过视图函数来模拟调用过程。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> .tasks <span style="color:#f92672">import</span> sendmail

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send</span>(request):
    <span style="color:#66d9ef">try</span>:
        sendmail<span style="color:#f92672">.</span>delay()
        <span style="color:#75715e"># add.delay(10, 20)</span>
    <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
        <span style="color:#66d9ef">return</span> HttpResponse(e)
    <span style="color:#66d9ef">return</span> HttpResponse(<span style="color:#e6db74">&#39;ok&#39;</span>)
</code></pre></div><h2 id="65-启动worker">6.5 启动worker</h2>
<p>发布任务的流程已经创建完毕，接下来，就需要启动worker来监控broker获取任务并执行了。
在manage.py同级目录下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">celery <span style="color:#f92672">-</span>A crm worker <span style="color:#f92672">-</span>l info
</code></pre></div><p>这样就完成了启动。接下来只需要访问定义好的url，那么就可以发布任务了。
{% endraw %}</p>

  </div>
  <div id="disqus_thread"></div>
</div>


<script type="text/javascript">
var disqus_shortname = "your_disqus_shortname";
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>



<script type="text/javascript">
    var disqus_shortname = "your_disqus_shortname";
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<script src="https://dachenzi.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

