<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>1-ansible  &middot; dahl&#39;s blog</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="" />

<meta name="keywords" content="">


<meta property="og:title" content="1-ansible  &middot; dahl&#39;s blog ">
<meta property="og:site_name" content="dahl&#39;s blog"/>
<meta property="og:url" content="https://dachenzi.github.io/1/01/01/1-ansible/" />
<meta property="og:locale" content="en-EN">


<meta property="og:type" content="article" />
<meta property="og:description" content=""/>
<meta property="og:article:published_time" content="0001-01-01T00:00:00Z" />
<meta property="og:article:modified_time" content="0001-01-01T00:00:00Z" />

  
    
  

  

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "1-ansible",
    "author": {
      "@type": "Person",
      "name": "daxin.li"
    },
    "datePublished": "0001-01-01",
    "description": "",
    "wordCount":  1575 
  }
</script>



<link rel="canonical" href="https://dachenzi.github.io/1/01/01/1-ansible/" />

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://dachenzi.github.io/touch-icon-144-precomposed.png">
<link href="https://dachenzi.github.io/favicon.png" rel="icon">

<meta name="generator" content="Hugo 0.75.1" />

  <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link href='https://fonts.googleapis.com/css?family=Merriweather:300%7CRaleway%7COpen+Sans' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/highlight/default.css">

  
  
	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'Your Google Analytics tracking code', 'auto');
	  ga('send', 'pageview');

	</script>

</head>
<body>
  <main id="main-wrapper" class="container main_wrapper has-sidebar">
    <header id="main-header" class="container main_header">
  <div class="container brand">
  <div class="container title h1-like">
  <a class="baselink" href="https://dachenzi.github.io">
  foobar

</a>

</div>

  
<div class="container topline">
  
  few words about your site


</div>


</div>

  <nav class="container nav primary no-print">
  

<a class="homelink" href="https://dachenzi.github.io">home</a>


  

</nav>

<div class="container nav secondary no-print">
  
<a id="contact-link-email" class="contact_link" rel="me" aria-label="Email" href="mailto:dahlhin.li@gmail.com">
  <span class="fa fa-envelope-square"></span></a>



<a id="contact-link-github" class="contact_link" rel="me" aria-label="Github" href="https://github.com/enten/hugo-boilerplate">
  <span class="fa fa-github-square"></span></a>




 


















</div>


  

</header>


<article id="main-content" class="container main_content single">
  <header class="container hat">
  <h1>1-ansible
</h1>

  <div class="metas">
<time datetime="0001-01-01">1 Jan, 0001</time>


  
  &middot; Read in about 8 min
  &middot; (1575 Words)
  <br>
  


</div>

</header>

  <div class="container content">
  <p>{% raw %}</p>
<p><!-- raw HTML omitted --><strong>文章目录</strong><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<ul>
<li><a href="#1-%E7%AE%80%E4%BB%8B">1 简介</a>
<ul>
<li><a href="#11-%E5%9F%BA%E6%9C%AC%E7%BB%84%E6%88%90">1.1 基本组成</a></li>
<li><a href="#12-%E5%91%BD%E4%BB%A4%E4%BB%8B%E7%BB%8D">1.2 命令介绍</a></li>
<li><a href="#13-inventory%E6%96%87%E4%BB%B6%E4%BB%8B%E7%BB%8D">1.3 Inventory文件介绍</a></li>
</ul>
</li>
<li><a href="#2-ansible%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E4%BB%8B%E7%BB%8D">2 Ansible配置文件介绍</a>
<ul>
<li><a href="#21-%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE">2.1 常用配置</a></li>
<li><a href="#22-ssh%E7%9B%B8%E5%85%B3">2.2 ssh相关</a></li>
<li><a href="#23-%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87%E7%9B%B8%E5%85%B3">2.3 权限提升相关</a></li>
</ul>
</li>
<li><a href="#3-%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97">3 常用模块</a>
<ul>
<li><a href="#31-setup">3.1 setup</a></li>
<li><a href="#32-file">3.2 file</a></li>
<li><a href="#33-copy">3.3 copy</a></li>
<li><a href="#34-command">3.4 command</a></li>
<li><a href="#35-shell">3.5 shell</a></li>
<li><a href="#36-service">3.6 service</a></li>
<li><a href="#37-cron">3.7 cron</a></li>
<li><a href="#38-filesystem">3.8 filesystem</a></li>
<li><a href="#39-yum">3.9 yum</a></li>
<li><a href="#310-user">3.10 user</a></li>
<li><a href="#311-synchronize">3.11 synchronize</a></li>
<li><a href="#312-mount">3.12 mount</a></li>
<li><a href="#312-template">3.12 template</a></li>
<li><a href="#313-get_url">3.13 get_url</a></li>
<li><a href="#314-unarchive">3.14 unarchive</a></li>
<li><a href="#315-git">3.15 git</a></li>
<li><a href="#316-stat">3.16 stat</a></li>
<li><a href="#317-sysctl">3.17 sysctl</a></li>
</ul>
</li>
<li><a href="#4-%E6%A8%A1%E5%9D%97%E7%9A%84%E8%BF%94%E5%9B%9E%E5%80%BC">4 模块的返回值</a></li>
<li><a href="#5-yaml%E7%AE%80%E4%BB%8B">5 YAML简介</a>
<ul>
<li><a href="#51-%E5%8F%98%E9%87%8F">5.1 变量</a>
<ul>
<li><a href="#511facts">5.1.1.facts</a></li>
<li><a href="#512-register%E6%B3%A8%E5%86%8C%E5%99%A8">5.1.2 register(注册器)</a></li>
<li><a href="#513-%E9%80%9A%E8%BF%87%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BC%A0%E9%80%92%E5%8F%98%E9%87%8F">5.1.3 通过命令行传递变量</a></li>
</ul>
</li>
<li><a href="#52-inventory">5.2 Inventory</a>
<ul>
<li><a href="#521-%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F">5.2.1 文件格式</a></li>
<li><a href="#522-%E4%B8%BB%E6%9C%BA%E5%8F%98%E9%87%8F">5.2.2 主机变量</a></li>
<li><a href="#523-%E7%BB%84%E5%8F%98%E9%87%8F">5.2.3 组变量</a></li>
<li><a href="#524-%E7%BB%84%E5%B5%8C%E5%A5%97">5.2.4 组嵌套</a></li>
<li><a href="#525-inenvtory-%E5%8F%82%E6%95%B0">5.2.5 inenvtory 参数</a></li>
</ul>
</li>
<li><a href="#53-%E6%9D%A1%E4%BB%B6%E6%B5%8B%E8%AF%95">5.3 条件测试</a></li>
<li><a href="#54-%E8%BF%AD%E4%BB%A3">5.4 迭代</a></li>
</ul>
</li>
<li><a href="#6-playbook%E7%AE%80%E4%BB%8B">6 playbook简介</a>
<ul>
<li><a href="#61-playbook%E7%9A%84%E4%B8%80%E8%88%AC%E7%BB%93%E6%9E%84">6.1 playbook的一般结构</a></li>
<li><a href="#62-target-%E9%85%8D%E7%BD%AE%E9%A1%B9%E7%9B%AE">6.2 target 配置项目</a></li>
<li><a href="#63-variable-%E5%8F%AF%E7%94%A8%E7%9A%84%E9%85%8D%E7%BD%AE%E9%A1%B9%E7%9B%AE">6.3 variable 可用的配置项目</a></li>
<li><a href="#64-task-%E9%85%8D%E7%BD%AE%E9%A1%B9%E7%9B%AE">6.4 task 配置项目</a></li>
<li><a href="#65-handler-%E9%85%8D%E7%BD%AE%E9%A1%B9%E7%9B%AE">6.5 handler 配置项目</a></li>
<li><a href="#66-ansible-playbook%E5%91%BD%E4%BB%A4">6.6 ansible-playbook命令</a></li>
<li><a href="#67-%E5%85%B6%E4%BB%96%E9%85%8D%E7%BD%AE">6.7 其他配置</a></li>
</ul>
</li>
<li><a href="#7-roles">7 Roles</a>
<ul>
<li><a href="#71-role%E5%86%85%E5%90%84%E7%9B%AE%E5%BD%95%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E">7.1 role内各目录中的文件说明</a></li>
<li><a href="#72-ansible-galaxy-%E5%91%BD%E4%BB%A4">7.2 ansible-galaxy 命令</a></li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<h1 id="1-简介">1 简介</h1>
<p>        高度模块化，调用特定的模块，完成特定的任务，基于Yaml，来完成批量任务的模板化，来支持playbook。基于Python语言实现，主要使用Paramiko、PyYAML和JinJa2三个关键模块，部署简单(agentless)，主从模式，支持自定义模块，支持playbook，幂等性：允许重复执行N次，没有变化时，只会执行第一次。<br>
特点：</p>
<ol>
<li>Configuration(cfengine,chef,puppet) 配置管理</li>
<li>Deployment(Capistrano,Fabric) 部署发布</li>
<li>Ad-Host Task(func) 命令行批量执行</li>
<li>Multi-Ter Orchestration(Juju,sort of) 多层次任务编排</li>
</ol>
<p>PS：集成了上面括号中的工具的主要功能</p>
<h2 id="11-基本组成">1.1 基本组成</h2>
<p>主要由模块、插件、主机群、以及剧本的组成，各部分含义如下：</p>
<ol>
<li>核心模块(core modules):Ansible 自带的模块。</li>
<li>自定义模块(custom Modules)：如果核心模块不足以完成某种功能，可以自行添加自定义模块(支持市面上大部分的编程语言)。</li>
<li>插件(Plugins)：支持使用插件的方式对ansible本身的功能进行扩展。模块是用来实现任务的，增强ansible平台自己的功能就需要使用插件（loggin插件记录日志，email插件发送邮件）
<ul>
<li>其中最常用是：连接插件(Connectior Plugins) ：ansibile基于连接插件连接到各个主机上，虽然默认情况下ansible使用ssh连接到各个主机上，但它还支持其他的连接方法(mq)。</li>
</ul>
</li>
<li>主机群(Host Inventory): 主机清单，定义ansible管理的主机，还可以存放一下针对不同主机的变量，也可以写入主机的用户名和密码</li>
<li>剧本(playbooks)：ansible的任务配置文件，将多个任务定义在剧本中，由ansible自动执行</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">yum install -y ansible
pip3 install ansible
</code></pre></div><p>运行原理：把命令翻译成shell命令，拷贝到目标主机(/root/.ansible/tmp/下)，再执行，执行完毕后删除tmp文件。</p>
<h2 id="12-命令介绍">1.2 命令介绍</h2>
<p>ansible 命令主要参数信息</p>
<ul>
<li>-u : remote user，默认使用root用户登陆</li>
<li>-i : Inventory，指定主机，默认是/etc/ansible/hosts</li>
<li>-m ：指定模块的名称（不指定-m，那么默认是command模块）</li>
<li>-a : 模块的参数(比如使用command模块，那么-a参数就是要执行的命令)</li>
<li>-k : 用来提示输入远程主机的密码(基于用户密码登录)</li>
<li>-f : 一次执行几个进程(并发数量)，默认为5个</li>
<li>&ndash;sudo : 执行命令时使用 sudo 权限(需要用户具有sudo权限)</li>
<li>&ndash;key-file: 建立SSH链接的私钥文件</li>
<li>&ndash;list-hosts: 列出匹配到的服务器列表</li>
</ul>
<p>基于主机清单：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ansible <span style="color:#f92672">-</span>i <span style="color:#f92672">/</span>etc<span style="color:#f92672">/</span>ansible<span style="color:#f92672">/</span>hosts test <span style="color:#f92672">-</span>u root <span style="color:#f92672">-</span>m command <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#39;ls /home&#39;</span> <span style="color:#f92672">-</span>k <span style="color:#960050;background-color:#1e0010">（</span>ansible <span style="color:#960050;background-color:#1e0010">依赖</span> sshpass<span style="color:#960050;background-color:#1e0010">）</span>
<span style="color:#f92672">|</span>
<span style="color:#f92672">--&gt;</span> ansible test <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#39;ls /home&#39;</span> <span style="color:#f92672">-</span>k 

<span style="color:#75715e"># 上面两条命令默认状态下效果相同</span>

<span style="color:#75715e"># 我们知道ansible通过ssh的方式来远程管理多台主机，所以我们需要使用ssh key的方式来进行ssh认证，当然你也可以使用ansible的时候加上-k，来通过交互式输入密码。当有了ssh key以后，那么我们就可以直接使用ansbile来执行任务了,比如：ansible all -m ping </span>

<span style="color:#75715e"># 基于主机： </span>
ansible <span style="color:#ae81ff">127.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0.1</span> <span style="color:#f92672">-</span>m ping
</code></pre></div><h2 id="13-inventory文件介绍">1.3 Inventory文件介绍</h2>
<p>/etc/ansible/hosts:(默认的Inventory)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">[test]                    <span style="color:#75715e"># 用于定义主机组,all表示所有主机，所以尽量避免使用all作为组名</span>
<span style="color:#ae81ff">127.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0.1</span>                 <span style="color:#75715e"># 该组的主机列表，可以是主机名(dns解析)或者IP地址，或者用符号来表示连续的主机</span>
<span style="color:#ae81ff">192.168</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.</span>[<span style="color:#ae81ff">80</span>:<span style="color:#ae81ff">88</span>]         <span style="color:#75715e"># 表示 192.168.1.80 - 192.168.1.88</span>

[web:children]            <span style="color:#75715e"># 表示子组</span>
nginx                     <span style="color:#75715e"># nginx组</span>
test                      <span style="color:#75715e"># test组</span>
<span style="color:#960050;background-color:#1e0010">配置文件中的变量及参数：</span>

[nginx]
<span style="color:#ae81ff">127.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0.1</span> ansible_ssh_user<span style="color:#f92672">=</span>root ansible_ssh_host<span style="color:#f92672">=</span>web1 <span style="color:#75715e"># 更细致的配置</span>

    <span style="color:#f92672">-</span> ansible_ssh_user : <span style="color:#960050;background-color:#1e0010">用于指定管理远程主机的帐号</span>
    <span style="color:#f92672">-</span> ansible_ssh_host : <span style="color:#960050;background-color:#1e0010">用于指定被管理的主机</span>
    <span style="color:#f92672">-</span> ansible_ssh_port <span style="color:#960050;background-color:#1e0010">：用于指定</span>ssh的端口
    <span style="color:#f92672">-</span> ansible_ssh_private_key_file <span style="color:#960050;background-color:#1e0010">：指定</span>key文件
    <span style="color:#f92672">-</span> host_key_checking<span style="color:#f92672">=</span>False <span style="color:#960050;background-color:#1e0010">：当第一次连接主机时，会提示</span>yes<span style="color:#f92672">/</span>no<span style="color:#960050;background-color:#1e0010">，跳过此次环节</span>
</code></pre></div><h1 id="2-ansible配置文件介绍">2 Ansible配置文件介绍</h1>
<p>ansible 查找 Ansible.cfg 文件遵循以下顺序：</p>
<ol>
<li>ANSIBLE_CONFIG环境变量指定的配置文件</li>
<li>当前目录下的ansible.cfg文件</li>
<li>当前用户home目录下的.ansible.cfg文件</li>
<li>Ansible默认的/etc/ansible/ansible.cfg文件</li>
</ol>
<h2 id="21-常用配置">2.1 常用配置</h2>
<ul>
<li>inventory：指定inventory文件的路径</li>
<li>remote_user：SSH连接时使用的用户名</li>
<li>remote_port：SSH连接时使用的端口号</li>
<li>private_key_file：SSH连接时使用的私钥文件</li>
<li>roles_path：查找roles的路径，可以指定多个查找路径，多个路径之间用冒号分隔</li>
<li>log_path：Ansible的日志文件路径</li>
<li>host_key_checking：类似于ssh命令中的StrictHostKeyChecking选项，当等于False时，不检查远程主机是否存在于Konw_hosts文件中</li>
<li>forks：并行进程的数量</li>
<li>gathering：控制收集Facts变量的策略</li>
</ul>
<h2 id="22-ssh相关">2.2 ssh相关</h2>
<ul>
<li>ssh_args：可以通过这个参数控制Ansible的ssh连接</li>
<li>pipelining: 多个task之间共享SSH连接，开启pipelining能够有效提升Ansible的执行速度</li>
<li>control_path：保存ControlPath socket的路径</li>
</ul>
<h2 id="23-权限提升相关">2.3 权限提升相关</h2>
<ul>
<li>become：是否进行权限提升</li>
<li>become_method：权限提升的方式，默认为sudo</li>
<li>become_user：提升为哪个用户的权限，默认为root</li>
<li>become_ask_pass：默认为False，表示权限提升时不需要密码(设置为true时，手动输入密码，或者配置ansible_become_pass变量)</li>
</ul>
<h1 id="3-常用模块">3 常用模块</h1>
<p>查看模块的帮助：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ansible<span style="color:#f92672">-</span>doc <span style="color:#f92672">-</span>l <span style="color:#75715e"># 查看核心的模块(包含模块的大致说明,比较慢)</span>
ansible<span style="color:#f92672">-</span>doc <span style="color:#f92672">-</span>s <span style="color:#e6db74">&#39;command&#39;</span> <span style="color:#75715e"># 执行模块名，可以列出模块的用法</span>
</code></pre></div><h2 id="31-setup">3.1 setup</h2>
<p>用于统计系统的相关信息</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># 例子</span>
ansible test <span style="color:#f92672">-</span>m setup 
<span style="color:#75715e"># 参数</span>
  <span style="color:#f92672">-</span> filter<span style="color:#960050;background-color:#1e0010">：</span> <span style="color:#960050;background-color:#1e0010">过滤要显示的内容</span>
  <span style="color:#f92672">-</span> ansible test <span style="color:#f92672">-</span>m setup <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#34;filter=ansible_python_version&#34;</span> <span style="color:#f92672">-</span>k <span style="color:#75715e"># 只获取主机ansible_python_version的值</span>
  <span style="color:#f92672">-</span> <span style="color:#960050;background-color:#1e0010">更多的帮助</span> ansible<span style="color:#f92672">-</span>doc <span style="color:#f92672">-</span>s setup
</code></pre></div><h2 id="32-file">3.2 file</h2>
<p>设置文件属性,常用参数如下：</p>
<ul>
<li>force: 在两种情况下会强制创建软连接，默认值为 no</li>
<li>源文件不存在但之后会建立的情况下</li>
<li>目标软连接已存在，需要先取消之前的软连，然后创建新的软链</li>
<li>group：定义文件的属组</li>
<li>mode：定义文件的权限</li>
<li>owner：定义文件的属主</li>
<li>path：必选项，定义文件的路径</li>
<li>recurse：递归设置文件的属性，只对目录生效（-R）</li>
<li>src：要被链接的源文件的属性，只应用于state=link的情况</li>
<li>dest：被链接到的路径，只应用与state=link的情况</li>
<li>state：</li>
<li>directory：如果目录不存在创建目录</li>
<li>file：即使文件不存在，也不会被创建</li>
<li>link：创建软连接</li>
<li>hard：创建硬链接</li>
<li>touch：如果文件不存在，则会创建一个新的文件，如果文件存在，则会更新其最后修改时间</li>
<li>absent：删除目录，文件或者取消链接文件</li>
</ul>
<p>例子:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ansible test <span style="color:#f92672">-</span>m file <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#39;src=/etc/fstab dest=/tmp/fstab state=link&#39;</span> <span style="color:#f92672">-</span>k                              <span style="color:#75715e"># 等于 ln -s /etc/fstab /tmp/fstab</span>
ansible test <span style="color:#f92672">-</span>m file <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#39;path=/tmp/fstab state=absent&#39;</span> <span style="color:#f92672">-</span>k                                           <span style="color:#75715e"># 删除文件</span>
ansible test <span style="color:#f92672">-</span>m file <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#39;path=/tmp/lixin.txt state=touch owner=nobody group=nobody mode=666&#39;</span> <span style="color:#f92672">-</span>k     <span style="color:#75715e"># 创建文件指定其属主，属组，权限</span>
</code></pre></div><h2 id="33-copy">3.3 copy</h2>
<p>复制文件到远程主机，每次备份会产生一个md5sum，如果两次赋值文件的md5sum相同，那么就不会再次执行复制动作。</p>
<p>参数</p>
<ul>
<li>backup：在覆盖之前将原文件备份，备份文件名包含时间信息。有两个选项：yes | no</li>
<li>src：源文件，如果是目录的话，会递归赋值，包括目录本身，如果目录为/，那么只会复制目录下的文件</li>
<li>dest：目标文件路径</li>
<li>others：所有file模块里的选项都可以在这里使用</li>
<li>content：用于替代&rsquo;src'，可以直接设定文件的值</li>
<li>directory_mode：递归设定目录的权限，默认为系统默认权限</li>
<li>force：如果目标主机包含该文件，但内容不同，如果设置为yes，则强制覆盖，如果为no，则只有当前目标主机的目标位置不存在该文件时，才复制，默认为yes。</li>
</ul>
<p>例子</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ansible test <span style="color:#f92672">-</span>m copy <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#34;content=&#39;hello world&#39; dest=/tmp/tmp.txt&#34;</span> <span style="color:#f92672">-</span>k    <span style="color:#75715e"># 在目录主机上创建tmp.txt文件，内容为hello world</span>
</code></pre></div><h2 id="34-command">3.4 command</h2>
<p>在远程主机上执行命令。（默认模块）,参数</p>
<ul>
<li>creates：文件名，当该文件存在时，则不执行后面的命令</li>
<li>chdir：执行命令前，先修改当前路径</li>
<li>removes：文件名，当文件不存在时，则不执行后面的命令</li>
<li>executable：切换shell来执行命令，该执行路径必须是一个绝对路径</li>
</ul>
<h2 id="35-shell">3.5 shell</h2>
<p>和command模块相同，参数也相同。command，shell，raw，script模块同属于commands类，都是用来执行命令，不同的是：</p>
<ul>
<li>command模块执行的命令中不能包含：|，&lt;,&gt;,&amp; 符号。</li>
<li>shell模块:可以执行远程服务器上的shell脚本文件，也支持 管道符等，脚本需要使用绝对路径。</li>
<li>raw模块和shell模块相同，可以执行任意命令就像在本机一样，相当于ssh之直接执行Linux命令，不会进入到ansible的模块子系统中。</li>
<li>script模块，用来执行一个shell脚本，其实将管理端的shell脚本copy到被管理端上然后执行，相当于 scp + shell 的组合。(需要在脚本所在目录下执行)</li>
</ul>
<p>PS:官方建议使用command模块，如果需求不满足，可以使用raw模块</p>
<h2 id="36-service">3.6 service</h2>
<p>用于管理服务,参数</p>
<ul>
<li>arguments: 给命令行提供一些选项</li>
<li>enable：是否开机启动 yes | no</li>
<li>name：服务名称</li>
<li>pattern：定义一个模式，如果通过status命令来查看服务的状态时，没有响应，就会通过ps指令在进程中根据该模式进行查找，如果匹配到，则认为该服务已经在运行，否则会认为未启动( ps aux | grep <code>pattern</code> )</li>
<li>runlevel：运行级别</li>
<li>sleep：如果执行了，restarted，则在 stop 和 start 之间沉睡几秒钟</li>
<li>state：started、stoped、restarted和reloaded，其中started和stoped是幂等的，也就是说如果服务已经停止，那么运行stoped不会执行任何操作</li>
</ul>
<p>例子</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ansible test <span style="color:#f92672">-</span>m service <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#39;name=nginx state=started enabled=yes&#39;</span> <span style="color:#f92672">-</span>k                   <span style="color:#75715e"># 启动nginx进程，并设置为开机启动</span>
ansible test <span style="color:#f92672">-</span>m service <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#39;name=nginx state=stopped&#39;</span> <span style="color:#f92672">-</span>k                               <span style="color:#75715e"># 关闭nginx进程</span>
ansible test <span style="color:#f92672">-</span>m service <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#39;name=network state=restarted arguments=eth0&#39;</span> <span style="color:#f92672">-</span>k            <span style="color:#75715e"># 重启network进程，并传递eth0 作为参数，即：重启eth0网卡</span>
ansible test <span style="color:#f92672">-</span>m service <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#39;name=nginx pattern=/usr/local/nginx state=started&#39;</span> <span style="color:#f92672">-</span>k      <span style="color:#75715e"># 如果无法使用 service nginx status查寻到nginx的状态，那么会使用 ps 来过滤 pattern指定的关键字，如果存在，则表示程序已经正常启动　</span>
</code></pre></div><h2 id="37-cron">3.7 cron</h2>
<p>用于管理定时任务(crontab 来操作),参数</p>
<ul>
<li>backup: 对远程主机上的原计划内容修改之前做备份</li>
<li>cront_file: 如果指定该选项，则用该文件替换远程主机上的cron.d目录下的用户计划任务</li>
<li>day: 日(1-31,<em>,</em>/2,&hellip;&hellip;)</li>
<li>hour: 小时(0-23,<em>,</em>/2,&hellip;&hellip;)</li>
<li>minute: 分钟(0-59,<em>,</em>/2,&hellip;&hellip;)</li>
<li>mouth: 月(1-12,<em>,</em>/2,&hellip;&hellip;)</li>
<li>weekday: 周(0-7,*,&hellip;&hellip;)</li>
<li>job: 要执行的任务，依赖于state=present</li>
<li>name: 该任务的描述，必选项。</li>
<li>special_time：指定什么时候执行（被触发），参数：reboot，yearly，annually，monthly，weekly，daily，hourly。</li>
<li>state：确认该任务计划是创建还是删除 Present(启用) | Absent(停用)</li>
<li>user：以哪个用户的身份执行</li>
</ul>
<p>例子</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ansible test <span style="color:#f92672">-</span>m cron <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#34;hour=3 month=2 day=1 job=&#39;echo hello&#39; name=&#39;test&#39; state=present &#34;</span> <span style="color:#f92672">-</span>k  <span style="color:#75715e"># 添加一条定时任务，* 3 1 2 * echo hello</span>
ansible test <span style="color:#f92672">-</span>m cron <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#39;name=test state=absent&#39;</span> <span style="color:#f92672">-</span>k                                            <span style="color:#75715e"># 删除name为test的计划任务</span>
</code></pre></div><h2 id="38-filesystem">3.8 filesystem</h2>
<p>用于在块设备上创建文件系统。参数</p>
<ul>
<li>dev：目标块设备</li>
<li>force：在一个已有的文件系统的设备上强制创建</li>
<li>fstype：文件系统类型</li>
<li>opts：传递给mkfs命令的选项</li>
</ul>
<h2 id="39-yum">3.9 yum</h2>
<p>使用yum包管理软件包,参数</p>
<ul>
<li>config_file：yum的配置文件</li>
<li>disable_gpg_check: 关闭gpg_check</li>
<li>disablerepo: 不启用某个源</li>
<li>enablerepo：启用某个源</li>
<li>list：列出repo源</li>
<li>name：软件包的名称，可以为一个url路径，或者本地一个rpm包的路径</li>
<li>state：状态
<ul>
<li>安装：
<ul>
<li>present</li>
<li>installed *</li>
<li>latest</li>
</ul>
</li>
<li>删除：
<ul>
<li>absent</li>
<li>removed *</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>例子</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ansible test <span style="color:#f92672">-</span>m yum <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#39;name=httpd state=installed&#39;</span> <span style="color:#f92672">-</span>k     <span style="color:#75715e"># yum 安装 httpd　　</span>
</code></pre></div><h2 id="310-user">3.10 user</h2>
<p>用于管理用户（useradd,userdel） 也可以用command模块来执行shell命令创建和管理用户,参数</p>
<ul>
<li>home：指定用户的家目录</li>
<li>createhome: 是否创建用户家目录 yes | no</li>
<li>groups：用户的属组</li>
<li>uid：用户的uid</li>
<li>password：用户的密码</li>
<li>name：用户的名称</li>
<li>system：是否是系统用户</li>
<li>remove：是否删除用户家目录</li>
<li>state：具体的操作， 删除/添加， present | absent</li>
<li>shell： 指定用户的shell　</li>
</ul>
<h2 id="311-synchronize">3.11 synchronize</h2>
<p>使用rsync同步文件,参数</p>
<ul>
<li>archive：是否进行归档，默认为yes，相当于同时开启recursive,links,perms,times,owner,group -D等选项</li>
<li>checksum：是否校验和</li>
<li>copy_links：是否复制链接文件</li>
<li>delete：删除源中没有而目标存在的文件</li>
<li>dest_port: 对方用于接收的端口</li>
<li>dirs: 非递归传输目录</li>
<li>mode：模式，推和拉模式， push | pull ,默认为push(推)</li>
<li>src：同步的数据源的位置</li>
<li>rsync_opts: 指定rsync的选项，多个选项可以用逗号分隔</li>
<li>dest：目标文件</li>
<li>compress: 默认为yes，表示在文件同步过程中是否启用压缩</li>
</ul>
<p>例子</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ansible test <span style="color:#f92672">-</span>m synchronize <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#39;src=/etc/yum.repos.d/epel.repo dest=/tmp/epel.repo&#39;</span> <span style="color:#f92672">-</span>k                  <span style="color:#75715e"># rsync 传输文件</span>
ansible test <span style="color:#f92672">-</span>m synchronize <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#39;src=/tmp/123/ dest=/tmp/456/ delete=yes&#39;</span> <span style="color:#f92672">-</span>k                             <span style="color:#75715e"># 类似于 rsync --delete </span>
ansible test <span style="color:#f92672">-</span>m synchronize <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#39;src=/tmp/123/ dest=/tmp/test/ rsync_opts=&#34;-avz,--exclude=passwd&#34;&#39;</span> <span style="color:#f92672">-</span>k    <span style="color:#75715e"># 同步文件，添加rsync的参数-avz，并且排除passwd文件</span>
ansible test <span style="color:#f92672">-</span>m synchronize <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#39;src=/tmp/test/abc.txt dest=/tmp/123/ mode=pull&#39;</span> <span style="color:#f92672">-</span>k                      <span style="color:#75715e"># 把远程的文件，拉到本地的/tmp/123/目录下　　</span>
</code></pre></div><h2 id="312-mount">3.12 mount</h2>
<p>用于磁盘挂载相关操作,参数</p>
<ul>
<li>fstype：挂载文件的类型</li>
<li>name：挂载点</li>
<li>opts：传递给mount命令的参数</li>
<li>src：要挂载的文件</li>
<li>state：
<ul>
<li>present：只会在 fstab 中添加，不会操作磁盘</li>
<li>mounted：自动创建挂载点并挂载</li>
<li>unmounted：卸载</li>
<li>absent：只会在 fstab 中删除，不会操作磁盘</li>
</ul>
</li>
</ul>
<p>例子</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ansible test <span style="color:#f92672">-</span>m mount <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#39;fstype=ext4 src=/dev/loop0 name=/aaa state=mounted&#39;</span> <span style="color:#f92672">-</span>k   <span style="color:#75715e"># 挂在/dev/loop0 设备</span>
</code></pre></div><h2 id="312-template">3.12 template</h2>
<p>模版，用于将模版文件渲染后，输出到远程主机上，模版文件一般以.j2为结尾，标识其是一个jinja2模版文件,参数</p>
<ul>
<li>src：模版文件的路径</li>
<li>dest：拷贝到远程主机上的位置</li>
<li>mode：权限</li>
<li>attributes: 特殊权限 类似于 chattr</li>
<li>force：存在覆盖</li>
<li>group：属组</li>
<li>owner：属主</li>
</ul>
<h2 id="313-get_url">3.13 get_url</h2>
<p>从互联网下载数据到本地，作用类似于Linux下的curl命令。参数</p>
<ul>
<li>url：必传参数，文件的下载地址</li>
<li>dest：必传参数，文件保存的绝对路径</li>
<li>mode：文件的权限mode</li>
<li>othes：所有file模块里的选项都可以在这里使用</li>
<li>checksum：文件的校验码</li>
<li>headers：传递给下载服务器的 HTTP Headers</li>
<li>backup：如果本地已经存在同名的配置文件，先行备份</li>
<li>timeout：下载的超时时间</li>
</ul>
<h2 id="314-unarchive">3.14 unarchive</h2>
<p>用于解压文件，其作用类似于Linux下的tar命令，默认情况下unarchive的作用是将控制节点的压缩包拷贝到远程服务器上，然后进行解压,参数</p>
<ul>
<li>remote_src: 用来表示需要解压的文件存在远程服务器中还是本地服务器中，默认为no，表示解压前先将控制节点上的文件复制到远程主机上中，然后再进行解压。</li>
<li>src：指定压缩文件的路径，该选项取决于remote_src的取值，如果remote_src取值为yes,则src指定的是远程服务器中压缩包的地址，如果remote_src取值为no，则src指向的是控制节点中的路径</li>
<li>dest：该选项指定的是远程服务器上的绝对路径，表示压缩文件解压的路径</li>
<li>list_files: 默认情况下该选项的取值为no，如果该选项取值为yes，也会解压缩文件，并且在ansible的返回值中列出压缩包里的文件；</li>
<li>exclude：解压文件时排出exclude选项指定的文件或目录列表</li>
<li>keep_newer: 默认值为False，如果该选项为True，那么当目标地址中存在同名文件，并且文件比压缩包中的文件更新时，不进行覆盖。</li>
<li>owner：文件或目录解压以后的所有者</li>
<li>group: 文件或目录解压以后所属的群组</li>
<li>mode: 文件或目录解压以后的权限</li>
</ul>
<h2 id="315-git">3.15 git</h2>
<p>在远程服务器上执行git相关操作。依赖于git命令，需要在远程主机上先进性安装,参数</p>
<ul>
<li>repo：远程git库的地址，可以是一个git协议，ssh协议或者http协议的git库地址</li>
<li>dest：必选参数，git库clone到本地服务器以后保存的绝对路径</li>
<li>version：克隆远程git库的版本，取值可以为HEAD，分支名称，tag的名称，也可以是一个commit的hash值</li>
<li>foces：默认为no，当该选项为yes时，如果本地git库有修改，将会抛弃本地的修改(强制覆盖)</li>
<li>accept_hostkey: 当该选项取值为yes时，如果git库服务器不再know_hosts中，则添加到know_hosts中，key_file指定克隆远程git库地址时使用的私钥。　</li>
</ul>
<h2 id="316-stat">3.16 stat</h2>
<p>用于获取远程服务器上的文件信息，类似于Linux下的stat命令,参数</p>
<ul>
<li>path：用于指定文件或目录的路径　</li>
</ul>
<h2 id="317-sysctl">3.17 sysctl</h2>
<p>与Linux下的sysctl命令相似，用来控制Linux内核参数,参数：</p>
<ul>
<li>name：需要设置的参数</li>
<li>value：需要设置的值</li>
<li>sysctl_file: sysctl.conf文件的绝对路径，默认路径为/etc/sysctl.conf</li>
<li>reload：该选项可以取值为 yes 或 no，默认为yes，用于表示设置完以后是否需要实行sysctl -p的操作</li>
</ul>
<p>例子</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ansible test <span style="color:#f92672">-</span>m sysctl <span style="color:#f92672">-</span>a <span style="color:#e6db74">&#39;name=vm.overcommit_memory value=1&#39;</span>  <span style="color:#75715e"># 修改vm.overcommit_memory的值为1</span>
</code></pre></div><h1 id="4-模块的返回值">4 模块的返回值</h1>
<p>Ansible通过模块来执行具体的操作，由于模块功能千差万别，所以执行模块操作后，Ansible会根据不同的需要返回不同的结果，Ansible中一些常见的返回值如下：</p>
<ul>
<li>changed：几乎所有的Ansible模块都会返回该变量，表示模块是否对远程主机进行了操作</li>
<li>failed：如果模块未能执行完成，将返回failed和true</li>
<li>msg：模块执行失败的原因，常见的错误如ssh连接失败，没有执行权限等</li>
<li>rc：与命令行相关的模块会返会rc，表示执行Linux名的返回码</li>
<li>stdout：与rc相似，返回的是标准输出的结果</li>
<li>stderr：与rc详细，返回的是标准差错误输出</li>
<li>backup_file：所有存在backup选项的模块，用来返回备份文件的路径</li>
<li>results：应用在Playbook中存在循环的情况，返回多个结果</li>
</ul>
<h1 id="5-yaml简介">5 YAML简介</h1>
<p>ansible中使用YAML基础元素：</p>
<ul>
<li>变量</li>
<li>Inventory</li>
<li>条件测试</li>
<li>迭代</li>
</ul>
<h2 id="51-变量">5.1 变量</h2>
<p>变量仅能由字母、数字、下划线组成，且只能以字母开头</p>
<h3 id="511facts">5.1.1.facts</h3>
<p>facts是由正在通信的远程目标主机返回的信息，这些信息被保存在ansible变量中，要获取指定的远程主机所所支持的facts，可以使用setup模块。</p>
<h3 id="512-register注册器">5.1.2 register(注册器)</h3>
<p>把任务的输入定义为变量，然后用于其它任务</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">task<span style="color:#960050;background-color:#1e0010">：</span>
<span style="color:#f92672">-</span> shell<span style="color:#960050;background-color:#1e0010">：</span><span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>bin<span style="color:#f92672">/</span>foo
  register: foo_result
  ignore_errors: True

<span style="color:#f92672">-</span> name: test
  shell: echo <span style="color:#960050;background-color:#1e0010">‘</span>hello world<span style="color:#e6db74">&#39;</span>
  when: foo_result<span style="color:#f92672">.</span>success    <span style="color:#75715e"># wen条件判断foo_result</span>
</code></pre></div><h3 id="513-通过命令行传递变量">5.1.3 通过命令行传递变量</h3>
<p>在运行playbook的时候也可以传递一些变量提供playbook使用：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ansible<span style="color:#f92672">-</span>playbook test<span style="color:#f92672">.</span>yaml <span style="color:#f92672">--</span>extra<span style="color:#f92672">-</span>vars <span style="color:#e6db74">&#39;hosts=www user=www&#39;</span>
<span style="color:#ae81ff">4.</span><span style="color:#960050;background-color:#1e0010">通过</span>roles传递变量
<span style="color:#960050;background-color:#1e0010">当给一个主机英语角色的时候，可以传递变量，然后在角色内使用这些变量</span>

<span style="color:#f92672">-</span> host: webservers
  roles:
    <span style="color:#f92672">-</span> common                                                   <span style="color:#75715e"># common 角色</span>
    <span style="color:#f92672">-</span> {roles:foo_app_instance,dir:<span style="color:#e6db74">&#39;/var/lib/html&#39;</span>,port:<span style="color:#ae81ff">8080</span>}   <span style="color:#75715e"># 传递变量参数</span>
</code></pre></div><h2 id="52-inventory">5.2 Inventory</h2>
<p>ansible的主要功能在于批量主机操作，为了便捷地使用其中的部分主机，可以在Inventory file中讲其分组命名，默认的Inventory file为/etc/ansible/hosts。</p>
<h3 id="521-文件格式">5.2.1 文件格式</h3>
<p>Inventory文件遵循INI文件风格，中括号中的字符表示组名。可以将同一个主机同时归并到多个不同的组中，此外，当如果目标主机使用了非默认的SSH端口，还可以在主机名称之后使用冒号加端口号来标明。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#ae81ff">192.168</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.1</span>         <span style="color:#75715e"># 直接列出主机</span>

[web]
<span style="color:#ae81ff">192.168</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.2</span>
www<span style="color:#f92672">.</span>daxin<span style="color:#f92672">.</span>com

[web]
db[<span style="color:#ae81ff">1</span>:<span style="color:#ae81ff">3</span>]<span style="color:#f92672">.</span>daxin<span style="color:#f92672">.</span>com   <span style="color:#75715e"># 表示 db1.daxin.com db2.daxin.com db3.daxin.com</span>

<span style="color:#75715e"># 字母或者数字是连续的那么，可以使用列表的方式进行标识</span>
</code></pre></div><h3 id="522-主机变量">5.2.2 主机变量</h3>
<p>可以在 Inventory 中自定义主机时为其添加主机变量以便于在playbook中使用</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">[nginx]
<span style="color:#ae81ff">127.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0.1</span> http_port<span style="color:#f92672">=</span><span style="color:#ae81ff">8080</span> user<span style="color:#f92672">=</span>daxin
</code></pre></div><p>PS：定义主机时传递的专有的变量，在playbook中可以直接调用</p>
<h3 id="523-组变量">5.2.3 组变量</h3>
<p>组变量是指赋予给指定组内所有主机上的在playbook中可用的变量。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">[nginx]
<span style="color:#ae81ff">192.168</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.1</span>
<span style="color:#ae81ff">192.168</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.2</span>

[nginx:vars]      <span style="color:#75715e"># 固定用法                   </span>
ntp_server <span style="color:#f92672">=</span> ntp1<span style="color:#f92672">.</span>daxin<span style="color:#f92672">.</span>com
nfs_server <span style="color:#f92672">=</span> nfs1<span style="color:#f92672">.</span>daxin<span style="color:#f92672">.</span>com　
</code></pre></div><h3 id="524-组嵌套">5.2.4 组嵌套</h3>
<p>inventory 中，组还可以包含其他组，并且也可以向组中的主机指定变量，不过，这些变量只能在ansible-playbook中使用，而ansible不支持。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">[nginx]
<span style="color:#ae81ff">192.168</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.1</span>

[apache]
<span style="color:#ae81ff">192.168</span><span style="color:#f92672">.</span><span style="color:#ae81ff">1.2</span>

[web:children]        <span style="color:#75715e"># 引用其他组作为自己组内的主机(子组)</span>
nginx                 <span style="color:#75715e"># nginx组</span>
apache                <span style="color:#75715e"># apache组　</span>
</code></pre></div><h3 id="525-inenvtory-参数">5.2.5 inenvtory 参数</h3>
<p>ansible基于ssh连接inventory中指定的远程主机时，还可以通过参数指定其交互方式：</p>
<ul>
<li>ansible_ssh_user : 用于指定管理远程主机的帐号</li>
<li>ansible_ssh_host : 用于指定被管理的主机</li>
<li>ansible_ssh_port ：用于指定ssh的端口</li>
<li>ansible_ssh_private_key_file ：指定key文件</li>
<li>host_key_checking=False ：当第一次连接主机时，会提示yes/no，跳过此次环节</li>
<li>ansible_ssh_pass : 用于ssh登录的密码</li>
<li>ansible_sudo_pass : 用于用户sudo时的密码</li>
<li>ansible_connection : 连接客户端的类型(local,ssh,paramiko), 1.2版本以前模式为paramiko，后面版本为ssh</li>
</ul>
<h2 id="53-条件测试">5.3 条件测试</h2>
<p>如果需要根据变量，facts或此前任务的执行结果来做为某task执行与否的前提时要用到条件测试。</p>
<p>when语句：在task后添加when子句即可使用条件测试：when语句支持Jinja2表达式语法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">tasks:
<span style="color:#f92672">-</span> name: <span style="color:#e6db74">&#39;shutdown redhat system&#39;</span>
  command: <span style="color:#f92672">/</span>sbin<span style="color:#f92672">/</span>shutdown <span style="color:#f92672">-</span>h now
  when: ansible_os_family <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;redhat&#39;</span>     <span style="color:#75715e"># ansible_os_family 是 setup中收集到的信息，这里可以直接进行调用</span>
</code></pre></div><h2 id="54-迭代">5.4 迭代</h2>
<p>当有需要重复性执行的任务时，可以使用迭代机制，其使用格式为将需要迭代的内容定义为item变量引用，并通过with_items语句来指明迭代的元素列表即可。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">tasks:
  <span style="color:#f92672">-</span> name: add user
    user: name<span style="color:#f92672">=</span>{{ item }} state<span style="color:#f92672">=</span>present groups<span style="color:#f92672">=</span>wheel <span style="color:#75715e"># 必须要用 {{item}} 来表示迭代。</span>
    with_items:
      <span style="color:#f92672">-</span> daxin1
      <span style="color:#f92672">-</span> daxin2

<span style="color:#75715e"># 等同于：</span>

tasks:
  <span style="color:#f92672">-</span> name: add user
    user: name<span style="color:#f92672">=</span>daxin1 state<span style="color:#f92672">=</span>present groups<span style="color:#f92672">=</span>wheel
  <span style="color:#f92672">-</span> name: add user
    user: name<span style="color:#f92672">=</span>daxin2 state<span style="color:#f92672">=</span>present groups<span style="color:#f92672">=</span>wheel
</code></pre></div><p>事实上,with_items中还可以使用元素为hashes，例如：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">tasks:
  <span style="color:#f92672">-</span> name: add users
    user: name<span style="color:#f92672">=</span>{{item<span style="color:#f92672">.</span>name}} state<span style="color:#f92672">=</span>parsent groups<span style="color:#f92672">=</span>{{items<span style="color:#f92672">.</span>group}}
    with_items:
      <span style="color:#f92672">-</span> {name:<span style="color:#e6db74">&#39;daxin&#39;</span>,group<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;daxin&#39;</span>}
      <span style="color:#f92672">-</span> {name:<span style="color:#e6db74">&#39;daxin2&#39;</span>,group<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;daxin2&#39;</span>}
</code></pre></div><p>注意：with_items中的列表值也可以是字典，但引用时要使用item.key</p>
<h1 id="6-playbook简介">6 playbook简介</h1>
<p>        playbook是由一个或多个play组成的列表。play的主要功能在于将事先归并为一组的主机装扮成通过ansible中的task定义好的角色。从根本上讲，所谓task无非是调用ansible的一个module。将多个play组织在一个playbook中，即可让他们联合起来按事先编排的机制完成某一任务。</p>
<blockquote>
<p>有一个形象的比如，Ansible中的模块类似于Linux下的命令，而Ansible的Playbook则类似于Linux下的shell脚本。Shell脚本将各个Linux命令组合起来，以此实现复杂的功能。</p>
</blockquote>
<p>在Ansible中，一个play必须包含两部分内容，hosts，tasks，play配置文件例如：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">[root<span style="color:#a6e22e">@linux</span><span style="color:#f92672">-</span>node2 <span style="color:#f92672">~</span>]<span style="color:#75715e"># cat httpd.yaml </span>
<span style="color:#f92672">---</span> <span style="color:#75715e">#yaml的默认开头格式</span>
<span style="color:#f92672">-</span> hosts: test 
  user: root
  vars: 
    <span style="color:#f92672">-</span> info: <span style="color:#e6db74">&#39;hello world&#39;</span>
  tasks:
    <span style="color:#f92672">-</span> name: setup a infomation <span style="color:#75715e"># task名称</span>
      copy: dest<span style="color:#f92672">=/</span>tmp<span style="color:#f92672">/</span>info content<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{{info}}&#34;</span>
      notify: say something 
  handlers:
    <span style="color:#f92672">-</span> name: say something <span style="color:#75715e"># handlers名称</span>
      command: echo <span style="color:#e6db74">&#39;copy ok&#39;</span>
</code></pre></div><h2 id="61-playbook的一般结构">6.1 playbook的一般结构</h2>
<p>一个playbook针对配置区域划分，主要分为4类：</p>
<ul>
<li>target section：定义将要执行playbook的远程主机组</li>
<li>variable section：定义playbook运行时需要使用的变量</li>
<li>task section：定义将要在远程主机上执行的任务列表</li>
<li>handler section：定义task执行完以后需要调用的任务</li>
</ul>
<p>细化一点的话playbook的结构为：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">Inventory<span style="color:#960050;background-color:#1e0010">：操作的主机</span> <span style="color:#f92672">*</span>
Modules<span style="color:#960050;background-color:#1e0010">：使用的模块</span> <span style="color:#f92672">*</span>
Ad Hoc Commands<span style="color:#960050;background-color:#1e0010">：在主机上指定的命令</span>
Playbooks 
  Tasks<span style="color:#960050;background-color:#1e0010">：任务，即调用模块完成的某操作</span> <span style="color:#f92672">*</span>
  Variables<span style="color:#960050;background-color:#1e0010">：变量</span> 
  Templates<span style="color:#960050;background-color:#1e0010">：模板</span>
  Handlers<span style="color:#960050;background-color:#1e0010">：处理器，由某事件触发完成的操作</span>
  Roles<span style="color:#960050;background-color:#1e0010">：角色</span>
</code></pre></div><h2 id="62-target-配置项目">6.2 target 配置项目</h2>
<ul>
<li>hosts：定义远程的主机组</li>
<li>user：执行该任务的用户</li>
<li>remote_user: 远端运行该play的用户，可以细分到每一个task</li>
<li>*sudo：如果设置为yes，执行该任务组的用户在执行任务的时候，获取root权限</li>
<li>*sudo_user: 如果你设置user为tom，速度设置为yes，sudo_user为jerry，则tom用户则会获取jerry用户的权限</li>
<li>connection：通过什么方式连接到远程主机，默认为ssh</li>
<li>become：是否提权</li>
<li>become_method： 提权得方式(sudo)</li>
<li>notify：当任务执行完毕后，通知handler section 中的任务模块(出发执行)</li>
<li>set_fact: 模块可以自定义facts，这些自定义的facts可以通过template或者变量的方式在playbook中使用。如果你想要获取一个进程使用的内存的百分比，则必须通过set_fact来进行计算之后得出其值，并将其值在playbook中引用。set_fact: innodb_buffer_pool_size_mb=&quot;{{ ansible_memtotal_mb / 2 }}&quot;</li>
<li>gather_facts：除非你明确说明不需要在远程主机上执行setup模块，否则会默认自动执行。如果你的确不需要setup模块所传递过来的变量，你可以启用该选项</li>
</ul>
<p>注意：</p>
<ul>
<li>可以使用setup获取到的字典中的key，来渲染对应的值</li>
<li>当值的类型为字典嵌套时，可以使用点来进行深入查找 {{ansible_eth0.ipv4.address}}</li>
<li>当值的类型为列表时，{{ansible[0].xxx}}　　</li>
</ul>
<h2 id="63-variable-可用的配置项目">6.3 variable 可用的配置项目</h2>
<ul>
<li>vars：定义一个变量。key：value，多个变量，可以使用{key:value,key2:value2}</li>
<li>vars_files：定义一个变量文件。这里列出变量文件的绝对路径即可。 变量文件中的直接使用key:value定义即可。</li>
<li>vars_prompt: 通过交互的方式输入的值</li>
<li>name：变量的值</li>
<li>prompt：提示信息</li>
<li>private：是否为私有变量，yes | no， yes时输入的变量不在屏幕上显示，否则会显示在屏幕上</li>
</ul>
<h2 id="64-task-配置项目">6.4 task 配置项目</h2>
<p>        play的主体部分是task list,task list中的各任务被按次序诸葛在hosts中 指定的所有主机上运行,即在所有主机上完成第一个任务后再开始第二个.在运行自上而下某个playbook时,如果中途发生错误,所有已执行任务都可以能回滚,因此,在更正playbook后重新执行一次即可.</p>
<p>        task的目的是使用指定的参数运行模块,而在模块参数中可以使用变量,模块执行是幂等的,这意味着多次执行是安全的,因为其结果一致.</p>
<p>        每个task都应该有其name,用于playbook的执行结果输出，建议其内容尽可能清晰的描述任务执行步骤。如果未提供name，则action的结果将用于输出。</p>
<p>定义任务的三种方式：</p>
<ol>
<li>方式1(action)</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">-</span> name: task的名称
  action<span style="color:#960050;background-color:#1e0010">：要做的操作</span>
<span style="color:#75715e"># 例如： action: yum name= httpd state=installed</span>
</code></pre></div><ol start="2">
<li>方式2(直接写模块名)</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">-</span> name: task的名称
  copy: src<span style="color:#f92672">=</span>files<span style="color:#f92672">/</span>httpd<span style="color:#f92672">.</span>conf dest<span style="color:#f92672">=/</span>etc<span style="color:#f92672">/</span>httpd<span style="color:#f92672">/</span>conf<span style="color:#f92672">/</span>httpd<span style="color:#f92672">.</span>conf
</code></pre></div><ol start="3">
<li>方式3(模块名时，模块的参数也可以用下列方式使用)</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">-</span> name: task的名称
  service:
    name:httpd
    state:restarted
</code></pre></div><p>在众多模块中只有command和shel模块仅需要给定一个列表而无需使用key=value格式</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">tasks:
<span style="color:#f92672">-</span> name: disable selinux
  command: <span style="color:#f92672">/</span>sbin<span style="color:#f92672">/</span>setenforce <span style="color:#ae81ff">0</span>
</code></pre></div><p>如果命令或脚本的输出码不以0，可以使用如下方式替代</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">tasks:
<span style="color:#f92672">-</span> name: run this command <span style="color:#f92672">and</span> ignore the result
  shell: <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>bin<span style="color:#f92672">/</span>somecommand <span style="color:#f92672">||</span> <span style="color:#f92672">/</span>bin<span style="color:#f92672">/</span>true     <span style="color:#75715e"># 强行成功</span>
</code></pre></div><p>或者使用ignore_errors来忽略错误信息</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">tasks:
  <span style="color:#f92672">-</span> name: run this command <span style="color:#f92672">and</span> ignore the result
    shell: <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>bin<span style="color:#f92672">/</span>somecommand
    ignote_errors:True
</code></pre></div><p>常用参数：</p>
<ul>
<li>ignote_errors： 是否忽略错误</li>
<li>register： 注册变量，即把当前任务的结果注册到register指定的变量后，在后续的task中可以进行调用，或者判断</li>
<li>when：当when后面的条件为真时才会执行当前task，一般配合register来做,当然，when也可以读取变量</li>
</ul>
<blockquote>
<p>when支持多条件</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># 1、当多个条件是列表时，它们之间是并且的关系</span>
when:
<span style="color:#f92672">-</span> ansible_distribution <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Centos&#34;</span>
<span style="color:#f92672">-</span> ansible_distribution <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;ubuntu&#34;</span>

<span style="color:#75715e"># 2、如果要表达更复杂的关系，可以用and/or, </span>
when: (ansible_distribution <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Centos&#34;</span> <span style="color:#f92672">and</span> ansible_distribution_major_version <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;6&#34;</span> ) <span style="color:#f92672">or</span> (ansible_distribution <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;ubuntu&#34;</span>)
</code></pre></div><h2 id="65-handler-配置项目">6.5 handler 配置项目</h2>
<p>用于当关注的医院发生变化时采取一定的操作</p>
<ul>
<li>Handlers 也是一些 task 的列表,通过名字来引用,它们和一般的 task 并没有什么区别。</li>
<li>Handlers 是由通知者进行 notify, 如果没有被 notify,handlers 不会执行。</li>
<li>不管有多少个通知者进行了 notify,等到 play 中的所有 task 执行完成之后,handlers 也只会被执行一次。</li>
<li>Handlers 最佳的应用场景是用来重启服务,或者触发系统重启操作.除此以外很少用到了。</li>
</ul>
<p>例子：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">tasks:
  <span style="color:#f92672">-</span> name: template configuration file
    template: src<span style="color:#f92672">=</span>template<span style="color:#f92672">.</span>j2 dest<span style="color:#f92672">=/</span>etc<span style="color:#f92672">/</span>configuration<span style="color:#f92672">.</span>conf
    notify:
      <span style="color:#f92672">-</span> restart memcached

handlers:
  <span style="color:#f92672">-</span> name: restart memcached
    service: name<span style="color:#f92672">=</span>memcached state<span style="color:#f92672">=</span>restart
</code></pre></div><h2 id="66-ansible-playbook命令">6.6 ansible-playbook命令</h2>
<p>playbook需要使用ansible-playbook来运行，它具有ansible的部分参数，以及自己独有的参数：</p>
<ul>
<li>&ndash;list-tasks：列出playbook的任务列表。</li>
<li>&ndash;step：每执行一个任务后停止，等待用户确认。(yes/no/continue,yes会继续下一个task，continue会执行完当前play，下一个play再次等待用户输入)</li>
<li>&ndash;syntax-check：检查playbook的语法</li>
<li>-C &ndash;check：检查当前这个playbook是否会修改远程服务器，相当于预测playbook的执行结果</li>
</ul>
<h2 id="67-其他配置">6.7 其他配置</h2>
<p><code>tags</code>: 在playbook中，可以为某个任务或某些任务定义一个“标签”，在执行此playbook时，通过为ansible-playbook 使用 &ndash;tags选项能实现仅指定的tasks，而非所有的。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">tasks:
  <span style="color:#f92672">-</span> name: user add
    user: name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;daxin&#39;</span> state<span style="color:#f92672">=</span>parsent
  <span style="color:#f92672">-</span> name: config file
    file: src<span style="color:#f92672">=/</span>tmp<span style="color:#f92672">/</span>daxin<span style="color:#f92672">.</span>txt dest<span style="color:#f92672">=/</span>tmp<span style="color:#f92672">/</span>daxin<span style="color:#f92672">.</span>txt
    tags:
    <span style="color:#f92672">-</span> copyfile

<span style="color:#75715e"># 运行时</span>
ansible<span style="color:#f92672">-</span>playbook test<span style="color:#f92672">.</span>yaml <span style="color:#f92672">--</span>tags<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;copyfile&#39;</span>
</code></pre></div><p><code>include</code>：在playbook中，一般情况下，一个yaml文件包含一个play，比如我要同时安装db.yaml 和 web.yaml，那么我们可以用include的方式来进行聚合</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">cat all<span style="color:#f92672">.</span>yaml
<span style="color:#f92672">---</span>
<span style="color:#f92672">-</span> include:db<span style="color:#f92672">.</span>yaml
<span style="color:#f92672">-</span> include:web<span style="color:#f92672">.</span>yaml　　
</code></pre></div><p>这时只需要执行all.yaml即可。 ansible all all.yaml</p>
<p><code>strategy</code>: free,任务策略
默认情况下，ansible是按照顺序执行task的，当匹配到的所有主机执行完task1后，再继续指定task2。
从Ansible 2.0开始，ansible支持free的任务执行策略，允许较快的远程服务器提前完成play的部署，不用等待其他远程服务器一起执行task。</p>
<p>更多知识： <a href="https://github.com/lorin/ansible-quickref">https://github.com/lorin/ansible-quickref</a></p>
<h1 id="7-roles">7 Roles</h1>
<p>ansible自1.2版本引入的新特性，用于层次性、结构化地组织playbook，roles能够根据层次型结构自动装载变量文件、tasks以及handles等。要使用roles，只需要在playbook中使用include指令即可。简单来讲，roles就是通过分别将变量、文件、任务、模块及处理器放置于单独的目录中，并可以便捷的通过include它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中。</p>
<p>创建roles的步骤</p>
<ul>
<li>创建以roles命名的目录</li>
<li>在roles目录中分别创建以各角色名称命名的目录</li>
<li>在每个角色命名的目录中，分别创建files，handlers，meta，tasks，templates和vars目录；用不到的可以创建为空目录，或者不创建</li>
<li>在playbook文件中，调用各角色</li>
</ul>
<h2 id="71-role内各目录中的文件说明">7.1 role内各目录中的文件说明</h2>
<ol>
<li>tasks目录：至少应该包含一个main.yml的文件，其定义了此角色的任务列表；此文件可以使用include包含其他的位于此目录的task文件</li>
<li>files目录：存放由copy或script等模块调用的文件</li>
<li>templates目录：templates模块会自动在此目录中寻找Jinja2模版文件</li>
<li>handlers目录：此目录中应该包含一个main.yml</li>
<li>yml文件，用于定义此角色用到的各handler，在handler中使用include包含的其他handler文件也应该位于此目录中</li>
<li>vars目录：应当包含一个main.yml文件，用于定义此角色用到的变量</li>
<li>meta目录：应当包含一个main.yml文件,用于定于此角色的特殊设定及依赖关系,ansible1.3 以后才支持</li>
<li>default目录: 为当前角色设定默认变量时使用此目录，应当包含一个main.yml文件</li>
</ol>
<p>例子：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># 目录结构：</span>
<span style="color:#960050;background-color:#1e0010">├──</span> db<span style="color:#f92672">.</span>yaml
<span style="color:#960050;background-color:#1e0010">└──</span> roles
<span style="color:#960050;background-color:#1e0010">└──</span> db
<span style="color:#960050;background-color:#1e0010">├──</span> files
<span style="color:#960050;background-color:#1e0010">├──</span> handler
<span style="color:#960050;background-color:#1e0010">├──</span> tasks
<span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#960050;background-color:#1e0010">└──</span> main<span style="color:#f92672">.</span>yml
<span style="color:#960050;background-color:#1e0010">├──</span> templates
<span style="color:#960050;background-color:#1e0010">│</span>   <span style="color:#960050;background-color:#1e0010">└──</span> my<span style="color:#f92672">.</span>cnf<span style="color:#f92672">.</span>j2
<span style="color:#960050;background-color:#1e0010">└──</span> vars
<span style="color:#960050;background-color:#1e0010">└──</span> main<span style="color:#f92672">.</span>yml

<span style="color:#75715e"># db.yaml 文件</span>
<span style="color:#f92672">-</span> hosts: test
  roles:
    <span style="color:#f92672">-</span> db

<span style="color:#75715e"># tasks.main.yml 文件</span>
<span style="color:#f92672">---</span>
<span style="color:#f92672">-</span> name: Install MySQL
  yum:
    name: mariadb<span style="color:#f92672">-</span>server
    state: present

<span style="color:#f92672">-</span> name: copy File
  template:
    src: <span style="color:#e6db74">&#34;my.cnf.j2&#34;</span>
    dest: <span style="color:#e6db74">&#34;/etc/my.cnf&#34;</span>

<span style="color:#f92672">-</span> name: Start MySQL
  service:
    name: mariadb
    state: started

<span style="color:#75715e"># vars.main.yml 文件</span>
<span style="color:#f92672">---</span>
mysql_port: <span style="color:#ae81ff">3307</span>

<span style="color:#75715e"># templates.my.cnf.j2 文件</span>
[mysqld]
datadir<span style="color:#f92672">=/</span>var<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>mysql
socket<span style="color:#f92672">=/</span>var<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>mysql<span style="color:#f92672">/</span>mysql<span style="color:#f92672">.</span>sock
user<span style="color:#f92672">=</span>mysql
<span style="color:#75715e"># Disabling symbolic-links is recommended to prevent assorted security risks</span>
symbolic<span style="color:#f92672">-</span>links<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
port <span style="color:#f92672">=</span> {{ mysql_port }}
bind <span style="color:#f92672">=</span> {{ ansible_all_ipv4_addresses[<span style="color:#ae81ff">0</span>] }}

[mysqld_safe]
log<span style="color:#f92672">-</span>error<span style="color:#f92672">=/</span>var<span style="color:#f92672">/</span>log<span style="color:#f92672">/</span>mariadb<span style="color:#f92672">/</span>mariadb<span style="color:#f92672">.</span>log
pid<span style="color:#f92672">-</span>file<span style="color:#f92672">=/</span>var<span style="color:#f92672">/</span>run<span style="color:#f92672">/</span>mariadb<span style="color:#f92672">/</span>mariadb<span style="color:#f92672">.</span>pid

<span style="color:#75715e"># 运行</span>
ansible<span style="color:#f92672">-</span>playbook <span style="color:#f92672">-</span>i hosts db<span style="color:#f92672">.</span>yaml
</code></pre></div><h2 id="72-ansible-galaxy-命令">7.2 ansible-galaxy 命令</h2>
<p>我们可以利用ansible-galaxy来快速创建并初始化一个roles</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ansible<span style="color:#f92672">-</span>galaxy init roles<span style="color:#f92672">/</span>mysql
</code></pre></div><p>我们在galaxy.ansible.com 上找到适合自己的roles时，只需要运行 ansible-galaxy install 作者id.角色包名称即可完成安装</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># 安装别人写好的roles：(galaxy.ansible.com)</span>
ansible<span style="color:#f92672">-</span>galaxy install <span style="color:#f92672">-</span>p <span style="color:#f92672">/</span>etc<span style="color:#f92672">/</span>ansible<span style="color:#f92672">/</span>roles bennojoy<span style="color:#f92672">.</span>mysql
<span style="color:#75715e"># 安装到指定目录</span>
ansible<span style="color:#f92672">-</span>galaxy <span style="color:#f92672">-</span>p <span style="color:#f92672">./</span>roles install bennojoy<span style="color:#f92672">.</span>ntp
</code></pre></div><p>默认情况下role存放在/etc/ansible/roles目录，也可以在ansible.cfg 中 使用 roles_path ，来制定roles的目录</p>
<p>列出已经安装的roles：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ansible<span style="color:#f92672">-</span>galaxy list
</code></pre></div><p>查看已安装的roles信息：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ansible<span style="color:#f92672">-</span>galaxy info bennojoy<span style="color:#f92672">.</span>mysql
</code></pre></div><p>卸载roles:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ansible<span style="color:#f92672">-</span>galaxy remove bennojoy<span style="color:#f92672">.</span>mysql
</code></pre></div><p>{% endraw %}</p>

</div>


  <footer class="container">
  <div class="container navigation no-print">
  <h2>Navigation</h2>
  
  

    
    <a class="prev" href="https://dachenzi.github.io/1/01/01/1-django-%E4%BB%8B%E7%BB%8D-mtv-%E5%91%BD%E4%BB%A4-%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE-admin/" title="1-django-介绍-MTV-命令-基础配置-admin">
      Previous
    </a>
    

    

  


</div>

  
<div class="container comments">
  <h2>Comments</h2>
  
<div id="disqus_thread"></div>
<script type="text/javascript">
  (function() {
    
    
    if (window.location.hostname == "localhost")
      return;

    var dsq = document.createElement('script'); dsq.async = true; dsq.type = 'text/javascript';
    dsq.src = '//your_disqus_shortname.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


</div>


</footer>

</article>
      <footer id="main-footer" class="container main_footer">
  

  <div class="container nav foot no-print">
  

  <a class="toplink" href="#">back to top</a>

</div>

  <div class="container credits">
  
<div class="container footline">
  
  code with <!-- raw HTML omitted --><!-- raw HTML omitted -->


</div>


  
<div class="container copyright">
  
  (c) 2015 Lee xin.


</div>


</div>

</footer>

    </main>
    
<script type="text/javascript">
  (function() {
    
    
    if (window.location.hostname == "localhost")
      return;
    var dsq = document.createElement('script'); dsq.async = true; dsq.type = 'text/javascript';
    dsq.src = '//your_disqus_shortname.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>



<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



    
  </body>
</html>

