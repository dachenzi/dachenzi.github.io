<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>1-flask-快速入门-配置-路由基础-请求与响应  &middot; dahl&#39;s blog</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="" />

<meta name="keywords" content="">


<meta property="og:title" content="1-flask-快速入门-配置-路由基础-请求与响应  &middot; dahl&#39;s blog ">
<meta property="og:site_name" content="dahl&#39;s blog"/>
<meta property="og:url" content="https://dachenzi.github.io/1/01/01/1-flask-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8-%E9%85%8D%E7%BD%AE-%E8%B7%AF%E7%94%B1%E5%9F%BA%E7%A1%80-%E8%AF%B7%E6%B1%82%E4%B8%8E%E5%93%8D%E5%BA%94/" />
<meta property="og:locale" content="en-EN">


<meta property="og:type" content="article" />
<meta property="og:description" content=""/>
<meta property="og:article:published_time" content="0001-01-01T00:00:00Z" />
<meta property="og:article:modified_time" content="0001-01-01T00:00:00Z" />

  
    
  

  

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "1-flask-快速入门-配置-路由基础-请求与响应",
    "author": {
      "@type": "Person",
      "name": "daxin.li"
    },
    "datePublished": "0001-01-01",
    "description": "",
    "wordCount":  1410 
  }
</script>



<link rel="canonical" href="https://dachenzi.github.io/1/01/01/1-flask-%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8-%E9%85%8D%E7%BD%AE-%E8%B7%AF%E7%94%B1%E5%9F%BA%E7%A1%80-%E8%AF%B7%E6%B1%82%E4%B8%8E%E5%93%8D%E5%BA%94/" />

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://dachenzi.github.io/touch-icon-144-precomposed.png">
<link href="https://dachenzi.github.io/favicon.png" rel="icon">

<meta name="generator" content="Hugo 0.75.1" />

  <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link href='https://fonts.googleapis.com/css?family=Merriweather:300%7CRaleway%7COpen+Sans' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="/css/font-awesome.min.css">
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/highlight/default.css">

  
  
	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	  ga('create', 'Your Google Analytics tracking code', 'auto');
	  ga('send', 'pageview');

	</script>

</head>
<body>
  <main id="main-wrapper" class="container main_wrapper has-sidebar">
    <header id="main-header" class="container main_header">
  <div class="container brand">
  <div class="container title h1-like">
  <a class="baselink" href="https://dachenzi.github.io">
  foobar

</a>

</div>

  
<div class="container topline">
  
  few words about your site


</div>


</div>

  <nav class="container nav primary no-print">
  

<a class="homelink" href="https://dachenzi.github.io">home</a>


  
<a href="https://dachenzi.github.io/about">About</a>

<a href="https://dachenzi.github.io/post" title="Show list of posts">Posts</a>

<a href="https://dachenzi.github.io/tags" title="Show list of tags">Tags</a>


</nav>

<div class="container nav secondary no-print">
  
<a id="contact-link-email" class="contact_link" rel="me" aria-label="Email" href="mailto:dahlhin.li@gmail.com">
  <span class="fa fa-envelope-square"></span></a>



<a id="contact-link-github" class="contact_link" rel="me" aria-label="Github" href="https://github.com/enten/hugo-boilerplate">
  <span class="fa fa-github-square"></span></a>




 


















</div>


  

</header>


<article id="main-content" class="container main_content single">
  <header class="container hat">
  <h1>1-flask-快速入门-配置-路由基础-请求与响应
</h1>

  <div class="metas">
<time datetime="0001-01-01">1 Jan, 0001</time>


  
  &middot; Read in about 7 min
  &middot; (1410 Words)
  <br>
  


</div>

</header>

  <div class="container content">
  <p>{% raw %}</p>
<p><!-- raw HTML omitted --><strong>文章目录</strong><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<ul>
<li><a href="#1-werkzeug">1 werkzeug</a></li>
<li><a href="#2-hello-world">2 hello world</a></li>
<li><a href="#3-%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E5%92%8C%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%E9%85%8D%E7%BD%AE">3 静态文件和模板文件配置</a></li>
<li><a href="#4-%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95">4 用户登录</a></li>
<li><a href="#5-session%E4%BD%BF%E7%94%A8">5 session使用</a>
<ul>
<li><a href="#51-%E5%9F%BA%E4%BA%8E%E8%A3%85%E9%A5%B0%E5%99%A8%E7%9A%84%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81">5.1 基于装饰器的用户认证</a></li>
<li><a href="#52-endpoint">5.2 endpoint</a></li>
<li><a href="#53-functoolswraps">5.3 functools.wraps</a></li>
<li><a href="#54-session%E7%9A%84%E4%BA%A7%E7%94%9F%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90">5.4 session的产生过程分析</a></li>
</ul>
</li>
<li><a href="#6-%E9%85%8D%E7%BD%AE%E5%9F%BA%E7%A1%80">6 配置基础</a>
<ul>
<li><a href="#61-%E5%86%85%E7%BD%AE%E7%9A%84%E9%85%8D%E7%BD%AE%E5%80%BC">6.1 内置的配置值</a></li>
<li><a href="#62-flask%E7%9A%84%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE">6.2 Flask的默认配置</a></li>
<li><a href="#63-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">6.3 最佳实践</a></li>
<li><a href="#64-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%E7%9A%84%E6%80%9D%E6%83%B3">6.4 动态加载的思想</a></li>
</ul>
</li>
<li><a href="#7-%E8%B7%AF%E7%94%B1%E7%B3%BB%E7%BB%9F">7 路由系统</a>
<ul>
<li><a href="#71-%E8%B7%AF%E7%94%B1%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%9C%AC%E8%B4%A8">7.1 路由系统的本质</a></li>
<li><a href="#72-fbv%E5%92%8Ccbv">7.2 FBV和CBV</a></li>
</ul>
</li>
<li><a href="#8-flask%E4%B8%AD%E7%9A%84beforeafter">8 flask中的before/after</a></li>
<li><a href="#9-%E8%AF%B7%E6%B1%82%E5%92%8C%E5%93%8D%E5%BA%94%E7%9B%B8%E5%85%B3">9 请求和响应相关</a>
<ul>
<li><a href="#91-%E4%B8%8A%E4%BC%A0%E5%8F%8A%E4%BF%9D%E5%AD%98%E6%96%87%E4%BB%B6">9.1 上传及保存文件</a></li>
<li><a href="#92-%E6%9E%84%E5%BB%BA%E5%93%8D%E5%BA%94%E5%A4%B4">9.2 构建响应头</a></li>
</ul>
</li>
<li><a href="#10-%E6%A8%A1%E6%9D%BF%E4%BD%BF%E7%94%A8">10 模板使用</a>
<ul>
<li><a href="#101-template_global%E5%92%8Ctemplate_filter">10.1 template_global和template_filter</a></li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<h1 id="1-werkzeug">1 werkzeug</h1>
<p>        Werkzeug是一个全面的WSGI Web应用程序库。它最初是作为WSGI应用程序的各种实用程序的简单集合开始的，并且已经成为最先进的WSGI实用程序库之一。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> werkzeug.wrappers <span style="color:#f92672">import</span> Request, Response
<span style="color:#f92672">from</span> werkzeug.serving <span style="color:#f92672">import</span> run_simple

<span style="color:#a6e22e">@Request.application</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">application</span>(request):
    <span style="color:#66d9ef">return</span> Response(<span style="color:#e6db74">&#34;Hello, World!&#34;</span>)

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
    <span style="color:#75715e"># 启动一个简单的web服务器，监听localhost:5000端口，并绑定给应用程序application</span>
    run_simple(<span style="color:#e6db74">&#34;localhost&#34;</span>, <span style="color:#ae81ff">5000</span>, application)
</code></pre></div><p>Flask依赖werkzeug提供的WSGI套件，来提供服务。</p>
<h1 id="2-hello-world">2 hello world</h1>
<p>下面用flask来实现一个hello world服务器</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask

<span style="color:#75715e"># 创建一个flask应用</span>
app <span style="color:#f92672">=</span> Flask(__name__)


<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>)   <span style="color:#75715e"># 设置url与视图函数的映射</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;hello world!&#39;</span>

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    app<span style="color:#f92672">.</span>run(<span style="color:#e6db74">&#39;localhost&#39;</span>,<span style="color:#ae81ff">8000</span>)   <span style="color:#75715e"># 启动服务</span>
</code></pre></div><h1 id="3-静态文件和模板文件配置">3 静态文件和模板文件配置</h1>
<p>django使用模板语言来渲染页面，flask使用的jinja2来渲染页面的，默认情况下是在templates目录下寻找渲染的html文件，当然它也可以配置应用或站点的静态文件所在的路径。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">app <span style="color:#f92672">=</span> Flask(__name__, template_folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;templates&#39;</span>, static_folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;static&#39;</span>)
</code></pre></div><blockquote>
<p>创建应用的时候，就可以指定上述文件，其中template_folder=&lsquo;templates&rsquo;, static_folder=&lsquo;static&rsquo;都为默认参数</p>
</blockquote>
<p>需要注意的是：</p>
<ol>
<li>指定静态路径为<code>static_folder='static'</code>后，静态文件可以通过/static/xxx 来直接进行访问</li>
<li>如果不想使用static，那么可以使用<code>static_url_path</code>来指定静态文件的路径('/static_path&rsquo;)</li>
<li>注意，路径要从/开始</li>
</ol>
<h1 id="4-用户登录">4 用户登录</h1>
<p>下面使用flask来实现一个用户登录的小程序，你会发现其中有很多和django类似的地方，需要注意的是，<code>flask和其他web框架不一样的地方是，它的request并不是通过参数诸如的，而是通过requst类封装的，想要使用就要先导入</code></p>
<ul>
<li>render_template：类似于django的render函数，进行模板的渲染</li>
<li>methods：表示视图函数支持的request请求方法，默认情况下仅支持get请求</li>
<li>request.method：获取请求的方法</li>
<li>request.form: 获取form表单提交的数据</li>
<li>redirect：跳转</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, request, render_template, redirect

app <span style="color:#f92672">=</span> Flask(__name__, template_folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;templates&#39;</span>, static_folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;static&#39;</span>)

<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/index&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;index.html&#39;</span>)

<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/login&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#34;POST&#34;</span>])
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login</span>():
    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;GET&#39;</span>:
        <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;login.html&#39;</span>)
    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
        user <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;username&#39;</span>)
        password <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;password&#39;</span>)
        <span style="color:#66d9ef">if</span> user <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;daxin&#39;</span> <span style="color:#f92672">and</span> password <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;123&#39;</span>:
            <span style="color:#66d9ef">return</span> redirect(<span style="color:#e6db74">&#39;/index&#39;</span>)
        <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;login.html&#39;</span>, msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;密码或用户名错误&#39;</span>)

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    app<span style="color:#f92672">.</span>run()
</code></pre></div><h1 id="5-session使用">5 session使用</h1>
<p>        我们知道有些页面需要登录以后才可以查看，那么就需要用到session了，session在flask中也是以对象的方式提供的，但是如果要使用session，那么还需要<code>配置一个app.secret_key</code>，该密钥用于会话 cookie 的安全签名，并可用于应用或者扩展的其他安全需求。本变量应当是一个字节型长随机字符串。</p>
<blockquote>
<p>通过secret_key对session数据进行加密，然后保存在cookie中，返回给客户端</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, request, render_template, redirect, session

app <span style="color:#f92672">=</span> Flask(__name__, template_folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;templates&#39;</span>, static_folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;static&#39;</span>)
app<span style="color:#f92672">.</span>secret_key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;adsasd23oy48932yqodqoidh&#39;</span>

<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/index&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
    <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;user&#39;</span>):  <span style="color:#75715e"># 获取session</span>
        <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;index.html&#39;</span>)
    <span style="color:#66d9ef">return</span> redirect(<span style="color:#e6db74">&#39;/login&#39;</span>)

<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/login&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#34;POST&#34;</span>])
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login</span>():
    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;GET&#39;</span>:
        <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;login.html&#39;</span>)
    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
        user <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;username&#39;</span>)
        password <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;password&#39;</span>)
        <span style="color:#66d9ef">if</span> user <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;daxin&#39;</span> <span style="color:#f92672">and</span> password <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;123&#39;</span>:
            session[<span style="color:#e6db74">&#39;user&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;daxin&#39;</span>   <span style="color:#75715e"># 设置session</span>
            <span style="color:#66d9ef">return</span> redirect(<span style="color:#e6db74">&#39;/index&#39;</span>)
        <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;login.html&#39;</span>, msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;密码或用户名错误&#39;</span>)

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    app<span style="color:#f92672">.</span>run()
</code></pre></div><h2 id="51-基于装饰器的用户认证">5.1 基于装饰器的用户认证</h2>
<p>如果有很多页面都需要验证，一个个函数去判断比较麻烦，所以这里也可以使用装饰器的方式来进行是否登录的判断。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, request, render_template, redirect, session

app <span style="color:#f92672">=</span> Flask(__name__, template_folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;templates&#39;</span>, static_folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;static&#39;</span>)
app<span style="color:#f92672">.</span>secret_key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;adsasd23oy48932yqodqoidh&#39;</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">auth</span>(func):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapper</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;user&#39;</span>):
            <span style="color:#66d9ef">return</span> func(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">return</span> redirect(<span style="color:#e6db74">&#39;/login&#39;</span>)
    <span style="color:#66d9ef">return</span> wrapper

<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/index&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
<span style="color:#a6e22e">@auth</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;index.html&#39;</span>)

<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/login&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#34;POST&#34;</span>])
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login</span>():
    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;GET&#39;</span>:
        <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;login.html&#39;</span>)
    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
        user <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;username&#39;</span>)
        password <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;password&#39;</span>)
        <span style="color:#66d9ef">if</span> user <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;daxin&#39;</span> <span style="color:#f92672">and</span> password <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;123&#39;</span>:
            session[<span style="color:#e6db74">&#39;user&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;daxin&#39;</span>
            <span style="color:#66d9ef">return</span> redirect(<span style="color:#e6db74">&#39;/index&#39;</span>)
        <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;login.html&#39;</span>, msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;密码或用户名错误&#39;</span>)


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    app<span style="color:#f92672">.</span>run()
</code></pre></div><blockquote>
<p>需要注意的是auth必须放在app.route下面才行，否则无法形成url到views函数的映射关系。</p>
</blockquote>
<p>多个页面利用装饰器产生的问题：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, request, render_template, redirect, session

app <span style="color:#f92672">=</span> Flask(__name__, template_folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;templates&#39;</span>, static_folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;static&#39;</span>)
app<span style="color:#f92672">.</span>secret_key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;adsasd23oy48932yqodqoidh&#39;</span>


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">auth</span>(func):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapper</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;user&#39;</span>):
            <span style="color:#66d9ef">return</span> func(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">return</span> redirect(<span style="color:#e6db74">&#39;/login&#39;</span>)
    <span style="color:#66d9ef">return</span> wrapper


<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/order&#39;</span>,methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
<span style="color:#a6e22e">@auth</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">order</span>():
    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;order.html&#39;</span>)

<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/index&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
<span style="color:#a6e22e">@auth</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;index.html&#39;</span>)

<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/login&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#34;POST&#34;</span>])
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login</span>():
    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;GET&#39;</span>:
        <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;login.html&#39;</span>)
    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
        user <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;username&#39;</span>)
        password <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;password&#39;</span>)
        <span style="color:#66d9ef">if</span> user <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;daxin&#39;</span> <span style="color:#f92672">and</span> password <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;123&#39;</span>:
            session[<span style="color:#e6db74">&#39;user&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;daxin&#39;</span>
            <span style="color:#66d9ef">return</span> redirect(<span style="color:#e6db74">&#39;/index&#39;</span>)
        <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;login.html&#39;</span>, msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;密码或用户名错误&#39;</span>)


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    app<span style="color:#f92672">.</span>run()
</code></pre></div><p>直接运行会提示：<code>AssertionError: View function mapping is overwriting an existing endpoint function: wrapper</code>为什么呢？因为@auth等于把下面的函数替换为了wrapper函数，在flask中，同样存在和django相同的通过某些关键字来反推URL的功能，比如reverse，但在flask中，它是通过<code>函数的名称</code>（默认）来反推url的，如果函数名称相同，那么将会冲突，这样是不行的，通过以下两个方法可以解决：</p>
<ol>
<li>endpoint参数：修改反推规则</li>
<li>functools.wraps()：拷贝包装的函数名称</li>
</ol>
<h2 id="52-endpoint">5.2 endpoint</h2>
<p>endpoint:用于指定生成的url的名称</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, request, render_template, redirect, session

app <span style="color:#f92672">=</span> Flask(__name__, template_folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;templates&#39;</span>, static_folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;static&#39;</span>)
app<span style="color:#f92672">.</span>secret_key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;adsasd23oy48932yqodqoidh&#39;</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">auth</span>(func):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapper</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;user&#39;</span>):
            <span style="color:#66d9ef">return</span> func(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
        <span style="color:#66d9ef">else</span>:
            <span style="color:#66d9ef">return</span> redirect(<span style="color:#e6db74">&#39;/login&#39;</span>)
    <span style="color:#66d9ef">return</span> wrapper

<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/order&#39;</span>,methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>],endpoint<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;order&#39;</span>)
<span style="color:#a6e22e">@auth</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">order</span>():
    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;order.html&#39;</span>)

<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/index&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
<span style="color:#a6e22e">@auth</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
    <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;index.html&#39;</span>)


<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/login&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#34;POST&#34;</span>],endpoint<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;login&#39;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">login</span>():
    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;GET&#39;</span>:
        <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;login.html&#39;</span>)
    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:
        user <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;username&#39;</span>)
        password <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>form<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;password&#39;</span>)
        <span style="color:#66d9ef">if</span> user <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;daxin&#39;</span> <span style="color:#f92672">and</span> password <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;123&#39;</span>:
            session[<span style="color:#e6db74">&#39;user&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;daxin&#39;</span>
            <span style="color:#66d9ef">return</span> redirect(<span style="color:#e6db74">&#39;/index&#39;</span>)
        <span style="color:#66d9ef">return</span> render_template(<span style="color:#e6db74">&#39;login.html&#39;</span>, msg<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;密码或用户名错误&#39;</span>)


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    app<span style="color:#f92672">.</span>run()
</code></pre></div><p>在每个路由系统上添加endpoint关键字来约束反推URL的规则，但在大量视图函数的场景下不太适用。</p>
<h2 id="53-functoolswraps">5.3 functools.wraps</h2>
<p>functools.wraps装饰器它可以将被包装的函数信息拷贝到新函数中去，这样，我们就可以不用修改flask默认的反推url的规则了。它只需要在我们的装饰器函数中，对内层嵌套函数进行装饰即可。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> functools

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">auth</span>(func):
    <span style="color:#a6e22e">@functools.wraps</span>(func)
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">wrapper</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs):
        <span style="color:#66d9ef">if</span> session<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;user&#39;</span>):
            <span style="color:#66d9ef">return</span> func(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kwargs)
        <span style="color:#66d9ef">return</span> redirect(<span style="color:#e6db74">&#39;/login&#39;</span>)
    <span style="color:#66d9ef">return</span> wrapper
</code></pre></div><blockquote>
<p>在生产上一般会利用中间件来批量处理</p>
</blockquote>
<h2 id="54-session的产生过程分析">5.4 session的产生过程分析</h2>
<p><img src="../photo/session.png" alt="session"></p>
<p>说白了，session就是一个特殊的字典，在处理请求前，就已经封装好了，存放在某个空间内，这样，我们就可以在before_request中直接调用。</p>
<h1 id="6-配置基础">6 配置基础</h1>
<p>config 实际上继承于字典，并且可以像修改字典一样修改它:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">app <span style="color:#f92672">=</span> Flask(__name__)
app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;DEBUG&#39;</span>] <span style="color:#f92672">=</span> True
</code></pre></div><p>给定的配置值会被推送到 Flask 对象中，由于是字典，也可以是用 dict.update() 方法来一次性更新多个键:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">app<span style="color:#f92672">.</span>config<span style="color:#f92672">.</span>update(
    DEBUG<span style="color:#f92672">=</span>True,
    SECRET_KEY<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;...&#39;</span>
)
</code></pre></div><blockquote>
<p>更多的配置文件信息 ： <a href="https://dormousehole.readthedocs.io/en/latest/config.html#id7">https://dormousehole.readthedocs.io/en/latest/config.html#id7</a></p>
</blockquote>
<h2 id="61-内置的配置值">6.1 内置的配置值</h2>
<p>下列配置值是 Flask 内部使用的:</p>
<table>
<thead>
<tr>
<th>key</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>DEBUG</td>
<td>启用/禁用调试模式</td>
</tr>
<tr>
<td>TESTING</td>
<td>启用/禁用测试模式</td>
</tr>
<tr>
<td>PROPAGATE_EXCEPTIONS</td>
<td>显式地允许或禁用异常的传播。如果没有设置或显式地设置为 None ，当 TESTING 或 DEBUG 为真时，这个值隐式地为 true.</td>
</tr>
<tr>
<td>PRESERVE_CONTEXT_ON_EXCEPTION</td>
<td>默认情况下，如果应用工作在调试模式，请求上下文不会在异常时出栈来允许调试器内省。 这可以通过这个键来禁用。你同样可以用这个设定来强制启用它，即使没有调试执行，这对调试生产应用很有用（但风险也很大）</td>
</tr>
<tr>
<td>SECRET_KEY</td>
<td>密钥</td>
</tr>
<tr>
<td>SESSION_COOKIE_NAME</td>
<td>会话 cookie 的名称。</td>
</tr>
<tr>
<td>SESSION_COOKIE_DOMAIN</td>
<td>会话 cookie 的域。如果不设置这个值，则 cookie 对 SERVER_NAME 的全部子域名有效</td>
</tr>
<tr>
<td>SESSION_COOKIE_PATH</td>
<td>会话 cookie 的路径。如果不设置这个值，且没有给 &lsquo;/&rsquo; 设置过，则 cookie 对 APPLICATION_ROOT 下的所有路径有效。</td>
</tr>
<tr>
<td>SESSION_COOKIE_HTTPONLY</td>
<td>控制 cookie 是否应被设置 httponly 的标志， 默认为 True</td>
</tr>
<tr>
<td>SESSION_COOKIE_SECURE</td>
<td>控制 cookie 是否应被设置安全标志，默认为 False</td>
</tr>
<tr>
<td>PERMANENT_SESSION_LIFETIME</td>
<td>以 datetime.timedelta 对象控制长期会话的生存时间。从 Flask 0.8 开始，也可以用整数来表示秒。</td>
</tr>
<tr>
<td>SESSION_REFRESH_EACH_REQUEST</td>
<td>这个标志控制永久会话如何刷新。如果被设置为 True （这是默认值），每一个请求 cookie 都会被刷新。如果设置为 False ，只有当 cookie 被修改后才会发送一个 set-cookie 的标头。非永久会话不会受到这个配置项的影响 。</td>
</tr>
<tr>
<td>USE_X_SENDFILE</td>
<td>启用/禁用 x-sendfile</td>
</tr>
<tr>
<td>LOGGER_NAME</td>
<td>日志记录器的名称</td>
</tr>
<tr>
<td>SERVER_NAME</td>
<td>服务器名和端口。需要这个选项来支持子域名 （例如： &lsquo;myapp.dev:5000&rsquo; ）。注意 localhost 不支持子域名，所以把这个选项设置为 “localhost” 没有意义。设置 SERVER_NAME 默认会允许在没有请求上下文而仅有应用上下文时生成 URL</td>
</tr>
<tr>
<td>APPLICATION_ROOT</td>
<td>如果应用不占用完整的域名或子域名，这个选项可以被设置为应用所在的路径。这个路径也会用于会话 cookie 的路径值。如果直接使用域名，则留作 None</td>
</tr>
<tr>
<td>MAX_CONTENT_LENGTH</td>
<td>如果设置为字节数， Flask 会拒绝内容长度大于此值的请求进入，并返回一个 413 状态码</td>
</tr>
<tr>
<td>SEND_FILE_MAX_AGE_DEFAULT:</td>
<td>默认缓存控制的最大期限，以秒计，在 flask.Flask.send_static_file() (默认的静态文件处理器)中使用。对于单个文件分别在 Flask 或 Blueprint 上使用 get_send_file_max_age() 来覆盖这个值。默认为 43200（12小时）。</td>
</tr>
<tr>
<td>TRAP_HTTP_EXCEPTIONS</td>
<td>如果这个值被设置为 True ，Flask不会执行 HTTP 异常的错误处理，而是像对待其它异常一样， 通过异常栈让它冒泡地抛出。这对于需要找出 HTTP 异常源头的可怕调试情形是有用的。</td>
</tr>
<tr>
<td>TRAP_BAD_REQUEST_ERRORS</td>
<td>Werkzeug 处理请求中的特定数据的内部数据结构会抛出同样也是“错误的请求”异常的特殊的 key errors 。同样地，为了保持一致，许多操作可以显式地抛出 BadRequest 异常。因为在调试中，你希望准确地找出异常的原因，这个设置用于在这些情形下调试。如果这个值被设置为 True ，你只会得到常规的回溯。</td>
</tr>
<tr>
<td>PREFERRED_URL_SCHEME</td>
<td>生成URL的时候如果没有可用的 URL 模式话将使用这个值。默认为 http</td>
</tr>
<tr>
<td>JSON_AS_ASCII</td>
<td>默认情况下 Flask 使用 ascii 编码来序列化对象。如果这个值被设置为 False ， Flask不会将其编码为 ASCII，并且按原样输出，返回它的 unicode 字符串。比如 jsonfiy 会自动地采用 utf-8 来编码它然后才进行传输。</td>
</tr>
<tr>
<td>JSON_SORT_KEYS</td>
<td>默认情况下 Flask 按照 JSON 对象的键的顺序来序来序列化它。这样做是为了确保键的顺序不会受到字典的哈希种子的影响，从而返回的值每次都是一致的，不会造成无用的额外 HTTP 缓存。你可以通过修改这个配置的值来覆盖默认的操作。但这是不被推荐的做法因为这个默认的行为可能会给你在性能的代价上带来改善。</td>
</tr>
<tr>
<td>JSONIFY_PRETTYPRINT_REGULAR</td>
<td>如果这个配置项被 True （默认值）， 如果不是 XMLHttpRequest 请求的话（由 X-Requested-With 标头控制） json 字符串的返回值会被漂亮地打印出来。</td>
</tr>
</tbody>
</table>
<h2 id="62-flask的默认配置">6.2 Flask的默认配置</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#e6db74">&#39;ENV&#39;</span>:                                  None,
<span style="color:#e6db74">&#39;DEBUG&#39;</span>:                                None,
<span style="color:#e6db74">&#39;TESTING&#39;</span>:                              False,
<span style="color:#e6db74">&#39;PROPAGATE_EXCEPTIONS&#39;</span>:                 None,
<span style="color:#e6db74">&#39;PRESERVE_CONTEXT_ON_EXCEPTION&#39;</span>:        None,
<span style="color:#e6db74">&#39;SECRET_KEY&#39;</span>:                           None,
<span style="color:#e6db74">&#39;PERMANENT_SESSION_LIFETIME&#39;</span>:           timedelta(days<span style="color:#f92672">=</span><span style="color:#ae81ff">31</span>),
<span style="color:#e6db74">&#39;USE_X_SENDFILE&#39;</span>:                       False,
<span style="color:#e6db74">&#39;SERVER_NAME&#39;</span>:                          None,
<span style="color:#e6db74">&#39;APPLICATION_ROOT&#39;</span>:                     <span style="color:#e6db74">&#39;/&#39;</span>,
<span style="color:#e6db74">&#39;SESSION_COOKIE_NAME&#39;</span>:                  <span style="color:#e6db74">&#39;session&#39;</span>,
<span style="color:#e6db74">&#39;SESSION_COOKIE_DOMAIN&#39;</span>:                None,
<span style="color:#e6db74">&#39;SESSION_COOKIE_PATH&#39;</span>:                  None,
<span style="color:#e6db74">&#39;SESSION_COOKIE_HTTPONLY&#39;</span>:              True,
<span style="color:#e6db74">&#39;SESSION_COOKIE_SECURE&#39;</span>:                False,
<span style="color:#e6db74">&#39;SESSION_COOKIE_SAMESITE&#39;</span>:              None,
<span style="color:#e6db74">&#39;SESSION_REFRESH_EACH_REQUEST&#39;</span>:         True,
<span style="color:#e6db74">&#39;MAX_CONTENT_LENGTH&#39;</span>:                   None,
<span style="color:#e6db74">&#39;SEND_FILE_MAX_AGE_DEFAULT&#39;</span>:            timedelta(hours<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>),
<span style="color:#e6db74">&#39;TRAP_BAD_REQUEST_ERRORS&#39;</span>:              None,
<span style="color:#e6db74">&#39;TRAP_HTTP_EXCEPTIONS&#39;</span>:                 False,
<span style="color:#e6db74">&#39;EXPLAIN_TEMPLATE_LOADING&#39;</span>:             False,
<span style="color:#e6db74">&#39;PREFERRED_URL_SCHEME&#39;</span>:                 <span style="color:#e6db74">&#39;http&#39;</span>,
<span style="color:#e6db74">&#39;JSON_AS_ASCII&#39;</span>:                        True,
<span style="color:#e6db74">&#39;JSON_SORT_KEYS&#39;</span>:                       True,
<span style="color:#e6db74">&#39;JSONIFY_PRETTYPRINT_REGULAR&#39;</span>:          False,
<span style="color:#e6db74">&#39;JSONIFY_MIMETYPE&#39;</span>:                     <span style="color:#e6db74">&#39;application/json&#39;</span>,
<span style="color:#e6db74">&#39;TEMPLATES_AUTO_RELOAD&#39;</span>:                None,
<span style="color:#e6db74">&#39;MAX_COOKIE_SIZE&#39;</span>: <span style="color:#ae81ff">4093</span>,
</code></pre></div><h2 id="63-最佳实践">6.3 最佳实践</h2>
<p>一个有意思的模式是在配置中使用类和继承:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Config</span>(object):
    DEBUG <span style="color:#f92672">=</span> False
    SECRET_KEY <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;123&#39;</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ProdConfig</span>(Config):
    <span style="color:#66d9ef">pass</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestConfig</span>(Config):
    DEBUG <span style="color:#f92672">=</span> True

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DevConfig</span>(Config):
    DEBUG <span style="color:#f92672">=</span> True
</code></pre></div><p>针对不同的环境定义不同的配置文件，而在调用的时候就需要使用app.config.from_object了，比如(&lsquo;configmodule.ProductionConfig&rsquo;)，它接受字符串的格式的路径，来导入类的配置信息。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">app <span style="color:#f92672">=</span> Flask(__name__, template_folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;templates&#39;</span>, static_folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;static&#39;</span>)
app<span style="color:#f92672">.</span>secret_key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;adsasd23oy48932yqodqoidh&#39;</span>
app<span style="color:#f92672">.</span>config<span style="color:#f92672">.</span>from_object(<span style="color:#e6db74">&#39;settings.Config&#39;</span>)   <span style="color:#75715e"># 通过object来调用</span>
<span style="color:#66d9ef">print</span>(app<span style="color:#f92672">.</span>secret_key)  <span style="color:#75715e"># 覆盖前面的同名配置</span>
</code></pre></div><h2 id="64-动态加载的思想">6.4 动态加载的思想</h2>
<p>我们看到，在flask的配置方法中，我们指定的是一个字符串，而flask就就可以加载对应的类，读取对应的配置文件。这一点非常方便，想一想在如下场景下是否可以使用这种思想？</p>
<ol>
<li>监控平台的报警</li>
<li>监控平台的监控项</li>
</ol>
<p>普通来看的话，一般都会每个报警类型来定义一个函数，进行处理，也会为每一个监控项来定义一个收集处理的函数，如果运用这种动态的加载的思想，该怎么做？</p>
<p>下面是目录结构</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">flask
├─monitor
│  └─__init__.py
|  └─cpu.py
|  └─memory.py
├─notify
├─run.py 
└─settings.py
</code></pre></div><p>settings.py的文件如下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">monitors <span style="color:#f92672">=</span> [
    <span style="color:#e6db74">&#39;monitor.cpu.Cpu&#39;</span>,
    <span style="color:#e6db74">&#39;monitor.memory.Memory&#39;</span>
]
</code></pre></div><p>monitor模块的__init__.py文件如下：通过反射以及动态加载，来调用指定的字符串类的方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> importlib
<span style="color:#f92672">import</span> settings

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">host</span>():
    <span style="color:#66d9ef">if</span> isinstance(settings<span style="color:#f92672">.</span>monitors, list):
        <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> settings<span style="color:#f92672">.</span>monitors:
            module, detail <span style="color:#f92672">=</span> item<span style="color:#f92672">.</span>rsplit(<span style="color:#e6db74">&#39;.&#39;</span>, <span style="color:#ae81ff">1</span>)
            m <span style="color:#f92672">=</span> importlib<span style="color:#f92672">.</span>import_module(module)
            <span style="color:#66d9ef">if</span> hasattr(m, detail):
                cls <span style="color:#f92672">=</span> getattr(m, detail)
                cls()<span style="color:#f92672">.</span>check()
</code></pre></div><p>当我们使用run.py来执行的时候</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> monitor <span style="color:#f92672">import</span> host

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    host()
</code></pre></div><p>hosts方法，通过读取settings.py中，指定的监控内容来动态的加载并启动监控，这样做的好处时，如果需要添加其他健康项，那只需要编写对应的类并实现check方法，然后在配置文件中添加即可。非常便于扩展。</p>
<h1 id="7-路由系统">7 路由系统</h1>
<h2 id="71-路由系统的本质">7.1 路由系统的本质</h2>
<p>flask是怎么通过装饰器来完成路由的映射的呢，观察flask的原码，我们知道</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">route</span>(self, rule, <span style="color:#f92672">**</span>options):
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">decorator</span>(f):
        endpoint <span style="color:#f92672">=</span> options<span style="color:#f92672">.</span>pop(<span style="color:#e6db74">&#39;endpoint&#39;</span>, None)
        self<span style="color:#f92672">.</span>add_url_rule(rule, endpoint, f, <span style="color:#f92672">**</span>options)
        <span style="color:#66d9ef">return</span> f
    <span style="color:#66d9ef">return</span> decorator
</code></pre></div><p>实际上，在flask内部，它是通过<code>add_url_rule</code>来给app添加路由信息的，所以我们也可以不使用装饰器，直接使用add_url_rule来添加路由映射</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">logout</span>():
    <span style="color:#66d9ef">del</span> session[<span style="color:#e6db74">&#39;user&#39;</span>]
    <span style="color:#66d9ef">return</span> redirect(<span style="color:#e6db74">&#39;/login&#39;</span>)

app<span style="color:#f92672">.</span>add_url_rule(<span style="color:#e6db74">&#39;/logout&#39;</span>, None, logout)
</code></pre></div><h2 id="72-fbv和cbv">7.2 FBV和CBV</h2>
<p>我们之前写的都是FBV(function base view)，当然flask和django一样，也支持CBV的方式</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, views

app <span style="color:#f92672">=</span> Flask(__name__, template_folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;templates&#39;</span>, static_folder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;static&#39;</span>)

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestView</span>(views<span style="color:#f92672">.</span>MethodView):   <span style="color:#75715e"># 最好从views.MethodView继承。</span>
    methods <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;get&#39;</span>, <span style="color:#e6db74">&#39;post&#39;</span>]

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;get 请求&#39;</span>)
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;get hello world&#39;</span>

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">post</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;post 请求&#39;</span>)
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;Post hello world&#39;</span>

app<span style="color:#f92672">.</span>add_url_rule(<span style="color:#e6db74">&#39;/test&#39;</span>, view_func<span style="color:#f92672">=</span>TestView<span style="color:#f92672">.</span>as_view(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;test&#39;</span>))  <span style="color:#75715e"># 这里的name，和endpoint 是一样的效果</span>

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    app<span style="color:#f92672">.</span>run()
</code></pre></div><p>views.MethodView使用dispath方法，通过反射可以让我们更直观的定义get/post方法，如果从views.View来继承，那么我们只能使用<code>dispatch_request</code>方法来接受处理请求</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NewView</span>(views<span style="color:#f92672">.</span>View):
    methods <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;get&#39;</span>,<span style="color:#e6db74">&#39;post&#39;</span>]

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dispatch_request</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;请求进来了&#39;</span>)
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;ok&#39;</span>

app<span style="color:#f92672">.</span>add_url_rule(<span style="color:#e6db74">&#39;/new&#39;</span>, view_func<span style="color:#f92672">=</span>NewView<span style="color:#f92672">.</span>as_view(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;new&#39;</span>))
</code></pre></div><p>如果要使用装饰器添加认证，那么就需要使用<code>decorators属性</code>来指定了，比如前面的auth认证</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NewView</span>(views<span style="color:#f92672">.</span>View):
    methods <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;get&#39;</span>,<span style="color:#e6db74">&#39;post&#39;</span>]
    decorators <span style="color:#f92672">=</span> [auth,]

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dispatch_request</span>(self):
        <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;请求进来了&#39;</span>)
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;ok&#39;</span>

app<span style="color:#f92672">.</span>add_url_rule(<span style="color:#e6db74">&#39;/new&#39;</span>, view_func<span style="color:#f92672">=</span>NewView<span style="color:#f92672">.</span>as_view(name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;new&#39;</span>))
</code></pre></div><blockquote>
<p>CBV比较适合restful风格的API接口编写，因为可以根据不同的请求类型，来访问不同的函数，不用像FBV那样，需要额外判断request.method的类型，来做出相应的逻辑</p>
</blockquote>
<h1 id="8-flask中的beforeafter">8 flask中的before/after</h1>
<p>flask中提供了，两个装饰器用于对进来的请求和返回的请求进行统一处理，和django中的中间件是一个含义。</p>
<ol>
<li>在每次请求之前， before_request()函数都会被调用。如果其中一个函数返回了一个值，则其他函数将被跳过。返回值被视为响应，并且视图 函数不会被调用。</li>
<li>如果 before_request() 函数没有返回响应，则调用匹配路由的 视图函数并返回响应。</li>
<li>视图的返回值被转换为实际的响应对象并传递给 after_request()函数。每个函数都返回一个修改过的或新的响应对象。</li>
<li>返回响应后，将弹出情境，该情境调用 teardown_request() 和 teardown_appcontext()函数。即使在上面任何一处引发了未处 理的异常，也会调用这些函数。</li>
</ol>
<p><img src="../photo/before_after.png" alt="before_after"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>

app <span style="color:#f92672">=</span> Flask(__name__)


<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/index&#39;</span>)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">index</span>():
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;index&#39;</span>


<span style="color:#a6e22e">@app.before_request</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">before</span>():
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;Gun&#39;</span>


<span style="color:#a6e22e">@app.after_request</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">after</span>(response):
    <span style="color:#66d9ef">return</span> Response(<span style="color:#e6db74">&#39;maliude&#39;</span>)


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    app<span style="color:#f92672">.</span>run()
</code></pre></div><p>上面代码：</p>
<ul>
<li>先经过before，由于return了非None，则进入after阶段</li>
<li>after又改写了response，所以最后会显示&rsquo;maliude'</li>
</ul>
<p>当然before和after都可以有多个，他们的顺序如下：
<img src="../photo/bef_aft_more.png" alt="bef_aft_more"></p>
<p>需要注意的是：</p>
<ul>
<li>before_request和after_request都可以有多个，按照定义的先后顺序的。</li>
<li>before_request_funcs是一个列表存放所有的before_request函数</li>
<li>after_request_funcs是一个列表存放所有的after_request的列表(内部使用了reverse进行反转)</li>
<li>当任意一个before_request返回了非None，那么将会从最后一个after_request函数开始执行</li>
</ul>
<h1 id="9-请求和响应相关">9 请求和响应相关</h1>
<p>下面是部分请求的方法</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>request.method</td>
<td>请求的方法</td>
</tr>
<tr>
<td>request.args</td>
<td>get请求传递的参数</td>
</tr>
<tr>
<td>request.form</td>
<td>post请求传递的参数</td>
</tr>
<tr>
<td>request.values</td>
<td>包含get/post请求传递的参数</td>
</tr>
<tr>
<td>request.cookies</td>
<td>cookies信息</td>
</tr>
<tr>
<td>request.headers</td>
<td>http Header请求头信息</td>
</tr>
<tr>
<td>request.path</td>
<td>HTTP path信息</td>
</tr>
<tr>
<td>request.full_path</td>
<td>包含查询字符串的path信息</td>
</tr>
<tr>
<td>request.script_root</td>
<td></td>
</tr>
<tr>
<td>request.url</td>
<td>完成的请求的url，包含查询字符串</td>
</tr>
<tr>
<td>request.base_url</td>
<td>完成的请求的url</td>
</tr>
<tr>
<td>request.url_root</td>
<td>不包含二级目录的URL，主机URL</td>
</tr>
<tr>
<td>request.host_url</td>
<td>不包含二级目录的URL，主机URL</td>
</tr>
<tr>
<td>request.host</td>
<td>host:port</td>
</tr>
<tr>
<td>request.files</td>
<td>上传的文件</td>
</tr>
</tbody>
</table>
<p>下面是部分响应的方式</p>
<table>
<thead>
<tr>
<th>方式</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>return &ldquo;字符串&rdquo;</td>
<td>返回一个字符串</td>
</tr>
<tr>
<td>return render_template(&lsquo;html模板路径&rsquo;,**{})</td>
<td>返回渲染后的HTML文本信息</td>
</tr>
<tr>
<td>return redirect('/index.html')</td>
<td>跳转</td>
</tr>
</tbody>
</table>
<h2 id="91-上传及保存文件">9.1 上传及保存文件</h2>
<p>上传文件需要用到request.files属性，它里面保存了所有上传的文件对象。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/upload&#39;</span>,methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;get&#39;</span>,<span style="color:#e6db74">&#39;post&#39;</span>])
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upload</span>():
    <span style="color:#66d9ef">print</span>(request<span style="color:#f92672">.</span>files)  <span style="color:#75715e"># ImmutableMultiDict([(&#39;upload_file&#39;, &lt;FileStorage: &#39;footer.png&#39; (&#39;image/png&#39;)&gt;)])</span>
    file_obj <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>files[<span style="color:#e6db74">&#39;upload_file&#39;</span>]
    <span style="color:#66d9ef">print</span>(type(file_obj))  <span style="color:#75715e"># &lt;class &#39;werkzeug.datastructures.FileStorage&#39;&gt;</span>
    file_obj<span style="color:#f92672">.</span>save(file_obj<span style="color:#f92672">.</span>filename)  <span style="color:#75715e"># 保存文件</span>
</code></pre></div><p>注意：
html中，使用form上传文件时，那么需要设置form的<code>enctype=&quot;multipart/form-data&quot;</code>
下面是一个完整的例子：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> os
<span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Flask, flash, request, redirect
<span style="color:#f92672">from</span> werkzeug.utils <span style="color:#f92672">import</span> secure_filename

UPLOAD_FOLDER <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;E:\Python - base - code\chapter16flask\imgs&#39;</span>
ALLOWED_EXTENSIONS <span style="color:#f92672">=</span> set([<span style="color:#e6db74">&#39;txt&#39;</span>, <span style="color:#e6db74">&#39;pdf&#39;</span>, <span style="color:#e6db74">&#39;png&#39;</span>, <span style="color:#e6db74">&#39;jpg&#39;</span>, <span style="color:#e6db74">&#39;jpeg&#39;</span>, <span style="color:#e6db74">&#39;gif&#39;</span>])

app <span style="color:#f92672">=</span> Flask(__name__, static_folder<span style="color:#f92672">=</span>UPLOAD_FOLDER, static_url_path<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/imgs&#39;</span>)
app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;UPLOAD_FOLDER&#39;</span>] <span style="color:#f92672">=</span> UPLOAD_FOLDER   <span style="color:#75715e"># 配置上传文件的路径</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">allowed_file</span>(filename):  <span style="color:#75715e"># 用于限制上传的文件的类型</span>
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;.&#39;</span> <span style="color:#f92672">in</span> filename <span style="color:#f92672">and</span> \
           filename<span style="color:#f92672">.</span>rsplit(<span style="color:#e6db74">&#39;.&#39;</span>, <span style="color:#ae81ff">1</span>)[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>lower() <span style="color:#f92672">in</span> ALLOWED_EXTENSIONS

<span style="color:#a6e22e">@app.route</span>(<span style="color:#e6db74">&#39;/&#39;</span>, methods<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;GET&#39;</span>, <span style="color:#e6db74">&#39;POST&#39;</span>])
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">upload_file</span>():
    <span style="color:#66d9ef">if</span> request<span style="color:#f92672">.</span>method <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;POST&#39;</span>:

        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;file&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> request<span style="color:#f92672">.</span>files:
            flash(<span style="color:#e6db74">&#39;No file part&#39;</span>)
            <span style="color:#66d9ef">return</span> redirect(request<span style="color:#f92672">.</span>url)
        file <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span>files[<span style="color:#e6db74">&#39;file&#39;</span>]
        <span style="color:#66d9ef">if</span> file<span style="color:#f92672">.</span>filename <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&#39;</span>:
            flash(<span style="color:#e6db74">&#39;No selected file&#39;</span>)
            <span style="color:#66d9ef">return</span> redirect(request<span style="color:#f92672">.</span>url)
        <span style="color:#66d9ef">if</span> file <span style="color:#f92672">and</span> allowed_file(file<span style="color:#f92672">.</span>filename):
            filename <span style="color:#f92672">=</span> secure_filename(file<span style="color:#f92672">.</span>filename)
            file<span style="color:#f92672">.</span>save(os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(app<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;UPLOAD_FOLDER&#39;</span>], filename)) 　<span style="color:#75715e"># 保存文件</span>
            <span style="color:#66d9ef">return</span> redirect(<span style="color:#e6db74">&#39;/imgs/{}&#39;</span><span style="color:#f92672">.</span>format(filename))
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;&#39;&#39;
</span><span style="color:#e6db74">    &lt;!doctype html&gt;
</span><span style="color:#e6db74">    &lt;title&gt;Upload new File&lt;/title&gt;
</span><span style="color:#e6db74">    &lt;h1&gt;Upload new File&lt;/h1&gt;
</span><span style="color:#e6db74">    &lt;form method=post enctype=multipart/form-data&gt;
</span><span style="color:#e6db74">      &lt;input type=file name=file&gt;
</span><span style="color:#e6db74">      &lt;input type=submit value=Upload&gt;
</span><span style="color:#e6db74">    &lt;/form&gt;
</span><span style="color:#e6db74">    &lt;img src=/imgs/head.jpg alt=meinv&gt; &lt;/img&gt;
</span><span style="color:#e6db74">    &#39;&#39;&#39;</span>

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;__main__&#39;</span>:
    app<span style="color:#f92672">.</span>run()
</code></pre></div><p><code>secure_filename</code>用于对上传的文件名进行安全检查，否则如果用户上传的文件名'../../../usr_host/.bashrc'，那么用户的信息有可能就会被窃取。</p>
<h2 id="92-构建响应头">9.2 构建响应头</h2>
<p>通过make_response来构建一个响应对象，我们可以给他添加一些定制化的信息。一般使用流程是</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> make_response
<span style="color:#f92672">...</span> <span style="color:#f92672">...</span>

response <span style="color:#f92672">=</span> make_response(render_template(<span style="color:#e6db74">&#39;index.html&#39;</span>))  <span style="color:#75715e"># response是flask.wrappers.Response类型</span>
response<span style="color:#f92672">.</span>delete_cookie(<span style="color:#e6db74">&#39;key&#39;</span>)                <span style="color:#75715e"># 操作1：删除cookie</span>
response<span style="color:#f92672">.</span>set_cookie(<span style="color:#e6db74">&#39;key&#39;</span>, <span style="color:#e6db74">&#39;value&#39;</span>)          <span style="color:#75715e"># 操作2：设置cookie</span>
response<span style="color:#f92672">.</span>headers[<span style="color:#e6db74">&#39;X-Something&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;A value&#39;</span>  <span style="color:#75715e"># 操作3：定制headers ... ...</span>
<span style="color:#66d9ef">return</span> response
</code></pre></div><p>make_response可以包装，如下对象（基本上包含所有可以直接返回的信息）</p>
<ul>
<li>字符串</li>
<li>redirect对象</li>
<li>render_template</li>
</ul>
<h1 id="10-模板使用">10 模板使用</h1>
<p>flask内部使用jinja2作为模板渲染组件，默认会安装，否则</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">pip install jinja2
</code></pre></div><p>基本用法和django模板基本相同。但是比django要方便很多，更趋向于python代码的风格。比如</p>
<ul>
<li>字典的键值对，使用:items()，而django不需要添加括号</li>
<li>字典可以通过[&lsquo;key&rsquo;]和.来访问，django只能使用.访问</li>
<li>可以使用get(&lsquo;key&rsquo;,None),django不可以</li>
</ul>
<p>同样支持模板的方式，和django的使用方式相同，这里不在说明。不同的是，jinja2还支持函数的方式渲染.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">func</span>(value):
	<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&lt;input type=&#39;text&#39; value={}&gt;&#34;</span><span style="color:#f92672">.</span>format(value)

<span style="color:#960050;background-color:#1e0010">模板页面中：</span>
{{ func(<span style="color:#e6db74">&#39;123&#39;</span>) }}
</code></pre></div><p>但是为了防止xss攻击，这种代码是不会直接显示的，要想显示，可以使用
safe</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-jinja" data-lang="jinja"><span style="color:#75715e">{{</span> func<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;123&#39;</span><span style="color:#f92672">)|</span><span style="color:#a6e22e">safe</span> <span style="color:#75715e">}}</span>
</code></pre></div><p>当然也可以在后端进行设置，可以使用Makeup</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> flask <span style="color:#f92672">import</span> Markup

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">func</span>(value):
	<span style="color:#66d9ef">return</span> Markup(<span style="color:#e6db74">&#34;&lt;input type=&#39;text&#39; value={}&gt;&#34;</span><span style="color:#f92672">.</span>format(value))

<span style="color:#960050;background-color:#1e0010">模板页面中：</span>
{{ func(<span style="color:#e6db74">&#39;123&#39;</span>) }}
</code></pre></div><h2 id="101-template_global和template_filter">10.1 template_global和template_filter</h2>
<p>这两个装饰器用于在模板中构建函数或过滤器，用法和django的filter函数和simple_tag相同，不同的是，可以直接全局使用，而无需提前加载。</p>
<ul>
<li>template_filter装饰器装饰的函数对应django中的filter</li>
<li>template_global装饰器装饰的函数对应django中的simple_tag</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a6e22e">@app.template_filter</span>()
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">user_upper</span>(a):
    <span style="color:#66d9ef">return</span> a<span style="color:#f92672">.</span>upper()

<span style="color:#a6e22e">@app.template_global</span>()
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">sum</span>(a, b):
    <span style="color:#66d9ef">return</span> a <span style="color:#f92672">+</span> b

<span style="color:#75715e"># 调用方式(渲染)</span>
 {{ sum(<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">20</span>) }} <span style="color:#f92672">-</span> {{ <span style="color:#e6db74">&#39;hello world&#39;</span><span style="color:#f92672">|</span>user_upper }}
</code></pre></div><p>{% endraw %}</p>

</div>


  <footer class="container">
  <div class="container navigation no-print">
  <h2>Navigation</h2>
  
  

    
    <a class="prev" href="https://dachenzi.github.io/1/01/01/1-javascript%E4%BB%8B%E7%BB%8D%E5%8F%8A%E4%BD%BF%E7%94%A8/" title="1-JavaScript介绍及使用">
      Previous
    </a>
    

    
    <a class="next" href="https://dachenzi.github.io/1/01/01/1-docker%E5%85%A5%E9%97%A8%E4%BB%8B%E7%BB%8D/" title="1-docker入门介绍">
      Next
    </a>
    

  


</div>

  
<div class="container comments">
  <h2>Comments</h2>
  
<div id="disqus_thread"></div>
<script type="text/javascript">
  (function() {
    
    
    if (window.location.hostname == "localhost")
      return;

    var dsq = document.createElement('script'); dsq.async = true; dsq.type = 'text/javascript';
    dsq.src = '//your_disqus_shortname.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


</div>


</footer>

</article>
      <footer id="main-footer" class="container main_footer">
  

  <div class="container nav foot no-print">
  
<a href="https://dachenzi.github.io/license">license</a>


  <a class="toplink" href="#">back to top</a>

</div>

  <div class="container credits">
  
<div class="container footline">
  
  code with <!-- raw HTML omitted --><!-- raw HTML omitted -->


</div>


  
<div class="container copyright">
  
  (c) 2015 Lee xin.


</div>


</div>

</footer>

    </main>
    
<script type="text/javascript">
  (function() {
    
    
    if (window.location.hostname == "localhost")
      return;
    var dsq = document.createElement('script'); dsq.async = true; dsq.type = 'text/javascript';
    dsq.src = '//your_disqus_shortname.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>



<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



    
  </body>
</html>

